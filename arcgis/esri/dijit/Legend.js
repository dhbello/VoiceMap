//>>built
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleLineSymbol ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),
function(I,U,q,k,p,ia,x,V,y,ja,W,X,Q,r,g,t,ka,Y,R,Z,u,$,S,O,F,A,J,G,K,H,aa,ba,ca,P,da,ea,fa,L,ga,ha,T){var C=U([ha,Y],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new x([64,64,64]),defaultText:"Aa",sizeRampLightColor:new x([255,255,255]),sizeRampDarkColor:new x([128,128,128]),layerConnects:[],gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",
gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,constructor:function(a,b){q.mixin(this,T.widgets.legend);this._i18n=T.widgets.legend;a=a||{};a.map?b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this.arrangement=a.arrangement===C.ALIGN_RIGHT?C.ALIGN_RIGHT:C.ALIGN_LEFT,this.arrangement===C.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?
!1:!0,this._surfaceItems=[],this.hideLayersInLegend={},this.refresh=V(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b,c;for(b=0;b<a.length;b+=1)c=a[b],I.locale&&-1!==I.locale.indexOf(c)&&(-1!==I.locale.indexOf("-")?-1!==I.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);
this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},startup:function(){this.inherited(arguments);this._initialize();9>y("ie")&&(this._repaintItems=q.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeHoverHandlers();this.inherited(arguments)},
refresh:function(a){if(this.domNode){a?(this.layerInfos=a,this.layers=[],k.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},
this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(a=this.domNode.children.length-1;0<=a;a--)g.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],k.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=
a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],b=[];k.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);var e;this._isSupportedLayerType(c)&&(c.arcgisProps&&c.arcgisProps.title&&(c._titleForLegend=c.arcgisProps.title),this.layers.push(c));
"esri.layers.KMLLayer"==c.declaredClass&&(e=c.getLayers(),k.forEach(e,function(b){a.push(b.id)},this));"esri.layers.GeoRSSLayer"==c.declaredClass&&(e=c.getFeatureLayers(),k.forEach(e,function(a){b.push(a.id)},this))},this);k.forEach(this.map.graphicsLayerIds,function(c){var e=this.map.getLayer(c);-1==k.indexOf(a,c)&&-1==k.indexOf(b,c)&&(this._isSupportedLayerType(e)&&e._params&&e._params.drawMode)&&(e.arcgisProps&&e.arcgisProps.title&&(e._titleForLegend=e.arcgisProps.title),this.layers.push(e))},
this)}this._createLegend()},_activate:function(){this._deactivate();this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=p.connect(this.map,"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=p.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers"),this._olrConnect=p.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=p.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),k.forEach(this.layers,function(a){var b={};b.ovcConnect=
p.connect(a,"onVisibilityChange",this,"_refreshLayers");b.oocConnect=p.connect(a,"onOpacityChange",this,"_refreshLayers");b.oscConnect=p.connect(a,"onScaleRangeChange",this,"_refreshLayers");"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&(b.odcConnect=p.connect(a,"_onDynamicLayersChange",q.hitch(this,"_updateDynamicLayers",a)));"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&(b.oirConnect=p.connect(a,"onRenderingChange",q.partial(this._updateImageServiceLayers,
this,a)));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(b.oivrConnect=p.connect(a,"onRendererChange",q.hitch(this,"_refreshLayers")));this.layerConnects[a.id]=b},this))},_deactivate:function(){this._ozeConnect&&p.disconnect(this._ozeConnect);this._olaConnect&&p.disconnect(this._olaConnect);this._olroConnect&&p.disconnect(this._olroConnect);this._olrConnect&&p.disconnect(this._olrConnect);k.forEach(this.layers,function(a){a=this.layerConnects[a.id]||{};a.ovcConnect&&p.disconnect(a.ovcConnect);
a.oocConnect&&p.disconnect(a.oocConnect);a.oscConnect&&p.disconnect(a.oscConnect);a.odcConnect&&p.disconnect(a.odcConnect);a.oirConnect&&p.disconnect(a.oirConnect);a.oivrConnect&&p.disconnect(a.oivrConnect)},this);this.layerConnects=[]},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];k.forEach(this.map.layerIds,
function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this.layers.push(a)},this);k.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&(a._params&&a._params.drawMode)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1,b=!1;t.set(this.domNode,"position","relative");g.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var c=[];k.forEach(this.layers,function(d){if("esri.layers.KMLLayer"==
d.declaredClass||"esri.layers.GeoRSSLayer"==d.declaredClass){var e;d.loaded?("esri.layers.KMLLayer"==d.declaredClass?e=d.getLayers():"esri.layers.GeoRSSLayer"==d.declaredClass&&(e=d.getFeatureLayers(),this.hideLayersInLegend[d.id]&&(e=k.filter(e,function(a){return-1==k.indexOf(this.hideLayersInLegend[d.id],a.id)},this))),k.forEach(e,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&d._titleForLegend&&(a._titleForLegend=d._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=
this.NLS_points:"esriGeometryPolyline"==a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_polygons),c.push(a))},this)):p.connect(d,"onLoad",q.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===d.declaredClass)if(d.loaded){if((!this._respectVisibility||this._respectVisibility&&d.visible)&&0<d.layerInfos.length&&k.some(d.layerInfos,function(a){return a.legendURL})){var l=!1;k.forEach(d.layerInfos,
function(b){if(b.legendURL&&-1<k.indexOf(d.visibleLayers,b.name)){l||(g.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(d._titleForLegend||d.name||d.id)+"\x3c/span\x3e"},this.domNode),l=!0);var c;b=b.legendURL;if(d.customParameters||d.customLayerParameters){var e=q.clone(d.customParameters||{});q.mixin(e,d.customLayerParameters||{});for(c in e)b+=(-1===b.indexOf("?")?"?":"\x26")+c+"\x3d"+e[c]}g.create("div",{innerHTML:"\x3cimg src\x3d'"+b+"'/\x3e"},this.domNode);a=!0}},this)}}else p.connect(d,
"onLoad",q.hitch(this,function(){this.refresh(this.layerInfos)}));else"esri.layers.WFSLayer"===d.declaredClass&&!d.renderer?(e=g.create("div",{id:this.id+"_"+d.id,"class":"esriLegendService"}),g.create("span",{innerHTML:this._getServiceTitle(d),"class":"esriLegendServiceLabel"},g.create("td",{align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},e))))),g.place(e,this.id,"first"),tableNode=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
e),tableBody=g.create("tbody",{},tableNode),"esriGeometryComplex"===d.geometryType?(this._buildRow_Renderer(d,d._pointSymbol,null,this.NLS_points,null,tableBody),this._buildRow_Renderer(d,d._lineSymbol,null,this.NLS_lines,null,tableBody),this._buildRow_Renderer(d,d._polygonSymbol,null,this.NLS_areas,null,tableBody)):"esriGeometryPoint"===d.geometryType?this._buildRow_Renderer(d,d._pointSymbol,null,"",null,tableBody):"esriGeometryPolyline"===d.geometryType?this._buildRow_Renderer(d,d._lineSymbol,null,
"",null,tableBody):"esriGeometryPolygon"===d.geometryType&&this._buildRow_Renderer(d,d._polygonSymbol,null,"",null,tableBody),b=!0):c.push(d)},this);var e=[];k.forEach(c,function(a){if(a.loaded){if((!this._respectVisibility||this._respectVisibility&&a.visible)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass)){var b=g.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});g.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},
g.create("td",{align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},b)))));g.place(b,this.id,"first");a.legendResponse||a.renderer?this._createLegendForLayer(a):this.isHostedTileService(a)?this._getLayerInfos(a).then(q.hitch(this,function(a){this._createLegendForLayer(a)}),q.hitch(this,function(a){e.push(this._legendRequest(a))})):e.push(this._legendRequest(a))}}else var c=p.connect(a,"onLoad",this,function(a){p.disconnect(c);c=null;this.refresh()})},this);0===e.length&&
!a&&!b?(r.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate()):(new X(e)).addCallback(q.hitch(this,function(c){!a&&!b?r.byId(this.id+"_msg").innerHTML=this.NLS_noLegend:r.byId(this.id+"_msg").innerHTML="";this._activate()}))},_createLegendForLayer:function(a){if(a.legendResponse||a.renderer||this.isHostedTileService(a)){var b=!1;if(a.legendResponse||this.isHostedTileService(a)){var c=a.dynamicLayerInfos||a.layerInfos;c&&c.length?k.forEach(c,function(c,d){if(!this.hideLayersInLegend[a.id]||
-1===k.indexOf(this.hideLayersInLegend[a.id],c.id)){var f=this._buildLegendItems(a,c,d);b=b||f}},this):"esri.layers.ArcGISImageServiceLayer"==a.declaredClass&&(b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0))}else a.renderer&&(c=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,{id:c,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(t.set(r.byId(this.id+"_"+a.id),"display","block"),t.set(r.byId(this.id+
"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a);p.connect(a,"onLoad",q.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var b=a.url,c=b.indexOf("?"),b=-1<c?b.substring(0,c)+"/legend"+b.substring(c):b+"/legend";(c=a._getToken())&&(b+="?token\x3d"+c);var e=q.hitch(this,"_processLegendResponse"),d={f:"json"};a._params.dynamicLayers&&(d.dynamicLayers=Q.stringify(this._createDynamicLayers(a)),
"[{}]"===d.dynamicLayers&&(d.dynamicLayers="[]"));a._params.bandIds&&(d.bandIds=a._params.bandIds);a._params.renderingRule?d.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&k.forEach(a.rasterFunctionInfos,function(a){a&&(a.name&&"none"===a.name.toLowerCase())&&(d.renderingRule=Q.stringify({rasterFunction:a.name}))});return O({url:b,content:d,callbackParamName:"callback",load:function(b,c){e(a,b,c)},error:S.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=
a.url.toLowerCase().indexOf("/rest/"),b=a.url.substring(0,b)+a.url.substring(b+5,a.url.length),b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!y("ie")||8<y("ie"))b+="\x26returnbytes\x3dtrue";var c=q.hitch(this,"_processLegendResponse");return O({url:b,content:{f:"json"},callbackParamName:"callback",load:function(b,d){c(a,b,d)},error:S.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers&&(a.legendResponse=b,r.byId(this.id+"_"+a.id)&&g.empty(r.byId(this.id+"_"+a.id)),
g.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},g.create("td",{align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},r.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a))},_buildLegendItems:function(a,b,c){var e=!1,d=r.byId(this.id+"_"+a.id),f=b.parentLayerId;if(b.subLayerIds)a=g.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==f?0<c?"esriLegendGroupLayer":"":this._legendAlign},-1==
f?d:r.byId(this.id+"_"+a.id+"_"+f+"_group")),g.create("td",{innerHTML:u.encode(b.name),align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(this._respectVisibility&&a.visibleLayers)if(c=a.dynamicLayerInfos||a.layerInfos)if(a._params&&a._params.layers){if(-1===k.indexOf(a.visibleLayers,b.id))return e}else{if(c=this._getReallyVisibleLayers(c,a.visibleLayers),-1===k.indexOf(c,b.id))return e}else if(-1===k.indexOf(a.visibleLayers,
b.id))return e;d=g.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<f?this._legendAlign:""},-1==f?d:r.byId(this.id+"_"+a.id+"_"+f+"_group"));g.create("td",{innerHTML:u.encode(b.name)||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%","class":"esriLegendLayerLabel"},d))));c=a.dynamicLayerInfos||a.layerInfos;f=!1;c&&c.length&&(f=k.some(c,function(a){return!!a.drawingInfo}));if(a.legendResponse)e=e||this._buildLegendItems_Tools(a,b,d);
else if(a.renderer||f)e=e||this._buildLegendItems_Renderer(a,b,d)}return e},_getReallyVisibleLayers:function(a,b){if(!a||!b||!b.length)return[];var c=[],e=[],d;for(d=0;d<a.length;d++)if(a[d].subLayerIds){if(-1===k.indexOf(b,a[d].id)||-1<k.indexOf(e,a[d].id))e=e.concat(a[d].subLayerIds)}else-1<k.indexOf(b,a[d].id)&&-1===k.indexOf(e,a[d].id)&&c.push(a[d].id);return c},_buildLegendItems_Tools:function(a,b,c){var e=b.parentLayerId,d=this.map.getScale(),f=!1,l=function(a,b){var c,d;for(c=0;c<a.length;c++)if(b.dynamicLayerInfos)for(d=
0;d<b.dynamicLayerInfos[d].length;d++){if(b.dynamicLayerInfos[d].mapLayerId==a[c].layerId)return a[c]}else if(b.id==a[c].layerId)return a[c];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,b,d)){var s=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var m=this._getEffectiveScale(a,b);if(m.minScale&&m.minScale<d||m.maxScale&&m.maxScale>d)s=!1}if(s){var d=
l(a.legendResponse.layers,b),n=d.legendType,h=d.layerType,z=d.legend;if(z){"esri.layers.ArcGISImageServiceLayer"!==a.declaredClass&&this._sanitizeLegendResponse(a,d,b);c=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var w=g.create("tbody",{},c);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(c,a,b);k.forEach(z,function(c){if(!(10.1<=a.version&&!c.values&&1<z.length&&(a._hideDefaultSymbol||"\x3call other values\x3e"===c.label||!c.label&&!("esri.layers.ArcGISImageServiceLayer"===
a.declaredClass&&10.3<=a.version||"Raster Layer"===h))))if(c.url&&0===c.url.indexOf("http")||c.imageData&&0<c.imageData.length)f=!0,this._buildRow_Tools(c,w,a,b.id,n)},this)}}}f&&(t.set(r.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<e&&(t.set(r.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,a,e)));return f},_getLayerInfos:function(a){var b=new W,c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)if(k.some(c,function(a){return!!a.drawingInfo}))b.resolve(a);
else{var e=a.url,d=e.indexOf("?"),e=-1==d?e+"/layers":e.substring(0,d)+"/layers"+e.substring(d,e.length);O({url:e,content:{f:"json"},callbackParamName:"callback",load:function(d,e){d.layers?(k.forEach(c,function(a){var b=k.filter(d.layers,function(b){return a.source?b.id===a.source.mapLayerId:b.id===a.id});b&&(b[0]&&b[0].drawingInfo)&&(a.drawingInfo=b[0].drawingInfo,a.fields=b[0].fields)}),b.resolve(a)):b.reject(a)},error:function(c){b.reject(a)}})}return b},_sanitizeLegendResponse:function(a,b,c){var e=
b.legend;if(10.1<=a.version&&1<e.length&&!b._sanitized){a=q.getObject("layerDefinition.drawingInfo.renderer",!1,c);var d,f;a||(a=q.getObject("drawingInfo.renderer",!1,c));k.some(e,function(a){if(a.values)return!0})&&k.some(e,function(a,b){a.values||(f=b,d=a);return!!d});a?"uniqueValue"===a.type?d&&(e.splice(f,1),e.push(d)):"classBreaks"===a.type&&(d&&e.splice(f,1),e.reverse(),d&&e.push(d)):d&&(e.splice(f,1),e.push(d));b._sanitized=!0}},_buildRow_Tools:function(a,b,c,e,d){var f=g.create("tr",{},b),
l;this.alignRight?(b=g.create("td",{align:this._isRightToLeft?"left":"right"},f),l=g.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)):(l=g.create("td",{width:35,align:"center"},f),b=g.create("td",{},f));f=a.url;(!y("ie")||9<=y("ie")||9>y("ie")&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&a.imageData&&0<a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=c.url+"/"+e+"/images/"+a.url,(e=c._getToken())&&(f+="?token\x3d"+e));e=g.create("img",
{src:f,border:0,style:"opacity:"+c.opacity},l);a=g.create("td",{innerHTML:u.encode(a.label),align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%",dir:"ltr"},b))));d&&("Stretched"===d&&10.3<=c.version&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&(a.style.verticalAlign="top",a.style.lineHeight="1",e.style.marginBottom="-1px",e.style.display="block",b.style.verticalAlign="top");9>y("ie")&&(e.style.filter="alpha(opacity\x3d"+100*c.opacity+")")},_getVariable:function(a,
b,c){var e;a&&(e=(a=a.getVisualVariablesForType(b,c))&&a[0]);return e},_getVariables:function(a,b,c){a=[this._getVariable(a,"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",!1)];return b?k.filter(a,function(a){return!(!a||!(a.field===b&&a.normalizationField==c))}):a},_getFieldAlias:function(a,b,c){var e=b.infoTemplate,e=e&&e.getFieldInfo&&e.getFieldInfo(a);a=q.isFunction(a)?null:this.getField(b,a,c);b=e||a;c="";b&&(c=e&&e.label||a&&a.alias||b.name||b.fieldName);
return c},_getRampTitle:function(a,b,c){var e,d=a.field,f=a.normalizationField,l=!1,g=!1,m=!1,d=q.isFunction(d)?null:d,f=q.isFunction(f)?null:f;if(a.legendOptions&&a.legendOptions.title)e=a.legendOptions.title;else if(a.valueExpressionTitle)e=a.valueExpressionTitle;else{if(b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables){var n=b.renderer.authoringInfo.visualVariables;for(a=0;a<n.length;a++){var h=n[a];if("colorInfo"===h.type&&"ratio"===h.style){l=!0;break}else if("colorInfo"===
h.type&&"percent"===h.style){g=!0;break}else if("colorInfo"===h.type&&"percentTotal"===h.style){m=!0;break}}}(l=m&&"showRatioPercentTotal"||g&&"showRatioPercent"||l&&"showRatio"||f&&"showNormField"||d&&"showField"||null)&&(e=F.substitute({field:d&&this._getFieldAlias(d,b,c),normField:f&&this._getFieldAlias(f,b,c)},this._i18n[l]))}return e},_getRendererTitle:function(a,b,c){var e;if(a){var d,f,l;a instanceof H&&(d=a.attributeField,f=a.normalizationField,l="percent-of-total"===a.normalizationType);
d=q.isFunction(d)?null:d;f=q.isFunction(f)?null:f;a.legendOptions&&a.legendOptions.title?e=a.legendOptions.title:a.valueExpressionTitle?e=a.valueExpressionTitle:(a=f&&"showNormField"||(l?"showNormPct":null)||d&&"showField"||null)&&(e=F.substitute({field:d&&this._getFieldAlias(d,b,c),normField:f&&this._getFieldAlias(f,b,c)},this._i18n[a]))}return e},_buildLegendItems_Renderer:function(a,b,c){var e=b.parentLayerId,d=this.map,f=d.getScale(),l,s=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,
b,f)){var m,n,h,z,w,p,E,M;h="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:b&&b.drawingInfo?ga.fromJson(q.clone(b.drawingInfo.renderer)):a.renderer;if(h instanceof aa&&(h=(h="zoom"===h.rangeType?h.getRendererInfoByZoom(d.getZoom()):h.getRendererInfoByScale(f))&&h.renderer,!h))return!1;var v=this._getVariables(h),D=k.filter(v,function(a){return!!a}).length,f=v[0],d=v[1],v=v[2],y,N,B,x,A;f&&(z=this._getMedianColor(h,f),f.field&&(p=q.isFunction(f.field)?null:this.getField(a,
f.field,b)),y=!(f.legendOptions&&!1===f.legendOptions.showLegend));d&&(d.field&&(M=q.isFunction(d.field)?null:this.getField(a,d.field,b)),N=!(d.legendOptions&&!1===d.legendOptions.showLegend));v&&(v.field&&(E=q.isFunction(v.field)?null:this.getField(a,v.field,b)),B=!(v.legendOptions&&!1===v.legendOptions.showLegend));if(h instanceof da)l=s=!0,this._showHeatRamp(a,b,h,c);else if(h instanceof ba)l=s=!0,this._showDotDensityLegend(a,b,h,c);else if(h instanceof ca)l=s=!0,n=g.create("table",{cellpadding:0,
cellspacing:0,width:"95%","class":"esriLegendLayer"},c),m=g.create("tbody",{},n),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,a,b),h.latestObservationRenderer&&h.latestObservationRenderer instanceof G&&this._buildRow_Renderer(a,h.latestObservationRenderer.symbol,z,u.encode(h.latestObservationRenderer.label)||this.NLS_currentObservations,null,m),h.observationRenderer&&h.observationRenderer instanceof G&&this._buildRow_Renderer(a,h.observationRenderer.symbol,z,u.encode(h.observationRenderer.label)||
this.NLS_previousObservations,null,m);else if(h instanceof K){if(h.infos&&0<h.infos.length){l=s=!0;if(h.legendOptions&&h.legendOptions.title||h.valueExpressionTitle)n=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),m=g.create("tbody",{},n),D=h.legendOptions&&h.legendOptions.title?h.legendOptions.title:h.valueExpressionTitle,this._buildRow_Renderer(a,null,z,u.encode(D),null,m);n=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
c);m=g.create("tbody",{},n);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,a,b);h.attributeField&&v&&this._addSubHeader(m,this._getFieldAlias(h.attributeField,a,b));var C=[];k.forEach(h.infos,function(b){var c=null;a._editable&&a.types&&(c=this._getTemplateFromTypes(a.types,b.value));var d=b.label;null==d&&(d=b.value);-1===k.indexOf(C,d)&&(C.push(d),this._buildRow_Renderer(a,b.symbol,z,u.encode(d),c,m))},this)}A=this._displayDefaultSymbol(a,h,c)}else if(h instanceof H){if(h.infos&&0<h.infos.length||
"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass){l=s=!0;x=this._isUnclassedRenderer(h);!f&&1===h.infos.length&&(w=(w=h.infos[0])&&w.symbol);x||(n=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),m=g.create("tbody",{},n),D=this._getRendererTitle(h,a,b),this._buildRow_Renderer(a,null,z,u.encode(D),null,m));n=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);m=g.create("tbody",{},n);(a._hoverLabel||a._hoverLabels)&&
this._createHoverAction(n,a,b);if(!x||!v||!B)D=h.infos.slice(0).reverse(),k.forEach(D,function(b){var c=b.label;null==c&&!x&&(c=b.minValue+" - "+b.maxValue);this._buildRow_Renderer(a,b.symbol,z,u.encode(c),null,m)},this);if("esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(a.renderer.style===P.STYLE_SCALAR||a.renderer.style===P.STYLE_SINGLE_ARROW))this._buildRow_Renderer(a,h.defaultSymbol,null,"",null,m),a._hideDefaultSymbol=!0}x||(A=this._displayDefaultSymbol(a,h,c))}else h instanceof
G&&(l=s=!0,n=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),m=g.create("tbody",{},n),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,a,b),w=null,a._editable&&(a.templates&&0<a.templates.length)&&(w=a.templates[0]),n=1<D?null:p&&y||M&&N||E&&B,this._buildRow_Renderer(a,h.symbol,z,u.encode(n?this._getRampTitle(1<D?null:f||d||v,a,b):h.label),w,m),w=f?null:h.symbol,n&&(p=M=E=null));if(l){if(f&&y&&(f.field||f.valueExpression))this._showGradientRamp(a,
b,h,null,c,f,p,null,v&&B?!0:!1);if(v&&B&&(v.field||v.valueExpression))l=f&&y||h instanceof K?!1:!0,this._showSizeLegend(a,b,h,v,z,c,E,null,l);if(d&&N&&(d.field||d.valueExpression))E=w&&!w.url&&w.color?w.color:this.transparencyRampColor,this._showGradientRamp(a,b,h,E,c,d,M,null,!1)}if(!A&&(!x||y||B||N))A=this._displayDefaultSymbol(a,h,c);s=s||A}s&&(t.set(r.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<e&&(t.set(r.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,
e)));return s},_isUnclassedRenderer:function(a,b){var c;if(a instanceof H&&a.infos&&1===a.infos.length){c=a.attributeField;var e=a.normalizationField;c=b?c===b:!!this._getVariables(a,c,e).length}return c},_displayDefaultSymbol:function(a,b,c){var e;!a._hideDefaultSymbol&&b.defaultSymbol&&(e=!0,c=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),c=g.create("tbody",{},c),this._buildRow_Renderer(a,b.defaultSymbol,null,u.encode(b.defaultLabel)||"others",null,c));
return e},_showGradientRamp:function(a,b,c,e,d,f,l,s,m){m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(!m?" esriLegendSubFragment":"")},d);d=g.create("tbody",{},m);(a._hoverLabel||a._hoverLabels||s)&&this._createHoverAction(m,a,b,s);(l||f.valueExpression)&&this._addSubHeader(d,this._getRampTitle(f,a,b));l=f.field;var n;l&&(n=q.isFunction(l)?null:this.getField(a,l,b));(b=this._getRampStops(c,f,e,n&&"esriFieldTypeDate"===n.type))&&b.length&&this._drawGradientRamp(d,
b,!0,a,this._getRampBorderColor(c),!!e)},_getMedianColor:function(a,b){var c,e;b.colors?(c=b.minDataValue,e=b.maxDataValue):b.stops&&(c=b.stops[0].value,e=b.stops[b.stops.length-1].value);return a.getColor(c+(e-c)/2,{colorInfo:b})},_getRampStops:function(a,b,c,e){var d,f,l,g,m=!1;b.colors||b.opacityValues?(f=b.maxDataValue-b.minDataValue,d=k.map([0,0.25,0.5,0.75,1],function(a){l=b.minDataValue+a*f;return Number(l.toFixed(6))}),this._checkPrecision(0,4,d)):b.stops&&(d=k.map(b.stops,function(a){return a.value}),
(m=k.some(b.stops,function(a){return!!a.label}))&&(g=k.map(b.stops,function(a){return a.label})));var n=d[0],h,z;f=d[d.length-1]-n;return k.map(d,function(l,k){c?(h=new x(c.toRgba()),z=a.getOpacity(l,{opacityInfo:b}),null!=z&&(h.a=z)):h=a.getColor(l,{colorInfo:b});var q="";if(m)q=g[k];else{var q=e?J.formatDate(l,J.timelineDateFormatOptions):A.format(l),p="";0===k?p=this._specialChars.lt+" ":k===d.length-1&&(p=this._specialChars.gt+" ");q=p+q}return{value:l,color:h,offset:1-(l-n)/f,label:q}},this).reverse()},
_checkPrecision:function(a,b,c){var e=a+(b-a)/2,d=c[a],f=c[e],l=c[b],g=Math.floor(d),m=Math.floor(f),n=Math.floor(l);g===d&&(n===l&&m!==f&&g!==m&&n!==m)&&(c[e]=m);a+1!==e&&this._checkPrecision(a,e,c);e+1!==b&&this._checkPrecision(e,b,c)},_getRampBorderColor:function(a){var b;if(a instanceof G)b=a.symbol;else if(a instanceof K||a instanceof H)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawGradientRamp:function(a,b,c,e,d,f){var l=g.create("tr",{},
a),s,m,n,h,q,p=b.length-1,r;h=0;this.alignRight?(a=g.create("td",{align:this._isRightToLeft?"left":"right"},l),s=g.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},l)):(s=g.create("td",{width:this.gradientWidth,align:"center"},l),a=g.create("td",{},l));l=d&&0<d.a&&!(240<=d.r&&240<=d.g&&240<=d.b);m=g.create("div",{"class":l?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},s);s=g.create("div",{"class":"esriLegendColorRamp"+
(f?" esriLegendTransparencyRamp":"")},m);f=t.get(s,"width");l&&(d=9>y("ie")?d.toHex():"rgba("+d.toRgba().join(",")+")",t.set(s,"border",this.colorRampBorder+" "+d));c?(d=this.gradientHeight*p,t.set(s,"height",d+"px")):d=t.get(s,"height");t.set(m,"height",d+"px");l=R.createSurface(s,f,d);9>y("ie")&&(h=l.getEventSource(),t.set(h,"position","relative"),t.set(h.parentNode,"position","relative"),h=1);try{c&&k.forEach(b,function(a,b){a.offset=b/p}),q=l.createRect({x:-h,y:-h,width:f+h,height:d+h}),q.setFill({type:"linear",
x1:0,y1:0,x2:0,y2:d,colors:b}).setStroke(null),l.createRect({width:f,height:d}).setFill(new x([255,255,255,1-e.opacity])).setStroke(null),this._surfaceItems.push(l)}catch(E){l.clear(),l.destroy()}k.forEach(b,function(a,c){if(a.label){r="top:"+100*a.offset+"%;";var d="";0===c&&(d+=" esriLegendColorRampTickFirst");c===b.length-1&&(d+=" esriLegendColorRampTickLast");g.create("div",{"class":"esriLegendColorRampTick"+d,innerHTML:"\x26nbsp;",style:r},m)}});n=g.create("div",{"class":"esriLegendColorRampLabels",
style:{height:d+this.gradientHeight+"px"}},a);c?k.forEach(b,function(a){g.create("div",{"class":"esriLegendColorRampLabel",innerHTML:u.encode(a.label)||"\x26nbsp;"},n)}):(g.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},n),g.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,style:"top: "+(d+this.gradientHeight-2*this.gradientHeight)+"px;"},n))},_showHeatRamp:function(a,b,c,e,d){var f,l=c.field;f=g.create("table",{cellpadding:0,cellspacing:0,width:"95%",
"class":"esriLegendLayer"},e);e=g.create("tbody",{},f);(a._hoverLabel||a._hoverLabels||d)&&this._createHoverAction(f,a,b,d);(l=l&&this.getField(a,l,b))&&this._addSubHeader(e,this._getFieldAlias(l.name,a,b));b=this._getHeatmapStops(c);b.length&&this._drawGradientRamp(e,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;var c,e,d,f;if(b&&b[0])if(c=b.length-1,a=b[0]&&null!=b[0].ratio){if((a=b[c])&&1!==a.ratio)b=b.slice(0),b.push({ratio:1,color:a.color}),c++}else e=b[0].value,d=b[c].value-
e,b=k.map(b,function(a){return{color:a.color,ratio:(a.value-e)/d}});else a&&a[0]&&(c=a.length-1,f=1/(a.length-1),b=k.map(a,function(a,b){return{color:a,ratio:b*f}}));b=k.map(b,function(a,b){var d="";0===b?d="Low":b===c&&(d="High");return{color:a.color,label:d,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,b,c,e){var d=c.legendOptions,f,l,s,m,n,h,p,w=this.dotDensitySwatchSize,r=Math.round(w/2);d&&(l=d.backgroundColor,s=d.outline,m=d.valueUnit,n=d.dotCoverage);n=(n||this.dotCoverage)/
100;p=Math.round(w*w/Math.pow(c.dotSize,2)*n);e=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);h=g.create("tbody",{},e);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(e,a,b);this._addSubHeader(h,F.substitute({value:c.dotValue,unit:m||""},this.NLS_dotValue));k.forEach(c.fields,function(d){d=q.mixin({},d);d.numPoints=p;f=new ea(c._generateImageSrc(w,w,[d],{x:0,y:0},{x:w,y:w},l),s||c.outline,w,w);d=this.getField(a,d.name,b)||d;this._buildRow_Renderer(a,
f,null,u.encode(this._getFieldAlias(d.name,a,b)),null,h,{type:"path",path:"M "+-r+","+-r+" L "+r+","+-r+" L "+r+","+r+" L "+-r+","+r+" L "+-r+","+-r+" E"})},this)},_showSizeLegend:function(a,b,c,e,d,f,l,s,m){var n=e.legendOptions,n=n&&n.customValues;d=this._getSizeSymbol(c,d);if(!(e.valueUnit&&"unknown"!==e.valueUnit||!d||!n&&(null==e.minSize||null==e.maxSize||null==e.minDataValue||null==e.maxDataValue)&&(!e.stops||1>=e.stops.length))){m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+
(!m?" esriLegendSubFragment":"")},f);f=g.create("tbody",{},m);(a._hoverLabel||a._hoverLabels||s)&&this._createHoverAction(m,a,b,s);(l||e.valueExpression)&&this._addSubHeader(f,this._getRampTitle(e,a,b));l=e.field;var h;l&&(h=q.isFunction(l)?null:this.getField(a,l,b));b=h&&"esriFieldTypeDate"===h.type;n=n||this._getDataValues(c,d,e,b);for(h=m=n.length-1;0<=h;h--)l=n[h],d=L.fromJson(d.toJson()),this._applySize(d,c,e,l),l=b?J.formatDate(l,J.timelineDateFormatOptions):A.format(l),s="",h===m?s=this._specialChars.gt+
" ":0===h&&(s=this._specialChars.lt+" "),s="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+u.encode(s+l)+"\x3c/span\x3e",this._buildRow_Renderer(a,d,null,s,null,f)}},_getSizeSymbol:function(a,b){var c,e;if(a instanceof G)c=a.symbol;else if(a instanceof P)c=a.defaultSymbol;else if(a instanceof K||a instanceof H)c=a.infos[0].symbol,e=1<a.infos.length;if(c=c&&-1!==c.type.indexOf("fillsymbol")?null:c)if(c=L.fromJson(c.toJson()),b||e)-1!==c.type.indexOf("linesymbol")?c.setColor(new x(this.sizeRampDarkColor)):
(c.setColor(new x(this.sizeRampLightColor)),c.setOutline&&(e=new fa,e.setColor(new x(this.sizeRampDarkColor)),e.setWidth(1.5),c.setOutline(e)));return c},_getDataValues:function(a,b,c,e,d,f){d=null==d?5:d;f=null==f?20:f;var l=a.getSizeRangeAtScale(c,this.map.getScale());d=this._interpolateSizeRange(l,d);var g=this._getDataRange(c),m=k.map(d,function(a){return this._getDataValueFromSize(a,g,l)},this);if(!e){var n,m=A.round(m);for(e=1;e<m.length-1;e++)if(n=this._roundDataValue(a,b,c,m[e],m[e-1],f))m[e]=
n[0],d[e]=n[1]}return m},_getDataRange:function(a){var b=a.stops;return b?{min:b[0].value,max:b[b.length-1].value}:{min:a.minDataValue,max:a.maxDataValue}},_interpolateSizeRange:function(a,b){var c=a.minSize,e=(a.maxSize-c)/(b-1),d,f=[];for(d=0;d<b;d++)f.push(c+e*d);return f},_getDataValueFromSize:function(a,b,c){var e=c.minSize;c=c.maxSize;var d=b.min;b=b.max;return a=a<=e?d:a>=c?b:(a-e)/(c-e)*(b-d)+d},_roundDataValue:function(a,b,c,e,d,f){var l=this._getSize(b,a,c,e);d=this._getSize(b,a,c,d);var g,
m=A.getDigits(e),n=m.integer,m=m.fractional,h,k,q,p,r,t,v,y,u,x,B;0<e&&1>e&&(g=Math.pow(10,m),e*=g,n=A.getDigits(e).integer);for(n-=1;0<=n&&!(h=Math.pow(10,n),m=Math.floor(e/h)*h,h*=Math.ceil(e/h),null!=g&&(m/=g,h/=g),k=(m+h)/2,k=A.round([m,k,h],{indexes:[1]})[1],q=this._getSize(b,a,c,m),p=this._getSize(b,a,c,h),r=this._getSize(b,a,c,k),t=A.getPctChange(l,q,d,null),v=A.getPctChange(l,p,d,null),y=A.getPctChange(l,r,d,null),u=t.prev<=f,x=v.prev<=f,u&&x&&(t.prev<=v.prev?(u=!0,x=!1):(x=!0,u=!1)),u?B=
[m,q]:x?B=[h,p]:y.prev<=f&&(B=[k,r]),B);n--);return B},_applySize:function(a,b,c,e){var d=a.type;b=this._getSize(a,b,c,e);switch(d){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":d=a.width;c=a.height;a.setHeight(b);a.setWidth(b*(d/c));break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,b,c,e){return b.getSize(e,{sizeInfo:c,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?
a.style:null})},_buildRow_Renderer:function(a,b,c,e,d,f,l){var k=g.create("tr",{},f),m;this.alignRight?(f=g.create("td",{align:this._isRightToLeft?"left":"right"},k),b&&(m=g.create("td",{align:this._isRightToLeft?"left":"right",width:35},k))):(b&&(m=g.create("td",{width:35,align:"center"},k)),f=g.create("td",{},k));var n=k=30,h;if(b){if("simplemarkersymbol"==b.type)k=Math.min(Math.max(k,b.size+12),125),n=Math.min(Math.max(n,b.size+12),125);else if("picturemarkersymbol"==b.type)k=Math.min(Math.max(k,
b.width),125),n=Math.min(b.height||n,125);else if("textsymbol"==b.type){var q,p;b.text||(q=b.text,p=!0,b.setText(this.defaultText));k=Math.min(Math.max(k,b.getWidth()+12),125);n=Math.min(Math.max(n,b.getHeight()+12),125);p&&b.setText(q)}h=g.create("div",{style:"width:"+k+"px;height:"+n+"px;"},m)}F.isDefined(e)&&"number"===typeof e&&(e=""+e);g.create("td",{innerHTML:e||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},f))));b&&(a=this._drawSymbol(h,b,c,k,n,d,
a,l),this._surfaceItems.push(a))},_addSubHeader:function(a,b){var c=g.create("tr",{},a),c=g.create("td",{align:this._align,colspan:2},c);g.create("td",{innerHTML:u.encode(b)||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},c))))},_drawSymbol:function(a,b,c,e,d,f,l,g){b=L.fromJson(b.toJson());var m=l.opacity;c&&b.setColor(new x(c.toRgba()));if("simplelinesymbol"===b.type||"cartographiclinesymbol"===b.type||"textsymbol"===b.type){if(!b.color)return;c=b.color.toRgba();
c[3]*=m;b.color.setColor(c)}else"simplemarkersymbol"===b.type||"simplefillsymbol"===b.type?(b.color&&(c=b.color.toRgba(),c[3]*=m,b.color.setColor(c)),b.outline&&b.outline.color&&(c=b.outline.color.toRgba(),c[3]*=m,b.outline.color.setColor(c))):"picturemarkersymbol"===b.type&&(a.style.opacity=m,a.style.filter="alpha(opacity\x3d("+100*m+"))");a=R.createSurface(a,e,d);9>y("ie")&&(c=a.getEventSource(),t.set(c,"position","relative"),t.set(c.parentNode,"position","relative"));f=this._getDrawingToolShape(b,
f)||L.getShapeDescriptors(b);var k,m=(c=f.defaultShape)&&"text"===c.type;try{m&&!c.text&&(c.text=this.defaultText),k=a.createShape(g||c).setFill(f.fill).setStroke(f.stroke),m&&k.setFont(f.font)}catch(h){a.clear();a.destroy();return}var p=k.getBoundingBox();g=p.width;f=p.height;var m=-(p.x+g/2),r=-(p.y+f/2);c=a.getDimensions();m={dx:m+c.width/2,dy:r+c.height/2};if("simplemarkersymbol"===b.type&&"path"===b.style)e=l._getScaleMatrix(p,b.size),k.applyTransform(Z.scaleAt(e.xx,e.yy,{x:c.width/2,y:c.height/
2}));else if(g>e||f>d)l=g/e>f/d,e=((l?e:d)-5)/(l?g:f),q.mixin(m,{xx:e,yy:e});k.applyTransform(m);return a},_getDrawingToolShape:function(a,b){var c;switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":c={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case "esriFeatureEditToolTriangle":c={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};break;case "esriFeatureEditToolRectangle":c={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};
break;case "esriFeatureEditToolCircle":c={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":c={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:c,fill:a.getFill(),stroke:a.getStroke()}},_repaintItems:function(){k.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&q.isArray(a.children)&&
k.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,b,c,e){if(e=b._hoverLabel||b._hoverLabels&&b._hoverLabels[c.id]||e)e=u.encode(e),b.mouseMoveHandler=b.mouseMoveHandler||{},b.mouseMoveHandler[c.id]=p.connect(a,"onmousemove",q.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,t.set(r.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(q.hitch(this,function(a,b,c){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=
!0,r.byId(this.id+"_hoverLabel")){var d=r.byId(this.id+"_hoverLabel");d.innerHTML="\x3cspan\x3e"+c+"\x3c/span\x3e";t.set(d,"top",b+"px");t.set(d,"left",a+15+"px");t.set(d,"display","")}else g.create("div",{innerHTML:"\x3cspan\x3e"+c+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,a),500)},e)),b.mouseOutHandler=b.mouseOutHandler||{},b.mouseOutHandler[c.id]=p.connect(a,"onmouseout",q.hitch(this,function(a){this.mouseY=
this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,t.set(r.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;k.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)p.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)p.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=[],c;k.forEach(a.dynamicLayerInfos||a.layerInfos,function(e){c={id:e.id};c.source=e.source&&e.source.toJson();
var d;a.layerDefinitions&&a.layerDefinitions[e.id]&&(d=a.layerDefinitions[e.id]);d&&(c.definitionExpression=d);var f;a.layerDrawingOptions&&a.layerDrawingOptions[e.id]&&(f=a.layerDrawingOptions[e.id]);f&&(c.drawingInfo=f.toJson());c.minScale=e.minScale||0;c.maxScale=e.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var e,d=
b.dynamicLayerInfos||b.layerInfos;for(e=0;e<d.length;e++)if(c==d[e].id){-1<d[e].parentLayerId&&(t.set(r.byId(this.id+"_"+a+"_"+d[e].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,d[e].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,e){var d=a.layer.dynamicLayerInfos||a.layer.layerInfos,f,g;for(f=0;f<d.length;f++)if(d[f].id===c&&d[f].subLayerIds)for(g=0;g<d[f].subLayerIds.length;g++){var p=d[f].subLayerIds[g];-1===k.indexOf(e,p)&&(e.push(p),b(p,e))}}a.layer.layerInfos&&
k.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,b,c){var e,d=!0;if(a.legendResponse&&a.legendResponse.layers)for(e=0;e<a.legendResponse.layers.length;e++){var f=a.legendResponse.layers[e];if(b.id==f.layerId){var g,k;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0==f.minScale&&a.tileInfo&&(g=a.tileInfo.lods[0].scale),0==f.maxScale&&a.tileInfo&&(k=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(g=Math.min(a.minScale,
f.minScale)||a.minScale||f.minScale,k=Math.max(a.maxScale,f.maxScale));if(0<g&&g<c||k>c)d=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)d=!1;return d},_getServiceTitle:function(a){var b=a._titleForLegend;b||((b=a.url)?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+
1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],F.isDefined(a)&&(b+=" ("+a+")"));return u.encode(b)},_getEffectiveScale:function(a,
b){var c=b.minScale,e=b.maxScale;if(F.isDefined(b.parentLayerId)){var d=a.layerInfos,f=b.parentLayerId,g;for(g=d.length-1;0<=g;g--)if(d[g].id==f)if(0==c&&0<d[g].minScale?c=d[g].minScale:0<c&&0==d[g].minScale||0<c&&0<d[g].minScale&&(c=Math.min(c,d[g].minScale)),e=Math.max(e||0,d[g].maxScale||0),-1<d[g].parentLayerId)f=d[g].parentLayerId;else break}return{minScale:c,maxScale:e}},_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===
a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass)?!0:!1},isHostedTileService:function(a){var b=
/(https?:)?\/\/services.*\.arcgis\.com/i;return"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass&&b.test(a.url)?!0:!1},getField:function(a,b,c){if(a.getField)return a.getField(b);if(c&&c.fields){var e;k.forEach(c.fields,function(a){a.name===b&&(e=a)});return e}return null}});q.mixin(C,{ALIGN_LEFT:0,ALIGN_RIGHT:1});y("extend-esri")&&q.setObject("dijit.Legend",C,$);return C});