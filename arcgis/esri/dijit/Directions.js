//>>built
require({cache:{"url:esri/dijit/templates/Directions.html":'\x3cdiv class\x3d"${options.theme}" role\x3d"presentation"\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"_widgetContainer" class\x3d"${_css.widgetContainerClass}" role\x3d"presentation"\x3e\r\n        \x3cdiv class\x3d"${_css.stopsContainerClass}" role\x3d"presentation"\x3e\r\n            \x3cdiv id\x3d"search-source-container" class\x3d"${_css.searchSourceContainerClass}" data-dojo-attach-point\x3d"_searchSourceContainerNode"\x3e\r\n                \x3cdiv data-dojo-attach-point\x3d"_searchSourceSelectorContainer"\x3e\x3c/div\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"${_css.stopsTableContainerClass}"\x3e\r\n                \x3ctable class\x3d"${_css.stopsClass}" data-dojo-attach-point\x3d"_dndNode"\x3e\x3c/table\x3e\r\n                \x3cdiv class\x3d"${_css.stopsTableCoverClass}" data-dojo-attach-point\x3d"_stopsTableCover"\x3e\x3c/div\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n            \x3cdiv class\x3d"${_css.stopsButtonContainerClass}"\x3e\r\n                \x3cdiv class\x3d"${_css.stopsAddDestinationClass}"\x3e\r\n                    \x3cdiv tabindex\x3d"0" role\x3d"button" data-dojo-attach-point\x3d"_activateButtonNode" title\x3d"${_i18n.widgets.directions.activate}" class\x3d"${_css.activateButtonClass} ${_css.stopsButtonClass} ${_css.stopsButtonTabClass} ${_css.stopsPressedButtonClass}" data-blur-on-click\x3d"true"\x3e\x3c/div\x3e\r\n                    \x3cdiv role\x3d"button" tabindex\x3d"0" class\x3d"${_css.linkButtonClass} ${_css.stopsAddDestinationBtnClass}" data-dojo-attach-point\x3d"_addDestinationNode" data-blur-on-click\x3d"true"\x3e${_i18n.widgets.directions.addDestination}\x3c/div\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv class\x3d"${_css.travelModesContainerClass}" data-dojo-attach-point\x3d"_travelModeContainerNode"\x3e\r\n                    \x3cdiv data-dojo-attach-point\x3d"_travelModeSelectorContainer"\x3e\x3c/div\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.linkButtonClass} startTimeMenuButton" data-blur-on-click\x3d"true" data-dojo-attach-point\x3d"_startTimeButtonNodeContainer"\x3e\r\n                    \x3cdiv data-dojo-attach-point\x3d"_startTimeButtonNode"\x3e${_i18n.widgets.directions.leaveNow}\x3c/div\x3e\r\n                    \x3cdiv class\x3d"startTimeMenu" data-dojo-attach-point\x3d"_startTimeMenu"\x3e\r\n                        \x3cul role\x3d"menu"\x3e\r\n                            \x3cli data-dojo-attach-point\x3d"_startTimeMenuLeaveNow" tabindex\x3d"0" class\x3d"esriRouteZoom startTimeMenuItem" role\x3d"menuitemradio" aria-checked\x3d"true"\x3e${_i18n.widgets.directions.leaveNow}\x3c/li\x3e\r\n                            \x3cli data-dojo-attach-point\x3d"_startTimeMenuDepartAt" tabindex\x3d"0" class\x3d"esriRouteZoom startTimeMenuItem" role\x3d"menuitemradio"\x3e${_i18n.widgets.directions.departAt}\x3c/li\x3e\r\n                        \x3c/ul\x3e\r\n                    \x3c/div\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.linkButtonClass} ${_css.stopsOptionsButtonClass}" data-dojo-attach-point\x3d"_optionsButtonNode" data-blur-on-click\x3d"true"\x3e${_i18n.widgets.directions.showOptions}\x3c/div\x3e\r\n            \t\x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n                \x3cdiv class\x3d"departAtContainer" data-dojo-attach-point\x3d"_departAtContainer"\x3e\r\n                    \x3cdiv id\x3d"${id}_directionsDepartAtTime" data-dojo-attach-point\x3d"_departAtTimeContainer"\x3e\x3c/div\x3e\r\n                    \x3cdiv id\x3d"${id}_directionsDepartAtDate" data-dojo-attach-point\x3d"_departAtDateContainer"\x3e\x3c/div\x3e\r\n                \x3c/div\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv role\x3d"presentation" class\x3d"${_css.stopsOptionsMenuClass}" data-dojo-attach-point\x3d"_optionsMenuNode"\x3e\r\n                \x3cdiv class\x3d"${_css.stopsOptionsCheckboxesClass}"\x3e\r\n                    \x3cul\x3e\r\n                        \x3cli class\x3d"${_css.stopsFindOptimalOrderClass}" data-dojo-attach-point\x3d"_findOptimalOrderItemNode"\x3e\x3cinput tabindex\x3d"0" data-dojo-attach-point\x3d"_findOptimalOrderNode" type\x3d"checkbox" id\x3d"${id}_find_optimal_order" /\x3e\x3clabel for\x3d"${id}_find_optimal_order"\x3e${_i18n.widgets.directions.findOptimalOrder}\x3c/label\x3e\x3c/li\x3e\r\n                        \x3cli class\x3d"${_css.stopsReturnToStartClass}" data-dojo-attach-point\x3d"_returnToStartItemNode"\x3e\x3cinput tabindex\x3d"0" data-dojo-attach-point\x3d"_returnToStartNode" type\x3d"checkbox" id\x3d"${id}_stopsReturnToStart" /\x3e\x3clabel for\x3d"${id}_stopsReturnToStart"\x3e${_i18n.widgets.directions.returnToStart}\x3c/label\x3e\x3c/li\x3e\r\n                        \x3cli class\x3d"${_css.stopsUseTrafficClass}" data-dojo-attach-point\x3d"_useTrafficItemNode" title\x3d"${_i18n.widgets.directions.trafficLabelLive}"\x3e\r\n                            \x3cinput tabindex\x3d"0" data-dojo-attach-point\x3d"_useTrafficNode" type\x3d"checkbox" id\x3d"${id}_stopsUseTraffic" /\x3e\x3clabel for\x3d"${id}_stopsUseTraffic"\x3e${_i18n.widgets.directions.useTraffic}\x3c/label\x3e\r\n                            \x3ca data-dojo-attach-point\x3d"_trafficAvailabilityButton" style\x3d"display: none;" href\x3d"http://www.arcgis.com/home/item.html?id\x3db7a893e8e1e04311bd925ea25cb8d7c7" target\x3d"_blank"\x3e\x3cdiv class\x3d"esriTrafficAvailabilityButton" title\x3d"${_i18n.widgets.directions.seeTrafficAvailability}"\x3e\x3c/div\x3e\x3c/a\x3e\r\n                        \x3c/li\x3e\r\n                    \x3c/ul\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv class\x3d"${_css.stopsOptionsToggleContainerClass}"\x3e\r\n                    \x3cdiv class\x3d"${_css.stopsOptionsUnitsContainerClass}"  data-dojo-attach-point\x3d"_agolDistanceUnitsNode"\x3e\r\n                        \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.stopsOptionsUnitsMiClass} ${_css.stopsButtonClass}" data-dojo-attach-point\x3d"_useMilesNode" data-blur-on-click\x3d"true"\x3e${_i18n.widgets.directions.units.esriMiles.abbr}\x3c/div\x3e\r\n                        \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.stopsOptionsUnitsKmClass} ${_css.stopsButtonClass} ${_css.stopsButtonTabLastClass} ${_css.stopsPressedButtonClass}" data-dojo-attach-point\x3d"_useKilometersNode" data-blur-on-click\x3d"true"\x3e${_i18n.widgets.directions.units.esriKilometers.abbr}\x3c/div\x3e\r\n                        \x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n                    \x3c/div\x3e\r\n                    \x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"${_css.stopsGetDirectionsContainerClass}"\x3e\r\n                \x3cdiv class\x3d"getDirectionsBtnContainer"\x3e\r\n                    \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.stopsButtonClass} ${_css.stopsGetDirectionsClass} esriDisabledDirectionsButton" data-dojo-attach-point\x3d"_getDirectionsButtonNode" data-blur-on-click\x3d"true"\x3e${_i18n.widgets.directions.getDirections}\x3c/div\x3e\r\n                    \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.linkButtonClass} ${_css.stopsClearDirectionsClass}" data-dojo-attach-point\x3d"_clearDirectionsButtonNode" data-blur-on-click\x3d"true"\x3e${_i18n.widgets.directions.clearDirections}\x3c/div\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv class\x3d"savePrintBtnContainer" data-dojo-attach-point\x3d"_savePrintBtnContainer"\x3e\r\n                    \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.resultsSaveClass} ${_css.stopsButtonClass} ${_css.stopsButtonTabClass}" data-blur-on-click\x3d"true" data-dojo-attach-point\x3d"_saveMenuButton" title\x3d"${_i18n.widgets.directions.saveTitle}" \x3e\x3c/div\x3e\r\n                    \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.resultsPrintClass} ${_css.stopsButtonClass} ${_css.stopsButtonTabClass}" data-blur-on-click\x3d"true" data-dojo-attach-point\x3d"_printButton" title\x3d"${_i18n.widgets.directions.print}" \x3e\x3c/div\x3e\r\n                \x3c/div\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv role\x3d"presentation" class\x3d"${_css.stopsOptionsMenuClass} esriSaveContainer" data-dojo-attach-point\x3d"_saveMenuNode"\x3e\r\n                \x3cdiv class\x3d"esriLayerNameLabel"\x3e${_i18n.widgets.directions.layerName}\x3c/div\x3e\r\n                \x3cinput type\x3d"text" data-dojo-attach-point\x3d"_outputLayerContainer"\x3e\r\n                \x3cdiv data-dojo-attach-point\x3d"_folderSelectorContainer"\x3e\x3c/div\x3e\r\n                \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"${_css.stopsButtonClass} esriSaveButton esriDisabledDirectionsButton" data-dojo-attach-point\x3d"_saveButton" data-blur-on-click\x3d"true"\x3e${_i18n.widgets.directions.save}\x3c/div\x3e\r\n                \x3cdiv tabindex\x3d"0" role\x3d"button" class\x3d"esriLinkButton esriSaveAsButton" data-dojo-attach-point\x3d"_saveAsButton" data-blur-on-click\x3d"true"\x3e${_i18n.widgets.directions.saveAs}\x3c/div\x3e\r\n            \x3c/div\x3e\r\n    \t\x3c/div\x3e\r\n    \t\x3cdiv class\x3d"${_css.clearClass}"\x3e\x3c/div\x3e\r\n    \t\x3cdiv data-dojo-attach-point\x3d"_msgNode" role\x3d"presentation"\x3e\x3c/div\x3e\r\n    \t\x3cdiv class\x3d"${_css.resultsContainerClass}" role\x3d"presentation"\x3e\r\n        \t\x3cdiv class\x3d"${_css.routesContainerClass}" data-dojo-attach-point\x3d"_resultsNode" role\x3d"presentation"\x3e\x3c/div\x3e\r\n    \t\x3c/div\x3e\r\n    \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("esri/dijit/Directions","require dojo/_base/declare dojo/_base/lang dojo/_base/kernel dojo/_base/array dojo/_base/Color dijit/a11yclick dijit/_TemplatedMixin dijit/form/Select dijit/form/ValidationTextBox dijit/form/DateTextBox dijit/form/TimeTextBox dojo/store/Memory dojo/data/ObjectStore dojo/keys dojo/has dojo/on dojo/mouse dojo/dom dojo/dom-geometry dojo/dom-style dojo/dom-class dojo/dom-attr dojo/query dojo/number dojo/i18n!../nls/jsapi dojo/text!./templates/Directions.html ./Search dojo/dom-construct dojo/promise/all dojo/Deferred dojo/dnd/Source dojo/json ../kernel ../urlUtils ../graphic ../units ../TimeExtent ../InfoTemplate ../SpatialReference ../layers/ArcGISDynamicMapServiceLayer ../layers/GraphicsLayer ../geometry/webMercatorUtils ../geometry/geodesicUtils ../arcgis/utils ../geometry/Point ../geometry/Extent ../geometry/Polyline ../geometry/mathUtils ../symbols/SimpleMarkerSymbol ../symbols/PictureMarkerSymbol ../symbols/CartographicLineSymbol ../symbols/TextSymbol ../renderers/UniqueValueRenderer ../symbols/Font ./_EventedWidget ../tasks/FeatureSet ../tasks/RouteTask ../tasks/RouteParameters ../tasks/GeometryService ../tasks/DistanceParameters ../tasks/PrintTask ../tasks/PrintParameters ../tasks/PrintTemplate ../toolbars/edit ../config ../tasks/ProjectParameters dojo/uacss".split(" "),
function(E,U,f,V,x,S,B,ia,Z,ja,ka,la,$,aa,O,ma,l,P,ea,na,u,q,F,I,N,m,oa,fa,v,J,r,pa,M,qa,ra,t,w,sa,W,ta,ua,Q,T,va,wa,X,xa,ba,Ja,ga,K,L,ya,ca,Y,za,Aa,Ba,Ca,da,Da,Ea,Fa,Ga,ha,Ha,Ia){var R=ra.getProtocolForWebResource();U=U("esri.dijit.Directions",[za,ia],{templateString:oa,mapClickActive:!1,_eventMap:{activate:!0,deactivate:!1,load:!0,"directions-start":!0,"directions-finish":["result"],"directions-clear":!0,"segment-select":["graphic"],"segment-highlight":["graphic"],error:["error"],"stops-update":["stops"],
"route-item-created":!0,"route-item-updated":!0,"feature-collection-created":!0},_emptyStop:{name:""},constructor:function(a,b){if(!a.map)throw Error('Required "map" parameter is missing. Cannot instantiate Directions Widget.');if(!b)throw Error('Required "srcNodeRef" parameter is missing. Cannot instantiate Directions Widget.');this._i18n=m;this._css={widgetContainerClass:"esriDirectionsContainer",searchSourceContainerClass:"esriSearchSourceContainer",stopsContainerClass:"esriStopsContainer",stopsTableContainerClass:"esriStopsTableContainer",
stopsTableCoverClass:"esriStopsTableCover",reverseStopsClass:"esriStopsReverse",addStopsClass:"esriStopsAdd",stopsClass:"esriStops",stopsRemovableClass:"esriStopsRemovable",stopsButtonContainerClass:"esriStopsButtons",stopsOptionsButtonClass:"esriStopsOptionsButton",stopsAddDestinationClass:"esriStopsAddDestination",stopsAddDestinationBtnClass:"esriStopsAddDestinationBtn",stopsGetDirectionsContainerClass:"esriStopsGetDirectionsContainer",stopsGetDirectionsClass:"esriStopsGetDirections",stopsClearDirectionsClass:"esriStopsClearDirections",
stopsInnerGeocoderClass:"esriInnerGeocoder",stopsOptionsOptionsEnabledClass:"esriStopsOptionsEnabled",stopsOptionsMenuClass:"esriStopsOptionsMenu",stopsFindOptimalOrderClass:"esriFindOptimalOrderOption",stopsUseTrafficClass:"esriUseTrafficOption",stopsReturnToStartClass:"esriReturnToStartOption",stopsOptionsCheckboxesClass:"esriOptionsCheckboxes",stopsOptionsToggleContainerClass:"esriOptionsToggleContainer",stopsOptionsUnitsContainerClass:"esriOptionsUnitsContainer",stopsOptionsUnitsMiClass:"esriOptionsUnitsMi",
stopsOptionsUnitsKmClass:"esriOptionsUnitsKm",stopsOptionsImpedanceContainerClass:"esriOptionsImpedanceContainer",stopsOptionsImpedanceTimeClass:"esriOptionsImpedanceTime",stopsOptionsImpedanceDistanceClass:"esriOptionsImpedanceDistance",stopClass:"esriStop",stopOriginClass:"esriStopOrigin",stopDestinationClass:"esriStopDestination",stopUnreachedFirstOrLastClass:"esriStopUnreachedFirstOrLast",stopUnreachedClass:"esriStopUnreached",esriStopGeocoderColumnClass:"esriStopGeocoderColumn",esriStopReverseColumnClass:"esriStopReverseColumn",
stopDnDHandleClass:"esriStopDnDHandle",stopDnDHandleClassHidden:"esriStopDnDHandleHidden",stopIconColumnClass:"esriStopIconColumn",stopIconClass:"esriStopIcon",stopIconRemoveColumnClass:"esriStopIconRemoveColumn",stopIconRemoveClass:"esriStopIconRemove",stopIconRemoveClassHidden:"esriStopIconRemoveHidden",resultsContainerClass:"esriResultsContainer",resultsLoadingClass:"esriResultsLoading",resultsPrintClass:"esriResultsPrint",resultsSaveClass:"esriResultsSave",resultsSummaryClass:"esriResultsSummary",
routesContainerClass:"esriRoutesContainer",routesClass:"esriRoutes",routesErrorClass:"esriRoutesError",routesInfoClass:"esriRoutesInfo",routeClass:"esriRoute",routeTextColumnClass:"esriRouteTextColumn",routeTextClass:"esriRouteText",routeLengthClass:"esriRouteLength",routeOriginClass:"esriDMTStopOrigin",routeDestinationClass:"esriDMTStopDestination",routeInfoClass:"esriRouteInfo",routeIconColumnClass:"esriRouteIconColumn",routeIconClass:"esriRouteIcon",infoWindowRouteClass:"esriInfoWindowRoute",routeZoomClass:"esriRouteZoom",
esriPrintPageClass:"esriPrintPage",esriPrintBarClass:"esriPrintBar",esriPrintButtonClass:"esriPrintButton",esriCloseButtonClass:"esriCloseButton",esriPrintMainClass:"esriPrintMain",esriPrintHeaderClass:"esriPrintHeader",esriPrintLogoClass:"esriPrintLogo",esriPrintMapClass:"esriPrintMap",esriPrintNameClass:"esriPrintName",esriPrintNotesClass:"esriPrintNotes",esriPrintLengthClass:"esriPrintLength",esriPrintDirectionsClass:"esriPrintDirections",esriPrintFooterClass:"esriPrintFooter",esriPrintStopLabelClass:"esriPrintStopLabel",
clearClass:"esriClear",dndDragBodyClass:"esriDndDragDirection",stopsButtonClass:"esriDirectionsButton",stopsButtonTabClass:"esriDirectionsTabButton",stopsButtonTabLastClass:"esriDirectionsTabLastButton",stopsPressedButtonClass:"esriDirectionsPressedButton",linkButtonClass:"esriLinkButton",activateButtonClass:"esriActivateButton",travelModesContainerClass:"esriTravelModesContainer"};this.options={map:null,autoSolve:!0,minStops:2,maxStops:20,theme:"simpleDirections",alphabet:"1234567890",directions:null,
returnToStart:!1,optimalRoute:!1,routeTaskUrl:R+"//route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",printTaskUrl:R+"//utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",geometryTaskUrl:R+"//utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",routeParams:{},stops:["",""],searchOptions:{},stopsInfoTemplate:new W(m.widgets.directions.stop,"${address}${error}"),waypointInfoTemplate:new W(m.widgets.directions.maneuver,
m.widgets.directions.waypoint),segmentInfoTemplate:new W(m.widgets.directions.maneuver,'\x3cdiv class\x3d"${maneuverType}"\x3e\x3cdiv class\x3d"'+this._css.routeIconClass+" "+this._css.infoWindowRouteClass+'"\x3e\x3cstrong\x3e${step}.\x3c/strong\x3e ${formattedText}\x3c/div\x3e\x3c/div\x3e'),textSymbolFont:new Y("11px",Y.STYLE_NORMAL,Y.VARIANT_NORMAL,Y.WEIGHT_NORMAL,"Arial, Helvetica, sans-serif"),textSymbolColor:new S([255,255,255]),textSymbolOffset:{x:0,y:10.875},fromSymbol:(new K({url:E.toUrl("./images/Directions/greenPoint.png"),
height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),fromSymbolDrag:(new K({url:E.toUrl("./images/Directions/greenPointMove.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),stopSymbol:(new K({url:E.toUrl("./images/Directions/bluePoint.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),stopSymbolDrag:(new K({url:E.toUrl("./images/Directions/bluePointMove.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),toSymbol:(new K({url:E.toUrl("./images/Directions/redPoint.png"),
height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),toSymbolDrag:(new K({url:E.toUrl("./images/Directions/redPointMove.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),unreachedSymbol:(new K({url:E.toUrl("./images/Directions/grayPoint.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),unreachedSymbolDrag:(new K({url:E.toUrl("./images/Directions/grayPointMove.png"),height:21.75,width:15.75,type:"esriPMS"})).setOffset(0,10.875),waypointSymbol:new ga({color:[255,
255,255,255],size:10,type:"esriSMS",style:"esriSMSCircle",outline:{color:[20,89,127,255],width:2.5,type:"esriSLS",style:"esriSLSSolid"}}),maneuverSymbol:new ga({color:[255,255,255,255],size:4,type:"esriSMS",style:"esriSMSCircle",outline:{color:[30,99,137,255],width:1,type:"esriSLS",style:"esriSLSSolid"}}),routeSymbol:(new L).setColor(new S([20,89,127,1])).setWidth(10).setCap(L.CAP_ROUND).setJoin(L.JOIN_ROUND),segmentSymbol:(new L).setColor(new S([255,255,255,1])).setWidth(6).setCap(L.CAP_ROUND).setJoin(L.JOIN_ROUND),
barrierRenderer:new ca({type:"uniqueValue",field1:"BarrierType",defaultSymbol:{type:"esriPMS",imageData:"PHN2ZyB3aWR0aD0iMjIyIiBoZWlnaHQ9IjIyMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGc+CjxlbGxpcHNlIGZpbGw9IiNmZjAwMDAiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIyMCIgY3g9IjExMiIgY3k9IjExMSIgaWQ9InN2Z181IiByeD0iMTAwIiByeT0iMTAwIi8+CjxlbGxpcHNlIGZpbGw9IiNmZjAwMDAiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIyMCIgY3g9IjExMiIgY3k9IjExMSIgaWQ9InN2Z182IiByeD0iOTUiIHJ5PSI5NSIvPgo8cmVjdCBmaWxsPSIjZmYwMDAwIiBzdHJva2Utd2lkdGg9IjIwIiB4PSI2NC41IiB5PSIxMDIiIHdpZHRoPSI5NSIgaGVpZ2h0PSIxOCIgaWQ9InN2Z183IiBzdHJva2U9IiNmZmZmZmYiLz4KPC9nPgo8L3N2Zz4\x3d",
contentType:"image/svg+xml",width:18,height:18},uniqueValueInfos:[{value:"2",symbol:{type:"esriPMS",imageData:"PHN2ZyB3aWR0aD0iMjg2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGc+CjxwYXRoIGZpbGw9IiNmZmYiIHN0cm9rZS13aWR0aD0iMTAiIGQ9Im04Ljc0OTk5MiwyNTEuNzQ5OTk3bDEzNC45OTk5OTgsLTI0MS45OTk5OThsMTM0Ljk5OTk5OCwyNDEuOTk5OTk4bC0yNjkuOTk5OTk1LDBsLTAuMDAwMDAxLDB6IiBpZD0ic3ZnXzEiIHN0cm9rZT0iIzAwMCIvPgo8cGF0aCBzdHJva2U9IiNmZmYiIGZpbGw9IiNmZjAwMDAiIHN0cm9rZS13aWR0aD0iMTUiIGQ9Im0yMy41MDAwMDQsMjQyLjUwMDAwNWwxMTkuOTk5OTkyLC0yMTUuOTk5OTk5bDExOS45OTk5OTIsMjE1Ljk5OTk5OWwtMjM5Ljk5OTk4MywwbC0wLjAwMDAwMSwweiIgaWQ9InN2Z18yIi8+Cjx0ZXh0IGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiNmZjAwMDAiIHN0cm9rZS13aWR0aD0iMCIgeD0iMTA5IiB5PSIyMjIuNzUiIGlkPSJzdmdfNSIgZm9udC1zaXplPSIxODAiIGZvbnQtZmFtaWx5PSJHZW9yZ2lhLCBUaW1lcywgJ1RpbWVzIE5ldyBSb21hbicsIHNlcmlmIiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHhtbDpzcGFjZT0icHJlc2VydmUiPiE8L3RleHQ+CjwvZz4KPC9zdmc+",
contentType:"image/svg+xml",width:19,height:18}}]}),polylineBarrierRenderer:new ca({type:"uniqueValue",field1:"BarrierType",defaultSymbol:{color:[255,0,0,184],width:7.5,type:"esriSLS",style:"esriSLSSolid"},uniqueValueInfos:[{value:"1",symbol:{color:[255,85,0,184],width:7.5,type:"esriSLS",style:"esriSLSSolid"}}]}),polygonBarrierRenderer:new ca({type:"uniqueValue",field1:"BarrierType",defaultSymbol:{color:[255,0,0,156],outline:{color:[255,0,0,153],width:2.4,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",
style:"esriSFSSolid"},uniqueValueInfos:[{value:"1",symbol:{color:[255,170,0,156],outline:{color:[255,0,0,153],width:7.5,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSSolid"}}]}),printPage:"",printTemplate:"",focusOnNewStop:!0,dragging:!0,canModifyStops:!0,canModifyWaypoints:!0,directionsLengthUnits:null,directionsLanguage:null,traffic:!1,trafficLayer:null,showPrintPage:!0,showSaveButton:!1,showSegmentPopup:!1,showSegmentHighlight:!0,showReverseStopsButton:!0,showReturnToStartOption:!0,
showOptimalRouteOption:!0,showTravelModesOption:!0,showMilesKilometersOption:!0,showClearButton:!1,showActivateButton:!0,loaded:!1,routeLayer:{itemId:null,title:null,isItemOwner:!0,ownerFolder:null},startTime:"now"};this.userOptions=a;this.defaults=f.mixin({},this.options,a,{_waypointName:"DWWP",_userDefinedStopName:"UserDefinedStopName",_solveInProgress:!1,_moveInProgress:!1,_stopSequence:1E3});if(!this.defaults.minStops||2>this.defaults.minStops)this.defaults.minStops=2;if(2<this.defaults.minStops&&
this.defaults.stops&&","===this.defaults.stops.toString())for(var c=2;c<this.defaults.minStops;c++)this.defaults.stops.splice(0,0,"");this.domNode=b},postCreate:function(){this.inherited(arguments);this.own(l(this._activateButtonNode,B,f.hitch(this,function(){this.mapClickActive?this.deactivate():this.activate()})));this.own(l(this._addDestinationNode,B,f.hitch(this,this._addStopButton)));this.own(l(this._optionsButtonNode,B,f.hitch(this,this._toggleOptionsMenu)));this.own(l(this._saveMenuButton,
B,f.hitch(this,this._toggleSaveMenu)));this.own(l(this._saveButton,B,f.hitch(this,function(){this._saveButton._enabled&&this._storeRouteUI()})));this.own(l(this._saveAsButton,B,f.hitch(this,function(){f.mixin(this.routeLayer,{itemId:null,title:null,ownerFolder:null});this._storeRouteUI()})));this.own(l(this._findOptimalOrderNode,B,f.hitch(this,this._toggleCheckbox)));this.own(l(this._returnToStartNode,B,f.hitch(this,this._toggleCheckbox)));this.own(l(this._useTrafficNode,B,f.hitch(this,this._toggleCheckbox)));
this.own(l(this._useMilesNode,B,f.hitch(this,this._toggleUnits)));this.own(l(this._useKilometersNode,B,f.hitch(this,this._toggleUnits)));this.own(l(this._getDirectionsButtonNode,B,f.hitch(this,this.getDirections)));this.own(l(this._clearDirectionsButtonNode,B,f.hitch(this,function(){this.clearDirections()})));var a=f.hitch(this,function(){clearTimeout(this._startTimeMenu._hideTimer);this._startTimeMenu._hideTimer=setTimeout(f.hitch(this,function(){u.set(this._startTimeMenu,"display","none")}),100)});
this.own(l(this._startTimeButtonNode,B,f.hitch(this,function(){!this._startTimeButtonNode.disabled&&"block"!==u.get(this._startTimeMenu,"display")?(u.set(this._startTimeMenu,"display","block"),this[isNaN(this.startTime)?"_startTimeMenuLeaveNow":"_startTimeMenuDepartAt"].focus()):u.set(this._startTimeMenu,"display","none")})));this.own(l(this._startTimeMenuLeaveNow,"blur",a));this.own(l(this._startTimeMenuDepartAt,"blur",a));this.own(l(this._startTimeMenuLeaveNow,"mousedown",f.hitch(this,function(){this.startTime=
"now";this._updateStartTimeUI();this._clearDisplayBeforeSolve()})));this.own(l(this._startTimeMenuDepartAt,"mousedown",f.hitch(this,function(){this.startTime=(new Date).getTime();this._updateStartTimeUI();this._clearDisplayBeforeSolve()})));this._symbolEventPaddingDirections=(new L).setColor(new S([0,255,0,0])).setWidth(20).setCap(L.CAP_ROUND);this._stopLayer=new Q({id:"directions_stopLayer_"+this.id,displayOnPan:!0});this._routeLayer=new Q({id:"directions_routeLayer_"+this.id,displayOnPan:!0});this._waypointsEventLayer=
new Q({id:"directions_waypointsEventLayer_"+this.id,displayOnPan:!0});this._barriersLayer=new Q({id:"directions_barriersLayer_"+this.id,displayOnPan:!0});this._polylineBarriersLayer=new Q({id:"directions_polylineBarriersLayer_"+this.id,displayOnPan:!0});this._polygonBarriersLayer=new Q({id:"directions_polygonBarriersLayer_"+this.id,displayOnPan:!0});this._barriersLayer.setRenderer(this.defaults.barrierRenderer);this._polylineBarriersLayer.setRenderer(this.defaults.polylineBarrierRenderer);this._polygonBarriersLayer.setRenderer(this.defaults.polygonBarrierRenderer);
this.map.addLayer(this._routeLayer);this.map.addLayer(this._polygonBarriersLayer);this.map.addLayer(this._polylineBarriersLayer);this.map.addLayer(this._barriersLayer);this.map.addLayer(this._stopLayer);this._snappingManager=this.map.enableSnapping({layerInfos:[{layer:this._waypointsEventLayer,snapToVertex:!1,snapToPoint:!0,snapToEdge:!0}],tolerance:15});this._setWidgetProperties();var b=new t(null,this.waypointSymbol,{}),a=f.hitch(this,function(){!this._moveInProgress&&(!this._solveInProgress&&b._isShown())&&
(this.editToolbar.deactivate(),this._stopLayer.remove(b),clearTimeout(b._solveTimeout),b._solveTimeout=null,b.attributes.isWaypoint=!0,b._isStopIcon&&this.stopGraphics[b._index]&&(this._stopLayer.add(this.stopGraphics[b._index]),this._stopLayer.add(this.textGraphics[b._index])));b._showTooltip()});this._handle=f.mixin(b,{_isHandle:!0,_tooltip:v.create("div",{className:this.theme+" esriDirectionsRouteTooltip",onmouseover:a},this.map.container),_showTooltip:f.hitch(this,function(a){b._tooltip.style.display=
a&&!(a instanceof MouseEvent)?"inline":"none";a&&(a="string"===typeof a?a:"\x3ctable class\x3d'esriRoutesTooltip'\x3e"+this._renderDirectionsItemTR(a)+"\x3c/table\x3e",b._tooltip.innerHTML!==a&&(b._tooltip.innerHTML=a))}),_isShown:f.hitch(this,function(){return-1<x.indexOf(this._stopLayer.graphics,b)}),_remove:a});this._activate(this.mapClickActive)},startup:function(){this.inherited(arguments);return this._enqueue(this._init)},destroy:function(){this.deactivate();this.map.removeLayer(this._barriersLayer);
this.map.removeLayer(this._polylineBarriersLayer);this.map.removeLayer(this._polygonBarriersLayer);this.map.removeLayer(this._routeLayer);this.map.removeLayer(this._stopLayer);this.map.removeLayer(this._waypointsEventLayer);this._disconnectEvents();v.empty(this.domNode);this.inherited(arguments)},activate:function(){return this._enqueue(function(){this.set("mapClickActive",!0)})},deactivate:function(){return this._enqueue(function(){this.set("mapClickActive",!1)})},clearDirections:function(){return this._enqueue(function(){this.clearMessages();
return this._clearDirections()})},reset:function(){return this._enqueue(this._reset)},modifyStopSequence:function(a,b){return this._enqueue(function(){return this._modifyStopSequence(a,b)})},onActivate:function(){},onDeactivate:function(){},onLoad:function(){this._enableButton(this._getDirectionsButtonNode)},onDirectionsStart:function(){this._clearDisplayBeforeSolve();this.set("solving",!0);this._showLoadingSpinner(!0)},onDirectionsFinish:function(){this._showLoadingSpinner(!1);this.set("solving",
!1)},onDirectionsClear:function(){},onSegmentSelect:function(){},onSegmentHighlight:function(){},onStopsUpdate:function(){},onRouteItemCreated:function(){},onRouteItemUpdated:function(){},onFeatureCollectionCreated:function(){},onError:function(){},removeStops:function(){return this.reset()},removeStop:function(a,b,c){return this._enqueue(function(){this.clearMessages();return this._removeStop(a,b,c)})},updateStops:function(a){return this._enqueue(function(){return this._updateStops(a)})},addStops:function(a,
b){return this._enqueue(function(){return this._addStops(a,b)}).then(f.hitch(this,this.zoomToFullRoute))},addStop:function(a,b){return this._enqueue(function(){return this._addStop(a,b)},{_incrementalSolveStopRange:this._incrementalSolveStopRange})},updateStop:function(a,b,c){return this._enqueue(function(){return this._updateStop(a,b,c)},{_incrementalSolveStopRange:this._incrementalSolveStopRange})},clearMessages:function(){this.messages=[];this._msgNode&&(this._msgNode.innerHTML="")},getDirections:function(a){return this._enqueue(function(){return this._getDirections().then(f.hitch(this,
function(){!0!==a&&this.zoomToFullRoute()}))})},selectSegment:function(a){if(this.directions&&this.directions.features&&!(0>a||a>=this.directions.features.length))for(var b=I("[data-segment]",this._resultsNode),c=0;c<b.length;c++){var d=parseInt(F.get(b[c],"data-segment"),10);if(a===d&&b[c]!==this._focusedDirectionsItem){this._focusedDirectionsItem=b[c];this.centerAtSegmentStart(a);this.onSegmentSelect(this.directions.features[a]);b[c].focus();break}}},unhighlightSegment:function(a){var b=this._segmentGraphics;
if(b&&(!this._focusedDirectionsItem||a)){for(a=0;a<b.length;a++)this._routeLayer.remove(b[a]);this._segmentGraphics=[]}},highlightSegment:function(a,b){if(!(this._focusedDirectionsItem&&!b||a>=this.directions.features.length)){a=a||0;var c=f.hitch(this,function(a){var b=this.map.toMap({x:0,y:0});return this.map.toScreen(b.offset(a,0)).x}),d=f.hitch(this,function(a){for(var b=0,d=0;d<a.length;d++)for(var e=1;e<a[d].length;e++)var g=a[d][e-1],h=a[d][e],b=b+c(Math.sqrt((g[0]-h[0])*(g[0]-h[0])+(g[1]-
h[1])*(g[1]-h[1])));return b}),e=f.hitch(this,function(a){var b=this.map.toMap({x:0,y:0});return this.map.toMap({x:a,y:0}).x-b.x}),g=function(a,b,d){b=Math.max(1,b);for(var e=d?a[0].length-1:0,g=0,h,k,f,n=[[a[0][d?e:0]]];d&&0<e||!d&&e<a[0].length-1;){k=a[0][d?e-1:e];f=a[0][d?e:e+1];if(h=c(Math.sqrt((k[0]-f[0])*(k[0]-f[0])+(k[1]-f[1])*(k[1]-f[1]))))if(g+h<b)d?n[0].splice(0,0,k):n[0].push(f),g+=h;else{b=(b-g)/h;d?n[0].splice(0,0,[f[0]-(f[0]-k[0])*b,f[1]-(f[1]-k[1])*b]):n[0].push([k[0]+(f[0]-k[0])*b,
k[1]+(f[1]-k[1])*b]);break}e+=d?-1:1}return 0<g+h?n:a},h=this.get("directions").features[a],n=new ba(h.geometry),k=40*Math.PI/180;f.mixin(h.attributes,{_index:a});if(a){var A=g(this.get("directions").features[a-1].geometry.paths,25,!0),p="esriDMTStop"!==h.attributes.maneuverType?g(n.paths,25,!1):A,A=p!==A?[A[0].concat(p[0])]:p,m=(new ba(p)).getExtent();if(1<p[0].length&&15<=c(Math.max(m.getWidth(),m.getHeight()))){for(var g=15*Math.cos(k/2),d=15*Math.sin(k/2),H=p[0].length-2,l,k=p[0][H+1],m=0;0<=
H&&!m;)l=p[0][H],m=c(Math.sqrt((l[0]-k[0])*(l[0]-k[0])+(l[1]-k[1])*(l[1]-k[1]))),H--;22>m&&(p=m+(22-m)/3,H=m+2*(22-m)/3,H=[l[0]+H/m*(k[0]-l[0]),l[1]+H/m*(k[1]-l[1])],l=[k[0]-p/m*(k[0]-l[0]),k[1]-p/m*(k[1]-l[1])],k=H,m=22);g/=m;p=[k[0]-(k[0]-l[0])*g,k[1]-(k[1]-l[1])*g];l[1]!==k[1]?(g=(k[0]-l[0])/(k[1]-l[1]),l=e(d/Math.sqrt(1+g*g)),e=g*l):(l=0,e=e(d));Infinity!==Math.abs(l)&&(Infinity!==Math.abs(e)&&!isNaN(l)&&!isNaN(e))&&(A[0].push(k),A[0].push([p[0]-l,p[1]+e]),A[0].push([p[0]+l,p[1]-e]),A[0].push(k))}else A=
g(A,2*d(p),!0);n.paths=A}this.unhighlightSegment(this._segmentGraphics&&this._segmentGraphics.length);e=f.clone(this.routeSymbol).setWidth(this.segmentSymbol.width).setColor(new S([parseInt(0.9*this.segmentSymbol.color.r),parseInt(0.9*this.segmentSymbol.color.g),parseInt(0.9*this.segmentSymbol.color.b)]));this._segmentGraphics=[new t(h.geometry,e,h.attributes,this.get("segmentInfoTemplate")),new t(n,this.routeSymbol,h.attributes,this.get("segmentInfoTemplate")),new t(n,this.segmentSymbol,h.attributes,
this.get("segmentInfoTemplate"))];this.get("showSegmentHighlight")&&(this._routeLayer.add(this._segmentGraphics[0]),this._routeLayer.add(this._segmentGraphics[1]),this._routeLayer.add(this._segmentGraphics[2]));h=f.hitch(this,function(a){if(0<a&&a<this.directions.features.length){a=this.directions.features[a]._associatedFeaturesWithWaypoints;for(var b=0;b<a.length;b++)a[b]._associatedSnapFeature&&a[b]._associatedSnapFeature.getDojoShape()&&a[b]._associatedSnapFeature.getDojoShape().moveToFront()}});
h(a-1);h(a);this.onSegmentHighlight(this.directions.features[a])}},zoomToSegment:function(a){var b,c=new r;this.directions&&this.directions.features?(b=Math.max(0,Math.min(this.directions.features.length-1,a||0)),this.map.setExtent(this.get("directions").features[b].geometry.getExtent(),!0).promise.always(f.hitch(this,function(){this.highlightSegment(b);c.resolve()}))):c.reject(Error("No directions."));return c.promise},centerAtSegmentStart:function(a){var b,c=new r;if(this.directions&&this.directions.features){b=
Math.max(0,Math.min(this.directions.features.length-1,a||0));var d=this.directions.features[b];this.map.centerAt(d.geometry.getPoint(0,0)).promise.always(f.hitch(this,function(){this.highlightSegment(b,!0);this._showSegmentPopup(d,b);c.resolve()}))}else c.reject(Error("No directions."));return c.promise},zoomToFullRoute:function(){var a=new r;this.directions&&this.directions.features?(this._clearInfoWindow(),this.unhighlightSegment(),this.get("map").setExtent(this.get("directions").extent,!0).promise.always(a.resolve)):
a.reject(Error("No directions."));return a.promise},setListIcons:function(){var a,b=this._dnd.getAllNodes();for(a=0;a<b.length;a++){var c=I("."+this._css.stopIconClass,b[a])[0];c&&(c.innerHTML=this._getLetter(a));q.remove(b[a],this._css.stopOriginClass+" "+this._css.stopDestinationClass+" "+this._css.stopUnreachedClass+" "+this._css.stopUnreachedFirstOrLastClass);c=this._getStopSymbol(this.stops[a]);c===this.fromSymbol?q.add(b[a],this._css.stopOriginClass):c===this.toSymbol?q.add(b[a],this._css.stopDestinationClass):
c===this.unreachedSymbol&&q.add(b[a],this._css.stopUnreachedClass)}a=I("[data-reverse-td]",this._dndNode)[0];v.destroy(a);this.get("showReverseStopsButton")&&v.create("td",{"data-reverse-td":"true",rowspan:b.length,className:this._css.esriStopReverseColumnClass,innerHTML:'\x3cdiv role\x3d"button" class\x3d"'+this._css.reverseStopsClass+'" data-reverse-stops\x3d"true" title\x3d"'+m.widgets.directions.reverseDirections+'"\x3e\x3c/div\x3e',onmouseover:function(a){a.stopPropagation()},onmouseout:function(a){a.stopPropagation()}},
b[0])},addRouteSymbols:function(){if(this.stopGraphics.length){this._moveLayersToFront();for(var a=0;a<this.stopGraphics.length;a++)if(this.stopGraphics[a]&&(!this._handle._isShown()||this._handle._isShown()&&this._handle._index!==a)){this._stopLayer.add(this.stopGraphics[a]);var b=this.stopGraphics[a].getDojoShape();b&&b.moveToFront();this._stopLayer.add(this.textGraphics[a]);(b=this.textGraphics[a].getDojoShape())&&b.moveToFront()}this._moveInProgress&&(!this._handle.attributes.isWaypoint&&this._handle.getDojoShape())&&
this._handle.getDojoShape().moveToFront()}},createRouteSymbols:function(){this._clearStopGraphics();for(var a=this.stops,b=function(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&0===c.indexOf("Attr_")&&(b[c]=a[c]);return b},c=0;c<a.length;c++){var d=a[c];if(d&&d.feature){var e=d.feature.attributes,g=e?e.Status:void 0,h=null;this._isStopAWaypoint(d)||(h=new ya(this._getLetter(c),this.get("textSymbolFont"),this.get("textSymbolColor")),this.get("textSymbolOffset")&&h.setOffset(this.get("textSymbolOffset").x,
this.get("textSymbolOffset").y));h=new t(d.feature.geometry,h,{address:d.name},this.get("stopsInfoTemplate"));h._isStopLabel=!0;h._index=c;d=new t(d.feature.geometry,this._getStopSymbol(d),f.mixin({address:d.name,Status:void 0===g?0:g,CurbApproach:e&&e.CurbApproach?e.CurbApproach:null,TimeWindowStart:e&&e.TimeWindowStart?e.TimeWindowStart:null,TimeWindowEnd:e&&e.TimeWindowEnd?e.TimeWindowEnd:null,isWaypoint:this._isStopAWaypoint(d)},b(e)),this.get(this._isStopAWaypoint(d)?"waypointInfoTemplate":"stopsInfoTemplate"));
d._isStopIcon=!0;d._index=c;this.stopGraphics[c]=d;this.textGraphics[c]=h}}this.set("stopGraphics",this.stopGraphics);this.set("textGraphics",this.textGraphics);this.addRouteSymbols();this.setListIcons()},setTravelMode:function(a){return this._enqueue(function(){this.clearMessages();this._travelModeSelector.setValue(a);return this._setTravelMode(a)})},getSupportedTravelModeNames:function(){var a=[],b=this.serviceDescription;if(b&&b.supportedTravelModes&&b.supportedTravelModes.length)for(var b=b.supportedTravelModes,
c=0;c<b.length;c++)a.push(b[c].name);return a},setDirectionsLengthUnits:function(){var a=1===arguments.length?arguments[0]:this.get("directionsLengthUnits");return this._enqueue(function(){this.clearMessages();return this._setDirectionsLengthUnits(a)})},setDirectionsLanguage:function(){var a=1===arguments.length?arguments[0]:this.get("directionsLanguage");return this._enqueue(function(){this.clearMessages();return this._setDirectionsLanguage(a)})},useMyCurrentLocation:function(a){this.clearMessages();
return this._createLocateButton(this.geocoders[a],!0,!0)},loadRoute:function(a){return this._enqueue(f.hitch(this,function(){return this._loadRoute(a)}))},_getStopsAttr:function(){return this.returnToStart&&this._returnToStartStop?this.stops.concat(this._returnToStartStop):this.stops},_getTravelModeNameAttr:function(){return this.routeParams&&this.routeParams.travelMode&&this.routeParams.travelMode.name},_reset:function(){var a=this.mapClickActive;this._clearBarriersGraphics();this._setWidgetProperties();
return this._init().then(f.hitch(this,function(){this.mapClickActive=a;this._searchSourceSelector&&this._searchSourceSelector.setValue("all")}))},_activate:function(){var a=this.get("mapClickActive"),b=f.hitch(this,function(a){for(var b=a?[this.textGraphics,this.stopGraphics,this.displayedManeuverPointGraphics,this.displayedRouteGraphics]:[this.displayedRouteGraphics,this.displayedManeuverPointGraphics,this.stopGraphics,this.textGraphics],e=0;e<b.length;e++)for(var g=b[e],h=0;h<g.length;h++){var f=
g[h].getDojoShape();f&&f[a?"moveToBack":"moveToFront"].call(f)}});this._addStopOnMapClickListener&&this._addStopOnMapClickListener.remove();a?(this.map.activeDirectionsWidget&&this.map.activeDirectionsWidget!==this&&this.map.activeDirectionsWidget.deactivate(),this.map.activeDirectionsWidget=this,this._addStopOnMapClickListener=l(this.map,"click",f.hitch(this,function(a){this.canModifyStops&&!this._solveInProgress&&(this.map.infoWindow.hide(),this.addStop(new t(a.mapPoint)))})),this.map.addLayer(this._waypointsEventLayer),
this._moveLayersToFront(),q.add(this._activateButtonNode,this._css.stopsPressedButtonClass),this.onActivate()):(this.map.removeLayer(this._waypointsEventLayer),q.remove(this._activateButtonNode,this._css.stopsPressedButtonClass),this.onDeactivate());b(!a);this.emit("map-click-active",{mapClickActive:this.mapClickActive})},_moveLayersToFront:function(){var a=this.get("map"),b=a.graphicsLayerIds.length-1;a.reorderLayer(this._routeLayer,b);a.reorderLayer(this._polygonBarriersLayer,b);a.reorderLayer(this._polylineBarriersLayer,
b);a.reorderLayer(this._barriersLayer,b);a.reorderLayer(this._waypointsEventLayer,b);a.reorderLayer(this._stopLayer,b)},_destroyGeocoders:function(){for(;this.geocoders&&this.geocoders.length;)this.geocoders[0]&&this.geocoders[0].destroy(),this.geocoders.splice(0,1);this.geocoders=[]},_disconnectEvents:function(){var a=this._clearDirections(!0),b;if(this._watchEvents&&this._watchEvents.length)for(b=0;b<this._watchEvents.length;b++)this._watchEvents[b].unwatch();if(this._onEvents&&this._onEvents.length)for(b=
0;b<this._onEvents.length;b++)this._onEvents[b].remove();if(this._geocoderEvents)for(b=0;b<this._geocoderEvents.length;b++)this._geocoderEvents[b].value.unwatch(),this._geocoderEvents[b].blur.remove(),this._geocoderEvents[b].select.remove(),this._geocoderEvents[b].suggest.remove();this._onEvents=[];this._watchEvents=[];this._geocoderEvents=[];this._disconnectResults();this._destroyGeocoders();this._destroyGlobalGeocoder();this._destroyDnD();return a},_getDirections:function(){var a=new r;this._removeEmptyStops();
1<this._getStopCount()+this._getWaypointCount()&&this.loaded?(this.onDirectionsStart(),this.clearMessages(),this._dnd.sync(),this._sortGeocoders(),this._getCandidates(this.stops).then(f.hitch(this,function(b){this.stops=b;this._setStops();this._configureRoute().always(f.hitch(this,function(b){a.resolve(b)}))}),f.hitch(this,function(b){this.set("directions",null);this._clearRouteGraphics();a.reject(b);this.onDirectionsFinish(b)}))):this._clearDirections(!0).always(f.hitch(this,function(){this.createRouteSymbols();
a.reject(Error(this.loaded?m.widgets.directions.error.notEnoughStops:m.widgets.directions.error.notReady))}));return a.promise},_clearDirections:function(){var a=new r;this._handle&&this._handle._remove();this.get("routeParams")&&this.get("routeParams").stops?this.get("routeParams").stops.features.length?(this._clearBarriersGraphics(),this.get("routeParams").stops.features=[],this.onDirectionsClear(),a.resolve()):arguments.length?a.resolve():this._reset().then(a.resolve,a.reject):a.resolve();this.set("directions",
null);this._clearDisplayBeforeSolve();this._clearDisplayAfterSolve();this._routeLayer.clear();this._waypointsEventLayer.clear();this._stopLayer.clear();return a.promise},_setTravelMode:function(a){var b=new r,c=this.serviceDescription,d=function(){b.resolve(a)};if(c&&c.supportedTravelModes&&c.supportedTravelModes.length){for(var e=c.supportedTravelModes,g=!1,c=0;c<e.length;c++)if(e[c].name===a){g=!0;!this.routeParams.travelMode||this.routeParams.travelMode&&this.routeParams.travelMode.name!==a?(this.routeParams.travelMode=
e[c].impedanceAttributeName?e[c]:e[c].itemId,this._checkStartTimeUIAvailability(),this._solveAndZoom().always(d)):d();break}g||b.reject(a)}else b.reject(a);return b.promise},_setDirectionsLengthUnits:function(a){this._clearDisplayBeforeSolve();var b=new r;q.remove(this._useMilesNode,this._css.stopsPressedButtonClass);q.remove(this._useKilometersNode,this._css.stopsPressedButtonClass);a===w.KILOMETERS?q.add(this._useKilometersNode,this._css.stopsPressedButtonClass):a===w.MILES&&q.add(this._useMilesNode,
this._css.stopsPressedButtonClass);a===w.KILOMETERS||a===w.METERS||a===w.MILES||a===w.FEET||a===w.NAUTICAL_MILES?(this.directionsLengthUnits=a,b.resolve(a)):b.reject(a);return b.promise},_setDirectionsLanguage:function(a){this._clearDisplayBeforeSolve();var b=new r;a=this._setDirectionsLanguageByLocale(a);this._solveAndZoom().always(function(){b.resolve(a)},b.reject);return b.promise},_showLoadingSpinner:function(a){void 0===a&&(a=this._requestQueueTail&&!this._requestQueueTail.isFulfilled()||this._moveInProgress);
a?(q.add(this._widgetContainer,this._css.resultsLoadingClass),q.add(this._resultsNode,"esriRoutesContainerBusy")):(q.remove(this._widgetContainer,this._css.resultsLoadingClass),q.remove(this._resultsNode,"esriRoutesContainerBusy"))},_enqueue:function(a,b){var c=new r;this._requestQueueTail||(this._requestQueueTail=new r,this._requestQueueTail.resolve());this._requestQueueTail.promise.always(f.hitch(this,function(){try{f.mixin(this,{_incrementalSolveStopRange:null},b);var d=a.call(this);d&&"object"===
typeof d&&d.hasOwnProperty("isFulfilled")?d.then(f.hitch(this,function(a){c.resolve(a);this._showLoadingSpinner()}),f.hitch(this,function(a){c.reject(a);this._showLoadingSpinner()})):(c.resolve(d),this._showLoadingSpinner())}catch(e){c.reject(e),this._showLoadingSpinner()}}));this._requestQueueTail=c;this._showLoadingSpinner();return c.promise},_createDnD:function(){this._dnd=new pa(this._dndNode,{skipForm:!0,withHandles:!0})},_destroyDnD:function(){v.empty(this._dndNode);this._dnd&&(this._dnd.destroy(),
this._dnd=null)},_createDepartAtControls:function(){if(this._departAtTime)this.map&&(this.map.timeExtent=null),this._useTrafficItemNode.title=m.widgets.directions.trafficLabelLive,q.remove(this._departAtContainer,"departAtContainerVisible"),this.startTime="now",this._updateStartTimeUI();else{var a=this,b=function(){this._keepDirections||a._clearDisplayBeforeSolve();this._keepDirections=!1};this._departAtTime=new la({required:!0,value:new Date,onChange:b},this._departAtTimeContainer);this._departAtDate=
new ka({required:!0,value:new Date,onChange:b,constraints:{min:new Date(864E5)}},this._departAtDateContainer)}},_setStartTime:function(a,b,c){if(isNaN(c))this.startTime="now";else{b=c instanceof Date?c:new Date(c);c=this.directions&&this.directions.features&&this.directions.features[0]&&this.directions.features[0].attributes;var d=6E4*-b.getTimezoneOffset();b=new Date(b-d+(c&&c.arriveTimeUTC?c.ETA-c.arriveTimeUTC:d));this._departAtTime._keepDirections=!a;this._departAtDate._keepDirections=!a;this._departAtTime.setValue(b);
this._departAtDate.setValue(b)}this._updateStartTimeUI()},_checkStartTimeUIAvailability:function(){var a=this._getImpedanceAttribute(),a=this._isTimeUnits(a?a.units:"");this._startTimeButtonNode.disabled=!a;q[!a?"add":"remove"].apply(this,[this._startTimeButtonNode,"startTimeMenuButtonDisabled"]);a||this.set("startTime","now")},_usingAGOL:function(a){a||(a=this.routeTaskUrl);return-1<a.search(/^(https?:)*\/\/*[^.]*\.arcgis\.com.*$/i)},_usingRouteAGOL:function(){return-1<this.get("routeTaskUrl").search(/^(https?:)*\/\/route*[^.]*\.arcgis\.com.*$/i)},
_setSearchOptions:function(){var a={map:this.get("map"),autoNavigate:!1,enableInfoWindow:!1,enableHighlight:!1,enableSourcesMenu:!1};this.searchOptions=f.mixin({maxResults:1,locationToAddressDistance:100},this.defaults.searchOptions,a)},_setDefaultUnits:function(){if(!this.get("directionsLengthUnits")){var a="EN-US"===V.locale.toUpperCase()?w.MILES:w.KILOMETERS;this.defaults.directionsLengthUnits?a=this.defaults.directionsLengthUnits:this.userOptions.routeParams&&this.userOptions.routeParams.directionsLengthUnits&&
(a=this.userOptions.routeParams.directionsLengthUnits);this.set("directionsLengthUnits",a)}this._setDirectionsLengthUnits(this.directionsLengthUnits)},_setTrafficOptions:function(){this._usingRouteAGOL()&&!this.trafficLayer&&(this.trafficLayer=new ua(R+"//traffic.arcgis.com/arcgis/rest/services/World/Traffic/MapServer",{opacity:0.4}));this.trafficLayer&&(this.trafficLayer.url&&this._usingAGOL(this.trafficLayer.url))&&(this._trafficAvailabilityButton.style.display="inline-block");this.set("showTrafficOption",
(this.defaults.showTrafficOption||!this.defaults.hasOwnProperty("showTrafficOption"))&&this.trafficLayer);this._optionsMenu()},_updateCanModifyStops:function(a,b){!this.canModifyStops&&!this.canModifyWaypoints&&this.set("mapClickActive",!1);!b&&(this.canModifyStops&&!this.canModifyWaypoints)&&this.set("mapClickActive",!0);this._showAddDestination();this._showMapClickActiveButton();this._stopsTableCover.style.display=this.canModifyStops?"none":"inline"},_updateCanAddWaypoints:function(a,b){!this.canModifyStops&&
!this.canModifyWaypoints&&this.set("mapClickActive",!1);!b&&(!this.canModifyStops&&this.canModifyWaypoints)&&this.set("mapClickActive",!0);this._showMapClickActiveButton();this._handle._remove()},_updateStartTimeUI:function(){isNaN(this.startTime)?(this._startTimeButtonNode.innerHTML=this._i18n.widgets.directions.leaveNow,q.remove(this._startTimeButtonNodeContainer,"departAtButton"),q.remove(this._departAtContainer,"departAtContainerVisible")):(q.add(this._startTimeButtonNodeContainer,"departAtButton"),
q.add(this._departAtContainer,"departAtContainerVisible"),this._startTimeButtonNode.innerHTML=this._i18n.widgets.directions.departAt)},_setWidgetProperties:function(){this._disconnectEvents();this.set(this.defaults);this.routeLayer=f.clone(this.defaults.routeLayer);this._folderSelector&&(this._outputLayer.setValue(""),this._outputLayer.set("disabled",!0),this._folderSelector.set("disabled",!0));this.set("stops",[]);this._updateCanModifyStops()},_updateStops:function(a){var b=new r;a?this.get("loaded")?
this._reset().then(f.hitch(this,function(){this._addStops(a).then(b.resolve,b.reject)}),b.reject):this._addStops(a).then(b.resolve,b.reject):b.reject();return b.promise},_removeStop:function(a,b,c,d){var e=new r,g=f.hitch(this,function(a){this.stops.splice(a,1);var b=this._dnd.getAllNodes()[a],c=this.get("geocoders");c[a].destroy();c.splice(a,1);this.set("geocoders",c);this._geocoderEvents[b.id]&&(this._geocoderEvents[b.id].blur.remove(),this._geocoderEvents[b.id].select.remove(),this._geocoderEvents[b.id].suggest.remove(),
this._geocoderEvents[b.id].value.unwatch());v.destroy(b);this._dnd.sync();this._stopsRemovable();this._optionsMenu();this._checkMaxStops();this.setListIcons();this._sortGeocoders()});if(0>a||a>=this.stops.length||void 0===a)a=this.stops.length-1;var h=!1;for(d=this.stopGraphics[a]&&this._isStopAWaypoint(this.stops[a])||d;!h;)g(a),d?h=!0:(a-=0>=a||a<this.stops.length&&this._isStopAWaypoint(this.stops[a])?0:1,h=!this._isStopAWaypoint(this.stops[a]));for(;this.stops.length-this._getWaypointCount()<this.minStops;)this._addStop();
this._setStops();this.createRouteSymbols();c?(this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve(),this.createRouteSymbols(),e.resolve()):this._solveAndZoom(b).then(e.resolve,e.reject);return e.promise},_removeTrafficLayer:function(){this.trafficLayer&&this.map&&this.map.removeLayer(this.trafficLayer);this._trafficLayerAdded=!1},_addStops:function(a,b){var c=new r,d=[],e=this.autoSolve;this.autoSolve=!1;void 0===b&&(b=this._getStopCount());for(var g=0;g<Math.min(a.length,this.maxStops-this._getStopCount());g++){var h=
new r;this._addStop(a[g],b+g,!0).always(h.resolve);d.push(h)}J(d).always(f.hitch(this,function(){this.autoSolve=e;this._getDirections().always(function(){c.resolve(a)})}));return c.promise},_addStop:function(a,b,c){var d=new r;this._checkMaxStops();this.maxStopsReached?(this._showMessage(m.widgets.directions.error.maximumStops),d.reject(Error(m.widgets.directions.error.maximumStops))):(void 0===a&&void 0===b&&(b=this.stops.length),a instanceof t&&a.attributes&&a.attributes.isWaypoint&&(!b||b===this.stops.length||
2>this._getStopCount())&&!c?(this._showMessage(m.widgets.directions.error.waypointShouldBeInBetweenStops),d.reject(Error(m.widgets.directions.error.waypointShouldBeInBetweenStops))):this._getCandidate(a).then(f.hitch(this,function(a){this._insertStop(a,b);this.autoSolve&&""!==a.name?this._getDirections().always(function(){d.resolve(a,b)}):d.resolve(a,b)}),f.hitch(this,function(a){d.reject(a)})));return d.promise},_removeEmptyStops:function(){for(var a=0,b=this.stops.length-this._getWaypointCount()-
this.minStops;a<this.stops.length&&0<b;)!this.stops[a]||!this.stops[a].name?(this._removeStop(a,!0,!0,!0),b--,this._moveInProgress&&(this._handle._index>=a&&this._handle._isStopIcon)&&this._handle._index--):a++},_setReverseGeocode:function(a,b,c){if(a.feature.geometry&&-1<c){var d={address:a.name};this.stopGraphics[c]&&(f.mixin(this.stopGraphics[c].attributes,d),this.stopGraphics[c].setGeometry(b));this.textGraphics[c]&&(f.mixin(this.textGraphics[c].attributes,d),this.textGraphics[c].setGeometry(b));
this.set("stopGraphics",this.stopGraphics);this.set("textGraphics",this.textGraphics);if((d=this.geocoders[c])&&d.inputNode)d.value=a.name,d.inputNode.value=a.name;f.mixin(a.feature.attributes,this.stops[c].feature.attributes);this.stops[c]=a;this.stops[c].feature.setGeometry(b);this._setStops();return this._enqueue(function(){return this._getDirections()})}},_insertStop:function(a,b){var c,d;if(void 0===b)for(c=0;c<this.geocoders.length;c++){if(!this.geocoders[c].get("value")){d=this.geocoders[c];
break}}else c=b,this.geocoders[c]&&!this.geocoders[c].get("value")&&(d=this.geocoders[c]);d&&(void 0===b||b===c)&&!this._isStopAWaypoint(a)?(this.stops[c]=a,d.set("value",a.name),d._stopReference=a):(void 0===b&&(b=this.geocoders.length),this.stops.splice(b,0,a),this._createGeocoder(a,b));this._optionsMenu()},_createGeocoder:function(a,b){var c=this._dnd.getAllNodes(),d=!1,e=!1,g=c.length;c[b]?(e=c[b],d=!0):d=e=!1;var h=f.hitch(this,function(a,b){var c=b?this._css.stopDnDHandleClass:this._css.stopDnDHandleClassHidden,
d=b?this._css.stopDnDHandleClassHidden:this._css.stopDnDHandleClass;q.replace(a.children[0],c,d);2<this.geocoders.length&&(c=b?this._css.stopIconRemoveClass:this._css.stopIconRemoveClassHidden,d=b?this._css.stopIconRemoveClassHidden:this._css.stopIconRemoveClass,q.replace(a.children[3].children[0],c,d))}),n=v.create("tr",{className:this._css.stopClass,style:this._isStopAWaypoint(a)?"display:none;":"",onmouseover:function(){h(this,!0)},onmouseout:function(){h(this,!1)}});v.create("td",{className:this._css.stopDnDHandleClassHidden+
" dojoDndHandle"},n);c=v.create("td",{className:this._css.stopIconColumnClass},n);v.create("div",{className:this._css.stopIconClass+" dojoDndHandle",innerHTML:this._getLetter(g),"data-center-at":"true"},c);g=v.create("td",{className:this._css.esriStopGeocoderColumnClass},n);g=v.create("div",{},g);c=v.create("td",{className:this._css.stopIconRemoveColumnClass},n);v.create("div",{className:this._css.stopIconRemoveClassHidden,role:"button","data-remove":"true"},c);this._dnd.insertNodes(!1,[n],d,e);var d=
f.mixin({},this.get("searchOptions"),{value:a.name,activeSourceIndex:this._globalGeocoder.activeSourceIndex}),k=new fa(d,g),A=f.hitch(this,function(a,b){this._enqueue(function(){if(b!==a&&k._stopReference&&k._stopReference.name!==b){var c=x.indexOf(this.stops,k._stopReference);this.stops[c]={name:b};this._handle._remove();this._removeSomeWaypoints(this._markWPsForRemovalAfterUserChangedStopSequence(c));this._setStops();this._clearDisplayBeforeSolve();this._clearDisplayAfterSolve();this.createRouteSymbols()}})});
k._tr=n;k._stopReference=a;k.startup();this.geocoders.splice(b,0,k);this._geocoderEvents[n.id]={blur:k.on("blur",function(){""!==this.value&&(this._stopReference&&!this._stopReference.feature)&&this.search()}),select:k.on("select-result",f.hitch(this,function(a){var b=!0;if(a&&(a.results||a.result)){var c=this._dnd.getAllNodes(),c=x.indexOf(c,n),d=k.value,e=a.results&&a.results.results&&a.results.results.length?a.results.results[0]:a.result;e?(e.name=d,this.stops[c]=this._toPointGeometry(e),this.geocoders[c]._stopReference=
this.stops[c],A("",d)):(this.removeStop(c),this.set("directions",null),this._showMessage(m.widgets.directions.error.unknownStop.replace("\x3cname\x3e",a.target.get("value"))),this._clearRouteGraphics(),b=!1);b&&this.getDirections()}})),suggest:k.on("suggest-results",function(){if(document.activeElement===this.inputNode)for(var a=I("LI[role\x3d'menuitem']",this.suggestionsNode),b=0;b<a.length;b++)F.set(a[b],"tabindex",-1);else this._hideSuggestionsMenu()}),value:k.watch("value",function(a,b,c){A(b,
c)})};this._checkMaxStops();this.setListIcons();this._stopsRemovable();this._optionsMenu();this._sortGeocoders()},_blurGeocoders:function(){if(document.activeElement)for(var a=0;a<this.geocoders.length;a++)if(this.geocoders[a].inputNode===document.activeElement){this.geocoders[a]._hideSuggestionsMenu();this.geocoders[a].inputNode.blur();1<this._getStopCount()+this._getWaypointCount()&&this.getDirections(!0);break}},_decorateEmptyAGOLGeocoderResponse:function(a){a&&", , "===a.name&&(a.name=a.feature&&
a.feature.attributes&&a.feature.attributes.Match_addr?a.feature.attributes.Match_addr+("POI"===a.feature.attributes.Addr_type&&a.feature.attributes.City&&-1===a.feature.attributes.Match_addr.indexOf(a.feature.attributes.City)?", "+a.feature.attributes.City:""):"");return a},_toPointGeometry:function(a){var b=a.feature.geometry;if(b)if(b.getCentroid)a.feature.geometry=b.getCentroid();else if(b.getExtent&&(b=b.getExtent()))a.feature.geometry=b.getCenter();return a},_removeLocateButtonVisibilityEvents:function(){for(var a=
0;a<this.geocoders.length;a++){var b=this.geocoders[a];b._onMouseEnter&&b._onMouseEnter.remove();b._onMouseOut&&b._onMouseOut.remove();b._onKeyPress&&b._onKeyPress.remove();b._locateButton&&(b._locateButton._onMouseEnter&&b._locateButton._onMouseEnter.remove(),b._locateButton._onMouseOut&&b._locateButton._onMouseOut.remove())}},_setLocateButtonVisibilityEvents:function(){this._removeLocateButtonVisibilityEvents();for(var a=this,b=function(b){b instanceof FocusEvent?this._geocoder._lbShown_f=!0:this._geocoder._lbShown_g=
!0;a._createLocateButton(this._geocoder,!0)},c=function(b){b instanceof FocusEvent?this._geocoder._lbShown_f=!1:this._geocoder._lbShown_g=!1;clearTimeout(this._destroyTimeout);this._destroyTimeout=setTimeout(f.hitch(this,function(){!this._geocoder._lbShown_lb&&!this._geocoder._lbShown_f&&a._destroyLocateButton(this._locateButton)}),400)},d=function(){this._geocoder._lbShown_g=!0;clearTimeout(this._destroyTimeout);this._destroyTimeout=setTimeout(f.hitch(this,function(){""===this.value?a._createLocateButton(this._geocoder,
!0):a._destroyLocateButton(this._locateButton)}),400)},e=function(){this._geocoder._lbShown_lb=!0;clearTimeout(this._geocoder._destroyTimeout)},g=function(){this._geocoder._lbShown_lb=!1;clearTimeout(this._geocoder._destroyTimeout);this._geocoder._destroyTimeout=setTimeout(f.hitch(this,function(){!this._geocoder._lbShown_g&&!this._geocoder._lbShown_f&&a._destroyLocateButton(this._geocoder.inputNode._locateButton)}),400)},h=0;h<this.geocoders.length;h++){var n=this.geocoders[h];n&&n.inputNode&&(n.inputNode._geocoder=
n,n._onMouseEnter=l(n.inputNode,P.enter,b),n._onMouseOut=l(n.inputNode,[P.leave,"blur"],c),n._onKeyPress=l(n.inputNode,"keydown",d),n.inputNode._locateButton&&(n=n.inputNode._locateButton,n._onMouseEnter=l(n.domNode,P.enter,e),n._onMouseOut=l(n.domNode,P.leave,g)))}},_createLocateButton:function(a,b,c){var d=new r;a.inputNode._locateButton&&a.inputNode._locateButton._locating?d.resolve():E(["./LocateButton"],f.hitch(this,function(e){this._destroyLocateButton(a.inputNode._locateButton);if(a&&!this._solveInProgress){var g=
v.create("div",{},a.domNode);q.add(a.domNode,this._css.stopsInnerGeocoderClass);var h=new e({map:this.map,highlightLocation:!1,centerAt:!1,setScale:!1,useTracking:!1},g);h.startup();a.inputNode._locateButton=h;h.domNode._geocoder=a;this._setLocateButtonVisibilityEvents();e=f.hitch(this,function(){h._locating=!0;a.set("value","");a.inputNode.placeholder=m.widgets.directions.retrievingMyLocation.toUpperCase()});h._onBeforeLocate=l(h._locateNode,B,e);h._onLocate=l(h,"locate",f.hitch(this,function(c){h._locating=
!1;c.graphic?(b&&this._destroyLocateButton(a.inputNode._locateButton),this.updateStop(new t(c.graphic.geometry),x.indexOf(this.geocoders,a)).then(f.hitch(this,function(){1<this.stopGraphics.length?this.getDirections().always(function(){d.resolve(c)}):d.resolve(c)}))):(a.set("value",""),a.inputNode.placeholder=m.widgets.directions.myLocationError.toUpperCase(),console.error(c.error),d.reject(c.error))}));c?(e(),h.locate().then(null,d.reject)):d.resolve()}else d.resolve()}));return d.promise},_destroyLocateButton:function(a){if(a){var b=
a.domNode._geocoder;clearTimeout(b._destroyTimeout);a._locating?b._destroyTimeout=setTimeout(f.hitch(this,function(){!b._lbShown_lb&&!b._lbShown_f&&this._destroyLocateButton(a)}),100):(a.clear(),a._onBeforeLocate.remove(),a._onLocate.remove(),a._onMouseEnter&&a._onMouseEnter.remove(),a._onMouseOut&&a._onMouseOut.remove(),a.destroy(),b.inputNode&&(b.inputNode._locateButton=null,b._setPlaceholder(b.activeSourceIndex)))}},_sortStops:function(){this.stops.length&&(this.stops.sort(f.hitch(this,function(a,
b){for(var c,d,e=0;e<this.get("geocoders").length;e++)this.geocoders[e]._stopReference===a?c=e:this.geocoders[e]._stopReference===b&&(d=e);return c>d?1:d>c?-1:0})),this._setStops())},_getCandidate:function(a){var b=new r,c=typeof a;a?"object"===c&&a.hasOwnProperty("feature")&&a.hasOwnProperty("name")?(a.feature.attributes&&(void 0!==a.feature.attributes.displayName&&!this._isStopAWaypoint(a))&&(a.name=a.feature.attributes.displayName,a.feature.attributes.Name=this._userDefinedStopName),a.name=this._isStopAWaypoint(a)?
this._waypointName:String(a.name),"point"!==a.feature.geometry.type&&(a.feature.geometry=new X([a.feature.geometry.x,a.feature.geometry.y],this.map.spatialReference)),b.resolve(a)):"object"===c&&a.hasOwnProperty("address")&&a.hasOwnProperty("location")?(a=this._globalGeocoder._hydrateResult(a),b.resolve(a)):"object"===c&&a.hasOwnProperty("name")&&(null===a.name||""===a.name)?b.resolve(f.clone(this._emptyStop)):a instanceof t&&a.attributes&&(void 0!==a.attributes.Name||a.attributes.isWaypoint)?(c=
this._addStopWrapperToGraphic(a,a.attributes.isWaypoint?this._waypointName:String(a.attributes.Name)),String(a.attributes.Name)&&(c.feature.attributes.Name=this._userDefinedStopName),b.resolve(c)):("object"===c&&a.hasOwnProperty("name")&&(a=String(a.name)),this._reverseGeocode(a).then(b.resolve,b.reject)):b.resolve(f.clone(this._emptyStop));return b.promise},_reverseGeocode:function(a){var b=new r,c,d=a.geometry?a.geometry:a;if(this._globalGeocoder){var e=f.hitch(this,function(a){var b=new r,c=500;
if(this.map){var e=this.map.toScreen(d);e.x+=wa._calculateClickTolerance([a]);this.map.spatialReference.isWebMercator()?(c=Math.abs(this.map.toMap(e).x-d.x),b.resolve(c)):4326===this.map.spatialReference.wkid?(c=Math.abs(T.geographicToWebMercator(this.map.toMap(e)).x-T.geographicToWebMercator(d).x),b.resolve(c)):this._geometryService&&(a=new Da,a.distanceUnit=da.UNIT_METER,a.geometry1=d,a.geometry2=this.map.toMap(e),this._geometryService.distance(a,function(a){c=a;b.resolve(c)},function(){b.resolve(c)}))}return b.promise}),
g=[],h=this._globalGeocoder.sources,n=function(){h[c].featureLayer&&g.push(e(h[c].featureLayer).then(f.hitch(h[c],function(a){this.searchQueryParams=f.mixin(this.searchQueryParams,{distance:a})})))};if("all"===this._globalGeocoder.activeSourceIndex)for(c=0;c<h.length;c++)n();else c=this._globalGeocoder.activeSourceIndex,n();J(g).always(f.hitch(this,function(){this._globalGeocoder.search(d).then(f.hitch(this,function(e){var g=!1;if(e){var h=null,f;for(c=0;c<this._globalGeocoder.sources.length;c++)if(e[c]&&
e[c].length){f=e[c];break}if(f.length&&(g=!0,h=f[0],this._globalGeocoder.sources[c].featureLayer)){e=Number.POSITIVE_INFINITY;for(c=0;c<f.length;c++){f[c]=this._toPointGeometry(f[c]);var n=va.geodesicLengths([new ba({paths:[[T.xyToLngLat(d.x,d.y),T.xyToLngLat(f[c].feature.geometry.x,f[c].feature.geometry.y)]],spatialReference:{wkid:this.map.spatialReference.wkid}})],"esriMeters")[0];e>n&&(e=n,h=f[c])}}(h=this._decorateEmptyAGOLGeocoderResponse(h))&&""!==h.name&&null!==h.name&&void 0!==h.name?(h.name=
String(h.name),!isNaN(d.x)&&!isNaN(d.y)&&this.map.spatialReference.wkid===d.spatialReference.wkid?(h.feature.geometry=d,b.resolve(h)):!h.feature.geometry||isNaN(h.feature.geometry.x)||isNaN(h.feature.geometry.y)?(this._showMessage(m.widgets.directions.error.locator),b.reject(Error(m.widgets.directions.error.locator))):b.resolve(h)):g=!1}g||(a instanceof X?a=new t(a):a instanceof Array&&(a=new t(new X(a[0],a[1]))),a instanceof t?this._decorateUngeocodedStop(a).then(b.resolve,b.reject):(this._showMessage(m.widgets.directions.error.unknownStop.replace("\x3cname\x3e",
a.toString())),b.reject(Error(m.widgets.directions.error.unknownStop.replace("\x3cname\x3e",a.toString())))))}))}))}else this._showMessage(m.widgets.directions.error.locatorUndefined),b.reject(Error(m.widgets.directions.error.locatorUndefined));return b.promise},_updateStop:function(a,b,c){var d=new r;this.stops&&this.stops[b]?a instanceof t&&a.attributes&&a.attributes.isWaypoint&&(!b||b===this.stops.length-1||2>this._getStopCount())?(this._showMessage(m.widgets.directions.error.waypointShouldBeInBetweenStops),
d.reject(Error(m.widgets.directions.error.waypointShouldBeInBetweenStops))):this._getCandidate(a).then(f.hitch(this,function(a){var g=a.feature,g=g?g.geometry:null,h=this.stops[b].feature,h=h?h.geometry:null,g=g&&h&&(g.x!==h.x||g.y!==h.y)||!g&&h;this.stops[b]=a;this.geocoders[b]||this._createGeocoder(a,b);h=this.geocoders[b];h._stopReference=a;h._tr.style.display=this._isStopAWaypoint(a)?"none":"";h.value=a.name;h.inputNode&&(h.inputNode.value=a.name);g&&this.autoSolve&&1<this._getStopCount()+this._getWaypointCount()||
c?this._getDirections().then(d.resolve,d.reject):(this._setStops(),d.resolve(a))}),f.hitch(this,function(a){d.reject(a)})):(this._showMessage(m.widgets.directions.error.couldNotUpdateStop),d.reject(Error(m.widgets.directions.error.couldNotUpdateStop)));this._optionsMenu();return d.promise},_renderDirections:function(){var a=this.get("directions"),b;this._resultsNode&&(b=""+('\x3cdiv class\x3d"'+this._css.clearClass+'"\x3e\x3c/div\x3e'),b+=this._renderDirectionsSummary(a),b+='\x3cdiv class\x3d"'+this._css.clearClass+
'"\x3e\x3c/div\x3e',b+='\x3cdiv class\x3d"'+this._css.routesClass+'"\x3e',b+=this._renderDirectionsTable(a),b+="\x3cdiv class\x3d'esriPrintFooter'\x3e"+m.widgets.directions.printDisclaimer+"\x3c/div\x3e",b+="\x3c/div\x3e",this._resultsNode&&(this._resultsNode.innerHTML=b),this._disconnectResults(),(a=I("[data-segment]",this._resultsNode))&&a.length&&x.forEach(a,f.hitch(this,function(a){this._resultEvents.push(l(a,P.enter,f.hitch(this,function(){if(!this._focusedDirectionsItem){var b=parseInt(F.get(a,
"data-segment"),10);this.highlightSegment(b)}})));this._resultEvents.push(l(a,"focusout",f.hitch(this,function(){this._focusedDirectionsItem=null;this.unhighlightSegment(!0)})));this._resultEvents.push(l(a,P.leave,this.unhighlightSegment));this._resultEvents.push(l(a,"click, keydown",f.hitch(this,function(b){if(b&&("click"===b.type||"keydown"===b.type&&b.keyCode===O.ENTER))this._focusedDirectionsItem!==a?this.selectSegment(parseInt(F.get(a,"data-segment"),10)):(a.blur(),this.map.infoWindow.hide(),
this._focusedDirectionsItem=null,this.unhighlightSegment(!0))})))})))},_renderDirectionsSummary:function(a){var b="";if(a.totalLength||a.totalTime){var c={},d=this._getImpedanceAttribute(),b=b+("\x3cdiv class\x3d'"+this._css.resultsSummaryClass+"' data-full-route\x3d'true'\x3e\x3cdiv class\x3d'esriImpedanceCost'\x3e");if(this._isTimeUnits(d.units)){for(var e=this._getCostAttribute(d.timeNeutralAttributeName)||{},g=0,h=0,f=this.get("stops"),k=f.length-1;0<=k;k--)if(null!==f[k].feature.attributes.ArriveCurbApproach){c=
f[k].feature.attributes;break}for(var A in c)c.hasOwnProperty(A)&&(A==="Cumul_"+d.name&&(g=c[A]),A==="Cumul_"+e.name&&(h=c[A]));c="esriTrafficLabelHidden";f=m.widgets.directions.noTraffic;k=a.totalTime-a.totalDriveTime;k=(h-this._convertCostValue(k,d.units,e.units))/(g-k||1);0<k&&0.8>k?(c="esriTrafficLabelHeavy",f=m.widgets.directions.heavyTraffic):1===k?(c="esriTrafficLabelNone",f=m.widgets.directions.noTraffic):1.25<k&&(c="esriTrafficLabelLight",f=m.widgets.directions.ligthTraffic);e=this._formatTime(h,
!1,e.units);b+=this._formatTime(g,!0,d.units)+"\x3cdiv class\x3d'esriImpedanceCostHrMin'\x3e\x3cdiv class\x3d'esriImpedanceCostHr'\x3e"+m.widgets.directions.time.hr+"\x3c/div\x3e\x3cdiv class\x3d'esriImpedanceCostMin'\x3e"+m.widgets.directions.time.min+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d'esriOtherCosts'\x3e"+(h?"\x3cdiv class\x3d'esriTrafficLabel "+c+"'\x3e"+f+"\x3c/div\x3e"+(1!==k&&e?e+" "+m.widgets.directions.onAverage+"\x3cbr\x3e":""):"")+this._formatDistance(a.totalLength)}else d=
(d=m.widgets.directions.units[this.directionsLengthUnits])?d.name:"",b+=N.format(a.totalLength,{places:1})+"\x3cdiv class\x3d'esriImpedanceCostDist'\x3e"+d+"\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d'esriOtherCosts'\x3e"+this._formatTime(a.totalTime);b+="\x3c/div\x3e\x3c/div\x3e"}return b},_renderDirectionsTable:function(a){for(var b=0,c=0,d=0,e='\x3ctable summary\x3d"'+a.routeName+'"\x3e\x3ctbody role\x3d"menu"\x3e',g=0;g<a.features.length;g++){var h=a.features[g].attributes;"esriDMTDepart"===h.maneuverType&&
(c=d=0);d+=h.length;c+=h.time;b+=h.time;e+=this._renderDirectionsItemTR(a.features[g],d,c,b)}return e+"\x3c/tbody\x3e\x3c/table\x3e"},_renderDirectionsItemTR:function(a,b,c,d){var e=this.directions,g=e?x.indexOf(e.features,a):-1;d="";var h=this._css.routeClass,f=a._associatedStopWithReturnToStart&&a._associatedStopWithReturnToStart.attributes,k=a.attributes;if(-1<g){k&&(k.step=g+1);k.maneuverType&&(h+=" "+k.maneuverType);f&&null===f.ArriveCurbApproach&&null!==f.DepartCurbApproach?h+=" "+this._css.routeOriginClass:
f&&(null!==f.ArriveCurbApproach&&null===f.DepartCurbApproach)&&(h+=" "+this._css.routeDestinationClass+" "+this._css.routeLastClass);d+='\x3ctr tabindex\x3d"0" role\x3d"menuitem" class\x3d"'+h+" "+this._css.routeZoomClass+'" data-segment\x3d"'+g+'"\x3e';d+='\x3ctd class\x3d"'+this._css.routeIconColumnClass+'"\x3e';d+='\x3cdiv class\x3d"'+this._css.routeIconClass+'"\x3e';d+=this._getLetter(a._associatedStop);d+="\x3c/div\x3e\x3c/td\x3e";d+='\x3ctd class\x3d"'+this._css.routeTextColumnClass+'"\x3e';
d+='\x3cdiv class\x3d"'+this._css.routeInfoClass+'"\x3e';d+='\x3cdiv class\x3d"'+this._css.routeTextClass+'"\x3e';a=(e.strings[g]||[]).slice();if("esriDMTDepart"===k.maneuverType||"esriDMTStop"===k.maneuverType)for(e=0;e<this.stops.length;e++)this.stops[e]&&this.stops[e].name&&a.push({string:this.stops[e].name});if(a){h=k.text;for(e=0;e<a.length;e++)h=this._boldText(h,a[e].string);k.formattedText=h}else k.formattedText=k.text;if("esriDMTStop"===k.maneuverType&&(b||c)||"esriDMTDepart"===k.maneuverType&&
0===g)b=this._formatDistance(b-k.length,!0),c=this._formatTime(c-k.time),g=this._formatTime(k.time),a=this._formatDistance(k.length,!0),k.formattedText+="\x3cdiv class\x3d'esriRouteTextColumnCumulative'\x3e"+b+(b&&c?" \x26middot; ":"")+c+(b||c?"\x3cbr\x3e":"")+(g?m.widgets.directions.serviceTime+":\x26nbsp;"+g:"")+(g&&a?"\x3cbr\x3e":"")+(a?m.widgets.directions.serviceDistance+":\x26nbsp;"+a:"")+"\x3c/div\x3e";d+="\x3cstrong\x3e"+N.format(k.step)+".\x3c/strong\x3e "+k.formattedText;d+="\x3c/div\x3e";
b=this._formatDistance(k.length,!0);c=this._formatTime(k.time);("esriDMTStop"===k.maneuverType||"esriDMTDepart"===k.maneuverType)&&this.routeParams.startTime&&-22091616E5!==k.ETA?d+='\x3cdiv class\x3d"'+this._css.routeLengthClass+'"\x3e'+this._toSpatiallyLocalTimeString(k.arriveTimeUTC,k.ETA)+"\x3c/div\x3e":b&&(d+='\x3cdiv class\x3d"'+this._css.routeLengthClass+'"\x3e',d+=b,c&&(d+="\x26nbsp;\x26middot;\x3cwbr\x3e\x26nbsp;"+c),d+="\x3c/div\x3e");d+="\x3c/div\x3e";d+="\x3c/td\x3e";d+="\x3c/tr\x3e"}return d},
_toSpatiallyLocalTimeString:function(a,b){var c=new Date(b),d=new Date(c.getTime()+6E4*c.getTimezoneOffset()),d=V.date.locale.format(d,{selector:"time"}),e="";a?(e=(b-a)/1E3/60/60,c=Math.floor(e),e=60*(e-c),c=m.widgets.directions.GMT+(0>c?"":"+")+N.format(c,{pattern:"00"})+N.format(e,{pattern:"00"}),e=d+" "+c):e="now"===this.startTime?V.date.locale.format(c,{selector:"time"}):d;return e},_addStopWrapperToGraphic:function(a,b){return{extent:new xa({xmin:a.geometry.x-0.25,ymin:a.geometry.y-0.25,xmax:a.geometry.x+
0.25,ymax:a.geometry.y+0.25,spatialReference:a.geometry.spatialReference}),feature:a,name:b}},_clearBarriersGraphics:function(){this._barriersLayer.clear();this._polylineBarriersLayer.clear();this._polygonBarriersLayer.clear()},_showBarriers:function(){this._clearBarriersGraphics();var a=this.routeParams,b=a.polylineBarriers&&a.polylineBarriers.features||[],c=a.polygonBarriers&&a.polygonBarriers.features||[];x.forEach(a.barriers&&a.barriers.features||[],f.hitch(this,function(a){this._barriersLayer.add(a)}));
x.forEach(b,f.hitch(this,function(a){this._polylineBarriersLayer.add(a)}));x.forEach(c,f.hitch(this,function(a){this._polygonBarriersLayer.add(a)}))},_showRoute:function(a){this._clearDisplayAfterSolve();var b=a.routeResults[0].directions,c=new r;if(b){this.set("solveResult",a);this.set("directions",b);var d=a.routeResults[0].stops,e,g;if(d&&d.length){var h=[];for(e=0;e<d.length;e++){var f=d[e];f.attributes.isWaypoint=f.attributes.Name===this._waypointName||f.attributes.isWaypoint;f=this._addStopWrapperToGraphic(f,
f.attributes.Name);this.stops[e]&&(this.stops[e].feature&&this.stops[e].feature.attributes&&this.stops[e].feature.attributes.Name===this._userDefinedStopName)&&(f.feature.attributes.Name=this._userDefinedStopName);this._returnToStartStop&&this._returnToStartStop._resultsStopIndex===e?this._returnToStartStop=f:h.push(f)}if(this.stops.length>h.length)for(e=0;e<this.stops.length;e++)!this.stops[e].feature&&""===this.stops[e].name&&h.splice(e,0,this._emptyStop);this.stops=h;for(e=0;e<this.stops.length;e++)this._updateStop(this.stops[e],
e);this._setStops();this._setMenuNodeValues()}this.set("mergedRouteGraphic",new t(b.mergedGeometry,this.get("routeSymbol")));d=[];h=[];for(e=f=0;e<b.featuresWithWaypoints.length;e++){var k=b.featuresWithWaypoints[e];if("esriDMTDepart"===k.attributes.maneuverType)for(g=0;g<this.stops.length;g++)if(this.stops[g].feature===k._associatedStop){f=g+1;break}k.setSymbol(this.get("routeSymbol"));this._routeLayer.add(k);d.push(k);(g=k.getDojoShape())&&g.moveToBack();g=new t(k.geometry,this._symbolEventPaddingDirections,
k.attributes);g._nextStopIndex=f-0.5;g._isSnapFeature=!0;k._associatedSnapFeature=g;this._waypointsEventLayer.add(g);if("esriDMTDepart"!==k.attributes.maneuverType&&(g=k.geometry.getPoint(0,0)))g=new t(g,this.maneuverSymbol),g._directionsFeature=k._associatedFeatureNoWaypoints,h.push(g),this._waypointsEventLayer.add(h[h.length-1])}this.set("displayedRouteGraphics",d);this.set("displayedManeuverPointGraphics",h);this._renderDirections();for(e=0;e<this.stops.length;e++)if(this._isStopAWaypoint(this.stops[e])&&
this._modifiedWaypointIndex===e){for(g=0;g<b.featuresWithWaypoints.length;g++)if(d=b.featuresWithWaypoints[g],d._associatedStop===this.stops[e].feature){if("esriDMTStop"===d.attributes.maneuverType||"esriDMTDepart"===d.attributes.maneuverType)this.stops[e].feature.geometry.x=d.geometry.paths[0][0][0],this.stops[e].feature.geometry.y=d.geometry.paths[0][0][1];break}this._modifiedWaypointIndex=null;break}u.set(this._savePrintBtnContainer,"display","inline-block");this.onDirectionsFinish(a)}else a=a.routeResults[0].route,
a.setSymbol(this.routeSymbol),this._routeLayer.add(a),this._incrementalRouteSegment=a;c.resolve();this._moveLayersToFront();this.createRouteSymbols();return c.promise},_setGeocodersStopReference:function(){if(this.geocoders)for(var a=0;a<this.geocoders.length;a++)this.geocoders[a]&&this.stops[a]&&(this.geocoders[a]._stopReference=this.stops[a])},_setStops:function(){this._setGeocodersStopReference();this.createRouteSymbols();this._set("stops",this.stops);this.onStopsUpdate(this.stops)},_getCandidates:function(a){var b=
[];if(a&&a.length){for(var c=0;c<a.length;c++)b.push(this._getCandidate(a[c]));return J(b)}a=new r;a.resolve([]);return a.promise},_clearResultsHTML:function(){this._resultsNode.innerHTML="";u.set(this._savePrintBtnContainer,"display","none")},_showSegmentPopup:function(a){if(a&&this.get("showSegmentPopup")&&this.get("map").infoWindow){var b=a.geometry.getPoint(0,0);a=new t(b,null,a.attributes,this.get("segmentInfoTemplate"));var c=this.get("map").infoWindow;c.setFeatures([a]);c.show(b)}},_addStopButton:function(){this.addStop().then(f.hitch(this,
function(){this.get("focusOnNewStop")&&this.geocoders[this.stops.length-1].focus()}))},_sortGeocoders:function(){var a=this._dnd.getAllNodes();this.geocoders.sort(f.hitch(this,function(b,d){return!b.domNode||!b.domNode.parentNode||!b.domNode.parentNode.parentNode||!d.domNode||!d.domNode.parentNode||!d.domNode.parentNode.parentNode?0:x.indexOf(a,b.domNode.parentNode.parentNode)>x.indexOf(a,d.domNode.parentNode.parentNode)?1:-1}));this.stops.length===this.geocoders.length&&this._sortStops();for(var b=
0;b<this.geocoders.length;b++)this.geocoders[b]&&this.geocoders[b].inputNode&&(this.geocoders[b].inputNode.title=m.widgets.directions.stopNoTitle+(b+1));this._setLocateButtonVisibilityEvents()},_disconnectResults:function(){if(this._resultEvents&&this._resultEvents.length)for(var a=0;a<this._resultEvents.length;a++)this._resultEvents[a]&&this._resultEvents[a].remove();this._resultEvents=[]},_formatArbitraryCostsForRouteTooltip:function(a){var b="",c;for(c in a)if(0===c.indexOf("Total_")&&a.hasOwnProperty(c)){var d=
this._getCostAttribute(c.substr(6));d&&(b+=this._isTimeUnits(d.units)?this._formatTime(a[c],!1,d.units):this._formatDistance(a[c],!0,d.units),b+=b?" \x26middot; ":"")}b&&(b=m.widgets.directions.toNearbyStops+": \x3cb\x3e"+b.substr(0,b.length-10)+"\x3c/b\x3e");return b},_formatTime:function(a,b,c){c||(c=(this._getDirectionsTimeAttribute()||{}).units);var d="";c=Math.round(this._convertCostValue(a,c,"esriNAUMinutes"));a=Math.floor(c/60);c=Math.floor(c%60);b?d=N.format(a,{pattern:"00"})+":"+N.format(c,
{pattern:"00"}):(a&&(d+=a+" "+m.widgets.directions.time.hr+" "),d+=a||c?c+" "+m.widgets.directions.time.min:"");return d},_formatDistance:function(a,b,c){c||(c=this.directionsLengthUnits);var d=this.directionsLengthUnits,e=m.widgets.directions.units[d],g=d.replace("esri","").toLowerCase();a=this._convertCostValue(a,c,d);e&&(g=b?e.abbr:e.name);return a?N.format(a,{locale:"root",places:2})+" "+g:""},_editToolbar:function(){this.set("editToolbar",new ha(this.get("map")))},_destroyGlobalGeocoder:function(){this._globalGeocoder&&
(this._globalGeocoder.destroy(),this._globalGeocoder=null)},_createGlobalGeocoder:function(){var a=new r;this._globalGeocoder=new fa(this.get("searchOptions"));l.once(this._globalGeocoder,"load",f.hitch(this,function(){for(var b=0;b<this._globalGeocoder.sources.length;b++){var c=this._globalGeocoder.sources[b].locator;if(c&&c.url&&(-1<c.url.toUpperCase().indexOf(this._globalGeocoder.defaultSource.locator.url.toUpperCase())||-1<c.url.toUpperCase().indexOf("//GEOCODEDEV.ARCGIS.COM/ARCGIS/REST/SERVICES/WORLD/GEOCODESERVER"))&&
!this._globalGeocoder.sources[b].searchTemplate){this._globalGeocoder.sources[b].searchTemplate="${Address}, ${City}, ${Region}";break}}a.resolve()},function(b){a.reject(b)}));this._globalGeocoder.startup();return a.promise},_init:function(){var a=new r;this.set("loaded",!1);this._enableButton(this._getDirectionsButtonNode,!1);u.set(this._saveAsButton,"display","none");this.clearMessages();if(this.get("map").loaded)this._configure().always(a.resolve);else l.once(this.get("map"),"load",f.hitch(this,
function(){this._configure().always(a.resolve)}));return a.promise},_setDefaultStops:function(){var a=new r;this.defaults.stops&&this.defaults.stops.length?this._updateStops(this.defaults.stops).then(f.hitch(this,function(){this._removeEmptyStops();a.resolve()}),a.reject):a.resolve();return a.promise},_configure:function(){var a=new r;this._handle&&this._handle._remove();this._createDnD();this._createDepartAtControls();this._setSearchOptions();this._createGlobalGeocoder().then(f.hitch(this,function(){this._editToolbar();
this._usingAGOL()||(this.printTaskUrl=this.geometryTaskUrl=null);this._createGeometryTask();this._createPrintTask();this._showActivateButton();this._createTravelModesDDL();this._createSearchSourceDDL();var b=[this._createRouteTask(),this._setDefaultStops()];J(b).then(f.hitch(this,function(){this._setDefaultUnits();this._setTrafficOptions();this._setMenuNodeValues();this._setupEvents();var b=this.directionsLanguage||this.userOptions.routeParams&&this.userOptions.routeParams.directionsLanguage||V.locale.toLowerCase();
this._setDirectionsLanguageByLocale(b);this._setupTravelModes().then(f.hitch(this,function(){this.set("loaded",!0);this.onLoad();a.resolve(!0)}),function(b){a.reject(b)})}),function(b){a.reject(b)})}),function(b){a.reject(b)});this._naRouteSharing=null;return a.promise},_setDirectionsLanguageByLocale:function(a){var b=this.serviceDescription.directionsSupportedLanguages,c=function(a){if(b)for(var c=0;c<b.length;c++)if(b[c].toLowerCase().substr(0,2)===a)return b[c];return null},d=c(a);d||(a=a.substr(0,
2),d=c(a));this.directionsLanguage=d;return this.routeParams.directionsLanguage=d},_getStopSymbol:function(a,b){var c=a&&(a.feature&&a.feature.attributes||a.attributes),d=this.stopSymbol;c&&(d=this._isStopAWaypoint(a)?this.waypointSymbol:void 0===c.Status||0===c.Status||6===c.Status?null===c.ArriveCurbApproach&&null!==c.DepartCurbApproach?this.get(b?"fromSymbolDrag":"fromSymbol"):null!==c.ArriveCurbApproach&&null===c.DepartCurbApproach?this.get(b?"toSymbolDrag":"toSymbol"):this.get(b?"stopSymbolDrag":
"stopSymbol"):this.get(b?"unreachedSymbolDrag":"unreachedSymbol"));return d},_addTrafficLayer:function(){this.trafficLayer&&(!this._trafficLayerAdded&&this.map)&&(this.map.addLayer(this.trafficLayer),this.trafficLayer.show(),this._trafficLayerAdded=!0)},_toggleUnits:function(a){a.target===this._useMilesNode?this.setDirectionsLengthUnits(w.MILES):a.target===this._useKilometersNode&&this.setDirectionsLengthUnits(w.KILOMETERS)},_toggleCheckbox:function(a){var b=F.get(a.target,"checked");a.target===this._findOptimalOrderNode?
this.set("optimalRoute",b):a.target===this._useTrafficNode?this.set("traffic",b):a.target===this._returnToStartNode&&this.set("returnToStart",b)},_isStopLocated:function(a){return a&&a.feature&&a.feature.attributes&&(!a.feature.attributes.Status||6===a.feature.attributes.Status)},_configureRouteOptions:function(){var a=this.get("routeParams"),b;this.get("directionsLengthUnits")?a.directionsLengthUnits=this.get("directionsLengthUnits"):this.set("directionsLengthUnits",a.directionsLengthUnits);a.findBestSequence=
this.get("optimalRoute");if(a.findBestSequence){a.preserveFirstStop=this._isStopLocated(this.stops[0]);a.preserveLastStop=!this.returnToStart&&this._isStopLocated(this.stops[this.stops.length-1])||this.returnToStart&&this._isStopLocated(this.stops[0]);for(b=0;b<this.stops.length;)this._isStopAWaypoint(this.stops[b])?this._removeStop(b,!0,!0):b++}if(!this.returnToStart&&this.stops.length&&this._isStopAWaypoint(this.stops[this.stops.length-1]))for(b=this.stops.length-1;0<b;)this._isStopAWaypoint(this.stops[b])&&
this._removeStop(b,!0,!0),b--;if(this._isTimeUnits(this._getImpedanceAttribute().units))if(a.useTimeWindows=!0,"now"===this.startTime)a.timeWindowsAreUTC=!0,a.startTimeIsUTC=!0,a.startTime=new Date;else{a.timeWindowsAreUTC=!1;a.startTimeIsUTC=!1;var c=this._departAtTime,d=6E4*c.getValue().getTimezoneOffset(),c=new Date(c.getValue().getTime()+this._departAtDate.getValue().getTime()-d),c=new Date(c.getTime()-6E4*c.getTimezoneOffset());a.startTime=c}else a.startTime=null,a.useTimeWindows=!1;var c=this._getImpedanceAttribute(),
d=this._getCostAttribute(c.timeNeutralAttributeName),e=this.routeParams.accumulateAttributes||this.serviceDescription.accumulateAttributeNames;d&&-1===x.indexOf(e,d.name)&&e.push(d.name);this.routeParams.accumulateAttributes=e;a.returnStops=!0;e=[];for(b=0;b<this.stopGraphics.length;b++)if(this.stopGraphics[b]&&(e.push(new t(this.stopGraphics[b].toJson())),b)){var g=e[0].attributes,h=e[b].attributes,f;for(f in h)h.hasOwnProperty(f)&&!g.hasOwnProperty(f)&&(g[f]=null)}this.get("returnToStart")&&this.stopGraphics.length&&
this._isStopLocated(this.stops[0])?(f=new t(this.stopGraphics[0].toJson()),this._returnToStartStop=this._addStopWrapperToGraphic(f,f.attributes.Name),e.push(f)):this._returnToStartStop=null;a.stops.features=e;if(d)for(b=0;b<e.length;b++)e[b].attributes["Attr_"+d.name]=this._convertCostValue(e[b].attributes["Attr_"+c.name],c.units,d.units);this.set("routeParams",a)},_configureRoute:function(){var a=new r;a.promise.always(f.hitch(this,function(){this._checkMaxStops()}));this.createRouteSymbols();this._configureRouteOptions();
if(this.routeParams.returnRoutes&&this._incrementalSolveStopRange){var b=this._incrementalSolveStopRange;b.start<b.end?this.routeParams.stops.features=this.routeParams.stops.features.slice(b.start,b.end+1):b.start>b.end&&(this.routeParams.stops.features=this.routeParams.stops.features.slice(b.start,this.routeParams.stops.features.length-1).concat(this.routeParams.stops.features.slice(0,b.end+1)))}else this._incrementalSolveStopRange=null;for(var c={},d=this.routeParams.stops.features,e,g,b=0;b<d.length;b++)g=
d[b].attributes.address,e=(b===this._handle._index&&!this._handle.attributes.isWaypoint&&this._incrementalSolveStopRange?this._waypointName:g)+"_"+this._stopSequence++,d[b].attributes.Name=e,c[e]=g,delete d[b].attributes.address,delete d[b].attributes.isWaypoint,delete d[b].attributes.Status;this._solveInProgress=!0;var h={_incrementalSolveStopRange:this._incrementalSolveStopRange};this.routeTask.solve(this.routeParams,f.hitch(this,function(b){this._solveResultProcessing(b,c,h).then(a.resolve,a.reject)}),
f.hitch(this,function(b){f.mixin(this,h);this._solveInProgress=!1;for(var c=0;c<this.stops.length;c++)this.stops[c].feature&&(this.stops[c].feature.attributes=f.mixin(this.stops[c].feature.attributes,{Status:5}));this.set("directions",null);this._clearDisplayAfterSolve();this.createRouteSymbols();this._routeTaskError(b);a.reject(b)}));return a.promise},_solveResultProcessing:function(a,b,c){var d=new r;f.mixin(this,c);this._solveInProgress=!1;c=a.routeResults[0];var e=c.directions;c=c.stops;var g;
if(e){this._solverMessages=a.messages;var h=function(a){for(var c in b)if(a&&0===e.routeName.indexOf(c)||!a&&0<e.routeName.indexOf(c))return b[c];return""};g=h(!0);h=h(!1);e.routeName=(g!==this._waypointName?g:m.widgets.directions.waypoint)+" \u2014 "+(h!==this._waypointName?h:m.widgets.directions.waypoint);for(g=0;g<e.features.length;g++)if(h=e.features[g].attributes,"esriDMTDepart"===h.maneuverType||"esriDMTStop"===h.maneuverType)for(var n in b)if(b.hasOwnProperty(n)&&-1<h.text.indexOf(n)){h.text=
h.text.replace(n,b[n]);for(var k=0;k<c.length;k++)if(c[k].attributes.Name===n){f.mixin(e.features[g],{_associatedStop:c[this.returnToStart&&k===c.length-1?0:k],_associatedStopWithReturnToStart:c[k]});break}}for(g=0;g<c.length;g++)this._returnToStartStop&&c[g].attributes.Name===this._returnToStartStop.feature.attributes.Name&&(this._returnToStartStop._resultsStopIndex=g),c[g].attributes.Name=b[c[g].attributes.Name];this._directionsPostprocessing(e);n=e.features[0].attributes;this._updateMapTimeExtent(n.arriveTimeUTC);
this._useTrafficItemNode.title=m.widgets.directions.trafficLabelDepartAt+": "+this._toSpatiallyLocalTimeString(n.arriveTimeUTC,n.ETA)}this._showRoute(a).always(f.hitch(this,function(){this._incrementalSolveStopRange=null;d.resolve(a)}));this._showBarriers();return d.promise},_directionsPostprocessing:function(a){var b,c,d=function(b,c){var d=a.features[b]._associatedFeaturesWithWaypoints||[];d.push(a.featuresWithWaypoints[c]);a.features[b]._associatedFeaturesWithWaypoints=d;a.featuresWithWaypoints[c]._associatedFeatureNoWaypoints=
a.features[b]};c=f.hitch(this,function(a){return"\x3cdiv class\x3d'"+this.theme+"'\x3e\x3ctable class\x3d'esriRoutesTooltip'\x3e"+this._renderDirectionsItemTR(a._associatedFeatureNoWaypoints)+"\x3c/table\x3e\x3c/div\x3e"});a.featuresWithWaypoints=[];for(b=0;b<a.features.length;b++){var e=new t(a.features[b].toJson());e.setInfoTemplate(new W({title:this._i18n.widgets.directions.maneuver,content:c}));a.featuresWithWaypoints.push(e);a.featuresWithWaypoints[b]._associatedStop=a.features[b]._associatedStop;
a.featuresWithWaypoints[b]._associatedStopWithReturnToStart=a.features[b]._associatedStopWithReturnToStart}a.stringsWithWaypoints=f.mixin([],a.strings);a.eventsWithWaypoints=f.mixin([],a.events);for(c=b=0;b<a.features.length;)a.features[b]._associatedStop&&a.features[b]._associatedStop.attributes.Name===this._waypointName?(a.features.splice(b,b?2:1),a.strings.splice(b,b?2:1),a.events.splice(b,b?2:1),b&&a.features[b]&&"esriDMTStraight"===a.features[b].attributes.maneuverType?(e=a.features.splice(b,
1)[0],a.strings[b-1]=(a.strings[b-1]||[]).concat(a.strings.splice(b,1)[0]||[]),a.strings[b-1].length||(a.strings[b-1]=void 0),a.events[b-1]=(a.events[b-1]||[]).concat(a.events.splice(b,1)[0]||[]),a.events[b-1].length||(a.events[b-1]=void 0),a.features[b-1].attributes.length+=e.attributes.length,a.features[b-1].attributes.time+=e.attributes.time,a.features[b-1].geometry.paths[0]=a.features[b-1].geometry.paths[0].concat(e.geometry.paths[0]),d(b-1,c++),d(b-1,c++),d(b-1,c++)):(b&&d(b-1,c++),b<a.features.length&&
d(b,c++))):(d(b,c++),b++)},_boldText:function(a,b){return a.replace(RegExp("(^|\\s|\\W)("+b+")(\\W|\\s|$)","ig"),"$1\x3cstrong\x3e$2\x3c/strong\x3e$3")},_clearStopGraphics:function(){if(this.stopGraphics&&this.stopGraphics.length)for(var a=0;a<this.stopGraphics.length;a++)this._stopLayer.remove(this.stopGraphics[a]),this._stopLayer.remove(this.textGraphics[a]);this.set("stopGraphics",[]);this.set("textGraphics",[])},_updateMapTimeExtent:function(a){this.map&&(a=new Date(a),this.map.setTimeExtent(new sa(a,
a)))},_clearRouteGraphics:function(){for(var a=this.displayedRouteGraphics,b=this.displayedManeuverPointGraphics,c=this._routeLayer,d=this._waypointsEventLayer,e=0,f=0,h=this._incrementalSolveStopRange?this._incrementalSolveStopRange:{start:0,end:this.stops?this.stops.length:-1};a&&f<a.length;){if(a[f]._associatedStop)for(var n=0;n<this.stops.length;n++)if(this.stops[n].feature===a[f]._associatedStop){e=n;break}e>=h.start&&e<h.end||h.start>=h.end&&(e>=h.start||e<h.end)?(c.remove(a[f]),a.splice(f,
1)):f++}c.remove(this._incrementalRouteSegment);this.set("displayedRouteGraphics",a?a:[]);b&&b.length&&x.forEach(b,function(a){d.remove(a)});this.set("displayedManeuverPointGraphics",[]);this._waypointsEventLayer.clear();this.unhighlightSegment(!0)},_clearInfoWindow:function(){var a=this.get("map").infoWindow;a&&(a.hide(),a.clearFeatures())},_clearDisplayBeforeSolve:function(){this._toggleSaveMenu(!1);this._clearInfoWindow();this._clearResultsHTML()},_clearDisplayAfterSolve:function(){this._clearStopGraphics();
this._clearRouteGraphics();this.clearMessages()},_getLetter:function(a){var b=this.alphabet,c="",d=function(a){var c="";"0123456789"===b||"1234567890"===b?c=String(a+1):(a=a||0,a>=b.length&&(c=d(Math.floor(a/b.length)-1),a%=b.length),c+=b[a]);return c},e=a instanceof t?f.hitch(this,function(){for(var b=this.get("returnToStart")?0:-1,c=0;c<this.stops.length;c++)if(this.stops[c].feature===a){b=c;break}return b})():a;if(-1<e&&b&&b.length){b instanceof Array&&(b=b.toString().replace(/,/g,""));for(var c=
-1,g=0;g<=e;g++)c+=!this._isStopAWaypoint(this.stops[g])?1:0;c=d(c)}return c},_solveAndZoom:function(a){if(this.autoSolve)return this._getDirections().then(f.hitch(this,function(){a||this.zoomToFullRoute()}));var b=new r;b.resolve();return b.promise},_setupEvents:function(){this._onEvents.push(l(this.domNode,"[data-blur-on-click]:click",function(){this.blur()}));this._onEvents.push(l(this._dndNode,"[data-reverse-stops]:click, [data-reverse-stops]:keydown",f.hitch(this,function(a){a&&("click"===a.type||
"keydown"===a.type&&a.keyCode===O.ENTER)&&this.modifyStopSequence()})));this._onEvents.push(l(this._printButton,"click, keydown",f.hitch(this,function(a){a&&("click"===a.type||"keydown"===a.type&&a.keyCode===O.ENTER)&&this._printDirections()})));this._onEvents.push(l(this._resultsNode,"[data-full-route]:click, [data-full-route]:keydown",f.hitch(this,function(a){a&&("click"===a.type||"keydown"===a.type&&a.keyCode===O.ENTER)&&this.zoomToFullRoute()})));this._onEvents.push(l(this._dndNode,"[data-remove]:click, [data-remove]:keydown",
f.hitch(this,function(a){if(a&&("click"===a.type||"keydown"===a.type&&a.keyCode===O.ENTER)){var b=I("[data-remove]",this._dndNode);a=x.indexOf(b,a.target);this.removeStop(a)}})));this._onEvents.push(l(this._dndNode,"[data-center-at]:click, [data-center-at]:keydown",f.hitch(this,function(a){if(a&&("click"===a.type||"keydown"===a.type&&a.keyCode===O.ENTER)){var b=I("[data-center-at]",this._dndNode);a=x.indexOf(b,a.target);this.stops[a]&&(this.stops[a].feature&&this.stops[a].feature.geometry)&&this.map.centerAndZoom(this.stops[a].feature.geometry)}})));
this._onEvents.push(l(this.map,"zoom-end",f.hitch(this,function(){var a=this._segmentGraphics;a&&(a[0]&&void 0!==a[0].attributes._index)&&this.highlightSegment(a[0].attributes._index,!0)})));this._onEvents.push(l(this._dnd,"Drop",f.hitch(this,function(){this._dnd.sync();this.set("optimalRoute",!1);var a,b,c=!1,f=[],n=this._dnd.getAllNodes();for(a=0;a<this.geocoders.length;a++)if(b=x.indexOf(n,this.geocoders[a]._tr),-1<b&&a!==b&&a!==b-1){for(;0<b&&this._isStopAWaypoint(this.stops[b]);)b--;c=!0;break}c&&
(f=this._markWPsForRemovalAfterUserChangedStopSequence(a,b));this._sortGeocoders();this.setListIcons();this._removeSomeWaypoints(f);this.stops[b].name&&this.getDirections()})));this._onEvents.push(l(this._dnd,"DndStart",f.hitch(this,function(){var a=I("body")[0];q.add(a,this._css.dndDragBodyClass);this._removeLocateButtonVisibilityEvents()})));this._onEvents.push(l(this._dnd,"DndDrop, DndCancel",f.hitch(this,function(){var a=I("body")[0];q.remove(a,this._css.dndDragBodyClass);this._setLocateButtonVisibilityEvents()})));
var a=this._handle,b=f.hitch(this,function(b){var c=f.hitch(this,function(c,e,f,g,p){var l=a._isShown();a.setGeometry(c);a._tooltip.style.left=b.screenPoint.x+"px";a._tooltip.style.top=b.screenPoint.y+"px";if(l&&(a._index!==f||a.attributes.isWaypoint!==g))a._remove(),l=!1;a.setSymbol(e);a._index=f;a._isStopIcon=a._index===Math.floor(a._index);a.attributes.isWaypoint=g;a._isStopIcon&&(a.attributes.address=this.stopGraphics[f].attributes.address,a.setInfoTemplate(this.stopGraphics[f].infoTemplate));
if(this.canModifyWaypoints||a._isStopIcon)l||(this._stopLayer.add(a),(c=a.getDojoShape())&&c[g?"moveToBack":"moveToFront"].call(c)),this.editToolbar.activate(ha.MOVE,a);g=g?a._isStopIcon?m.widgets.directions.dragWaypoint:this.canModifyWaypoints?m.widgets.directions.dragRoute:"":m.widgets.directions.dragStop;a._showTooltip(p||g)});this.unhighlightSegment();if(this.mapClickActive&&this.dragging&&!this._solveInProgress&&!this._moveInProgress&&!a._solveTimeout)if(clearTimeout(a._removeTimeout),(b.graphic._isStopIcon||
b.graphic._isStopLabel)&&!b.graphic.attributes.isWaypoint&&this.canModifyStops||b.graphic._isStopIcon&&b.graphic.attributes.isWaypoint&&this.canModifyWaypoints){var g=b.graphic._isStopLabel?this.stopGraphics[b.graphic._index]:b.graphic;c(g.geometry,this._getStopSymbol(this.stops[g._index],!0),g._index,!0===g.attributes.isWaypoint);this._stopLayer.remove(this.stopGraphics[g._index]);this._stopLayer.remove(this.textGraphics[g._index])}else if(b.graphic._isSnapFeature||b.graphic._isHandle&&!b.graphic._isStopIcon)this._snappingManager||
(this._snappingManager=this.map.snappingManager),this._snappingManager.getSnappingPoint(b.screenPoint).then(f.hitch(this,function(f){if(!this.maxStopsReached&&!this._moveInProgress&&f){for(var g=this.displayedManeuverPointGraphics,k=null,m=0;m<g.length;m++)if(g[m].geometry.x===f.x&&g[m].geometry.y===f.y){k=g[m]._directionsFeature;g=x.indexOf(this.directions.features,k);-1<g&&this.highlightSegment(g);break}c(f,b.graphic._isHandle?a.symbol:this.waypointSymbol,b.graphic._isHandle?a._index:b.graphic._nextStopIndex,
b.graphic._isHandle?a.attributes.isWaypoint:!0,k)}}))}),c=f.hitch(this,function(){clearTimeout(a._removeTimeout);a._removeTimeout=setTimeout(a._remove,100);this.unhighlightSegment()});this._onEvents.push(this._waypointsEventLayer.on("mouse-move",b));this._onEvents.push(this._waypointsEventLayer.on("mouse-out",c));this._onEvents.push(this._stopLayer.on("mouse-move",b));this._onEvents.push(this._stopLayer.on("mouse-out",c));this._editToolbarEvents();this._watchEvents.push(this.watch("theme",this._updateThemeWatch));
this._watchEvents.push(this.watch("canModifyStops",this._updateCanModifyStops));this._watchEvents.push(this.watch("canModifyWaypoints",this._updateCanAddWaypoints));this._watchEvents.push(this.watch("showReturnToStartOption",this._optionsMenu));this._watchEvents.push(this.watch("showOptimalRouteOption",this._optionsMenu));this._watchEvents.push(this.watch("returnToStart",this._setMenuNodeValues));this._watchEvents.push(this.watch("optimalRoute",this._setMenuNodeValues));this._watchEvents.push(this.watch("startTime",
this._setStartTime));this._watchEvents.push(this.watch("traffic",this._setMenuNodeValues));this._watchEvents.push(this.watch("trafficLayer",this._trafficLayerUpdate));this._watchEvents.push(this.watch("routeTaskUrl",f.hitch(this,function(){this._createRouteTask();this._setTrafficOptions()})));this._watchEvents.push(this.watch("printTaskUrl",f.hitch(this,function(){this._createPrintTask()})));this._watchEvents.push(this.watch("geometryTaskUrl",f.hitch(this,function(){this._createGeometryTask()})));
this._watchEvents.push(this.watch("routeParams",f.hitch(this,function(){this._createRouteParams();this._setDefaultUnits()})));this._watchEvents.push(this.watch("searchOptions",f.hitch(this,function(){this._setSearchOptions();this._createGlobalGeocoder();var a=this.get("searchOptions").sources;if(a)for(var b=0;b<this.geocoders.length;b++)this.geocoders[b].set("sources",a)})));this._watchEvents.push(this.watch("showReverseStopsButton",this.setListIcons));this._watchEvents.push(this.watch("editToolbar",
this._editToolbarEvents));this._watchEvents.push(this.watch("showTravelModesOption",this._showTravelModesOption));this._watchEvents.push(this.watch("showMilesKilometersOption",this._showMilesKilometersOption));this._watchEvents.push(this.watch("showClearButton",this._showClearButton));this._watchEvents.push(this.watch("directionsLengthUnits",this.setDirectionsLengthUnits));this._watchEvents.push(this.watch("directionsLanguage",this.setDirectionsLanguage));this._watchEvents.push(this.watch("mapClickActive",
this._activate));this._watchEvents.push(this.watch("showActivateButton",this._showActivateButton));this._watchEvents.push(this.watch("showPrintPage",function(){u.set(this._printButton,"display",this.showPrintPage?"inline-block":"none")}));this._watchEvents.push(this.watch("showSaveButton",function(){u.set(this._saveMenuButton,"display",this.showSaveButton&&this.owningSystemUrl?"inline-block":"none")}))},_editToolbarEvents:function(){var a=f.hitch(this,function(a){var b="";if((a=a.routeResults?a.routeResults[0]:
null)&&a.route){a=a.route.attributes;var e=this.routeParams.travelMode;if(e)var b=b+("\x3cb\x3e"+e.name+"\x3c/b\x3e "+m.widgets.directions.toNearbyStops+": "),f=void 0!==a["Total_"+e.timeAttributeName]?this._formatTime(a["Total_"+e.timeAttributeName],!1,this._getCostAttribute(e.timeAttributeName).units):"",b=b+((void 0!==a["Total_"+e.distanceAttributeName]?this._formatDistance(a["Total_"+e.distanceAttributeName],!0,this._getCostAttribute(e.distanceAttributeName).units):"")+(f?" \x26middot; "+f:""));
else b=this._formatArbitraryCostsForRouteTooltip(a)}this._handle._showTooltip(b)}),b=f.hitch(this,function(c,d){var e=new r,g=this._handle,h=this.map.toScreen(g._origPoint).offset(c.transform.dx+g.symbol.xoffset,c.transform.dy+g.symbol.yoffset);c.origMapPoint||(c.origMapPoint=this.map.toMap(h));u.set(g._tooltip,"left",h.x+"px");u.set(g._tooltip,"top",h.y+"px");clearTimeout(g._solveTimeout);if(this._solveInProgress||!this._requestQueueTail.isFulfilled())g._solveTimeout=setTimeout(function(){b(c,d).always(e.resolve)},
100);else if(g._isStopIcon){var h=c.graphic._index,n=this.stops[h];(n=n?{name:n.name,extent:n.extent,feature:new t(n.feature.toJson())}:null)?(n.feature.setGeometry(c.origMapPoint),this._modifiedWaypointIndex=this._isStopAWaypoint(this.stops[h])?h:null,this._incrementalSolveStopRange={start:this.returnToStart?(this.stops.length+h-1)%this.stops.length:Math.max(0,h-1),end:this.returnToStart?(h+1)%this.stops.length:Math.min(this.stops.length-1,h+1)},this.updateStop(n,h,d).always(f.hitch(this,function(b){g._solveTimeout=
null;b.routeResults&&a(b);e.resolve()}))):e.resolve()}else e.resolve();return e.promise});this._onEvents.push(l(this.editToolbar,"graphic-click",f.hitch(this,function(a){if(a.graphic.attributes.isWaypoint)a.graphic._isStopIcon&&(!this._moveInProgress&&!this._solveInProgress)&&(this._handle._remove(),this._moveInProgress=!0,this.removeStop(a.graphic._index,!0).always(f.hitch(this,function(){this._moveInProgress=!1})));else{var b=this.get("map").infoWindow;b&&(b.setFeatures([a.graphic]),b.show(a.graphic.geometry))}})));
this._onEvents.push(l(this.editToolbar,"graphic-move-start",f.hitch(this,function(a){this._blurGeocoders();this._moveInProgress=!0;this._removeEmptyStops();this.routeParams.returnDirections=!1;this.routeParams.returnRoutes=!0;a=a.graphic;a._origPoint=new X(a.geometry.toJson());a._maxDeviation=0;a._solveHasHappened=!1;this.map.disableMapNavigation()})));this._onEvents.push(l(this.editToolbar,"graphic-move-stop",f.hitch(this,function(a){this.map.enableMapNavigation();this.routeParams.returnDirections=
!0;this.routeParams.returnRoutes=!1;if(this._handle._isStopIcon)if(this._handle._solveHasHappened)if(this._handle.attributes.isWaypoint)b(a,!0).always(f.hitch(this,function(){this._moveInProgress=!1;this._handle._isStopIcon=!0;this._handle._remove();this._showLoadingSpinner()}));else{clearTimeout(this._handle._solveTimeout);this._handle._solveTimeout=null;var d=this.stops[a.graphic._index],e=(d&&d.feature&&d.feature.attributes.Name)===this._userDefinedStopName,g=d&&d.name;this._reverseGeocode(new t(a.graphic.toJson())).then(f.hitch(this,
function(b){e&&(b.name=g,b.feature.attributes.Name=this._userDefinedStopName);this._setReverseGeocode(b,b.feature.geometry,a.graphic._index).always(f.hitch(this,function(){this._moveInProgress=!1;this._handle._remove();this._showLoadingSpinner()}))}))}else this._moveInProgress=!1;else this._moveInProgress=!1})));this._onEvents.push(l(this.editToolbar,"graphic-move",f.hitch(this,function(a){var d=this._handle,e=a.transform;e.dx&&e.dy&&(a.graphic._maxDeviation=Math.max(d._maxDeviation,Math.sqrt(e.dx*
e.dx+e.dy*e.dy)));10<d._maxDeviation&&(d._solveHasHappened=!0,a.graphic===d&&d.attributes.isWaypoint&&!d._isStopIcon?(this.set("optimalRoute",!1),d._index+=0.5,d._isStopIcon=!0,a.graphic._stopIndex=d._index,this._incrementalSolveStopRange={start:this.returnToStart?(this.stops.length+d._index-1)%this.stops.length:Math.max(0,d._index-1),end:this.returnToStart?(d._index+1)%(this.stops.length+1):Math.min(this.stops.length,d._index+1)},this.addStop({name:this._waypointName,feature:new t(d.geometry,d.symbol,
{isWaypoint:!0,CurbApproach:3})},a.graphic._stopIndex)):((d=a.graphic.getDojoShape())&&d.moveToFront(),b(a)))})))},_isStopAWaypoint:function(a){return a&&a.feature&&a.feature.attributes&&a.feature.attributes.isWaypoint},_getStopCount:function(){var a=0,b;for(b=0;b<this.stops.length;b++)a+=!this._isStopAWaypoint(this.stops[b])&&this.stops[b].name?1:0;return a},_getWaypointCount:function(){var a=0,b;for(b=0;b<this.stops.length;b++)a+=this._isStopAWaypoint(this.stops[b])?1:0;return a},_decorateUngeocodedStop:function(a){var b=
new r,c=function(c,d){b.resolve({name:void 0===c?m.widgets.directions.unlocatedStop:c.toFixed(6)+" "+d.toFixed(6),feature:a})};if(a.geometry)if(a.geometry.spatialReference&&4326!==a.geometry.spatialReference.wkid)if(this.map&&this.map.spatialReference&&this.map.spatialReference.isWebMercator()){var d=T.xyToLngLat(a.geometry.x,a.geometry.y);c(d[0],d[1])}else this._geometryService?(d=new Ia,d.outSR=new ta(4326),d.geometries=[a.geometry],this._geometryService.project(d).then(f.hitch(this,function(b){b&&
b.length?c(b[0].x,b[0].y):c(a.geometry.x,a.geometry.y)}),f.hitch(this,function(){c()}))):c(a.geometry.x,a.geometry.y);else c(a.geometry.x,a.geometry.y);else c();return b.promise},_trafficLayerUpdate:function(a,b,c){a=this.get("map");b&&this._trafficLayerAdded&&(a.removeLayer(b),this._trafficLayerAdded=!1);c&&(this.get("traffic")&&!this._trafficLayerAdded)&&(a.addLayer(c),c.show(),this._trafficLayerAdded=!0)},_routeTaskError:function(a){var b=m.widgets.directions.error.routeTask,c=a.details;c&&1===
c.length&&("The distance between any inputs must be less than 50 miles (80 kilometers) when walking."===c[0]?b=m.widgets.directions.error.maxWalkingDistance:"Driving a truck is currently not supported outside of North America and Central America."===c[0]&&(b=m.widgets.directions.error.nonNAmTruckingMode));this._showMessage(b);this.onDirectionsFinish(a)},_showMessage:function(a,b){var c="";this.messages.push({msg:a,error:!b});if(this.messages.length){for(var c=c+"\x3cul\x3e",d=0;d<this.messages.length;d++)c+=
'\x3cli class\x3d"'+(this.messages[d].error?this._css.routesErrorClass:this._css.routesInfoClass)+'"\x3e'+this.messages[d].msg+"\x3c/li\x3e";c+="\x3c/ul\x3e"}this._msgNode&&(this._msgNode.innerHTML=c);if(!b)this.onError(a)},_isTimeUnits:function(a){return"esriNAUSeconds"===a||"esriNAUMinutes"===a||"esriNAUHours"===a||"esriNAUDays"===a},_getImpedanceAttribute:function(){return this._getCostAttribute(this.routeParams&&this.routeParams.travelMode&&this.routeParams.travelMode.impedanceAttributeName||
this.routeParams.impedanceAttribute||this.serviceDescription.impedance)},_getDirectionsTimeAttribute:function(){return this._getCostAttribute(this.routeParams&&this.routeParams.travelMode&&this.routeParams.travelMode.timeAttributeName||this.routeParams.directionsTimeAttribute||this.serviceDescription.directionsTimeAttribute)},_getCostAttribute:function(a){for(var b=this.serviceDescription&&this.serviceDescription.networkDataset.networkAttributes||[],c,d=0;d<b.length;d++)if(b[d].name===a&&"esriNAUTCost"===
b[d].usageType){c=b[d];break}return c},_convertCostValue:function(a,b,c){var d=this._isTimeUnits(b),e=this._isTimeUnits(c);b=d?this._toMinutes(a,b):this._toMeters(a,b);return d===e?e?this._fromMinutes(b,c):this._fromMeters(b,c):a},_toMinutes:function(a,b,c){a=a||0;switch(b){case "esriNAUSeconds":a/=Math.pow(60,c?-1:1);break;case "esriNAUHours":a*=Math.pow(60,c?-1:1);break;case "esriNAUDays":a*=Math.pow(1440,c?-1:1)}return a},_fromMinutes:function(a,b){return this._toMinutes(a,b,!0)},_toMeters:function(a,
b,c){a=a||0;switch((b||"").replace("esriNAU","esri")){case "esriInches":a*=Math.pow(0.0254,c?-1:1);break;case "esriFeet":a*=Math.pow(0.3048,c?-1:1);break;case "esriYards":a*=Math.pow(0.9144,c?-1:1);break;case "esriMiles":a*=Math.pow(1609.344,c?-1:1);break;case "esriNauticalMiles":a*=Math.pow(1851.995396854,c?-1:1);break;case "esriMillimeters":a/=Math.pow(1E3,c?-1:1);break;case "esriCentimeters":a/=Math.pow(100,c?-1:1);break;case "esriKilometers":a*=Math.pow(1E3,c?-1:1);break;case "esriDecimeters":a/=
Math.pow(10,c?-1:1)}return a},_fromMeters:function(a,b){return this._toMeters(a,b,!0)},_createRouteTask:function(){var a=new r;this.set("routeTask",new Ba(this.get("routeTaskUrl")));this._createRouteParams();this.routeTask.getServiceDescription(this.travelModesServiceUrl,this.doNotFetchTravelModesFromOwningSystem).then(f.hitch(this,function(b){b.networkDataset?(this.set("serviceDescription",b),this.set("maxStops",parseInt(this.userOptions.maxStops||b.serviceLimits&&b.serviceLimits.Route_MaxStops||
this.defaults.maxStops)),this.defaults.portalUrl?(this.owningSystemUrl=this.defaults.portalUrl,a.resolve()):this.routeTask.getOwningSystemUrl().then(f.hitch(this,function(b){this.owningSystemUrl=b;a.resolve()}),a.reject)):(this._showMessage(m.widgets.directions.error.cantFindRouteServiceDescription),a.reject(Error(m.widgets.directions.error.cantFindRouteServiceDescription)))}),f.hitch(this,function(){this._showMessage(m.widgets.directions.error.cantFindRouteServiceDescription);a.reject(Error(m.widgets.directions.error.cantFindRouteServiceDescription));
this.mapClickActive=!1;this._activate()}));return a.promise},_createSearchSourceDDL:function(){if(this._globalGeocoder&&this._globalGeocoder.sources&&1<this._globalGeocoder.sources.length){var a=f.hitch(this,function(a){this._searchSourceSelector.domNode.blur();this._globalGeocoder.set("activeSourceIndex",a);for(var b=0;b<this.geocoders.length;b++)this.geocoders[b].set("activeSourceIndex",a)});if(!this._searchSourceSelector){for(var b=[{value:"all",label:m.widgets.Search.main.all,selected:!0}],c=
0;c<this._globalGeocoder.sources.length;c++)b.push({value:String(c),label:this._globalGeocoder.sources[c].name});this._searchSourceSelector=new Z({className:"esriSearchSourcesDDL",style:"width:100%;",options:b},this._searchSourceSelectorContainer);this._searchSourceSelector.startup();this._searchSourceSelector.on("change",a);this._searchSourceSelector.domNode.style.width=""}a("all")}else 2>this._globalGeocoder.sources.length&&(this._searchSourceContainerNode.style.display="none")},_createTravelModesDDL:function(){this._travelModeSelector||
(this._travelModeSelector=new Z({className:"esriTravelModesDDL",style:"width:100%;"},this._travelModeSelectorContainer),this._travelModeSelector.startup(),this._travelModeSelector._interractive=!0,this._travelModeSelector.on("change",f.hitch(this,function(a){this._travelModeSelector._interractive?this._enqueue(function(){return this._setTravelMode(a).always(f.hitch(this,function(){this._travelModeSelector._interractive=!0}))}):this._travelModeSelector._interractive=!0})))},_setupTravelModes:function(){var a=
this.get("serviceDescription"),b=a.supportedTravelModes,c=new r;if(b&&b.length&&this._travelModeSelector){for(var d=b[0].name,e=[],f=0;f<b.length;f++){for(var h="AUTOMOBILE"===b[f].type?"Driving":"TRUCK"===b[f].type?"Trucking":"WALK"===b[f].type?"Walking":"Other",n="",k=a.networkDataset.networkAttributes,m=0;m<k.length;m++){var p=k[m];if(p.name===b[f].impedanceAttributeName){if("esriNAUCentimeters"===p.units||"esriNAUDecimalDegrees"===p.units||"esriNAUDecimeters"===p.units||"esriNAUFeet"===p.units||
"esriNAUInches"===p.units||"esriNAUKilometers"===p.units||"esriNAUMeters"===p.units||"esriNAUMiles"===p.units||"esriNAUMillimeters"===p.units||"esriNAUNauticalMiles"===p.units||"esriNAUYards"===p.units)n="Distance";else if("esriNAUDays"===p.units||"esriNAUHours"===p.units||"esriNAUMinutes"===p.units||"esriNAUSeconds"===p.units)n="Time";break}}e.push({id:b[f].name,label:'\x3cdiv class\x3d"esriTravelModesDirectionsIcon esriTravelModesType'+h+n+'"\x3e\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"esriTravelModesTypeName"\x3e'+
b[f].name+"\x3c/div\x3e"});if(a.defaultTravelMode&&(b[f].id===a.defaultTravelMode||b[f].itemId===a.defaultTravelMode))d=b[f].name}this._showTravelModesOption();this._travelModeSelector.setStore(new aa({objectStore:new $({data:e})}));this._travelModeSelector._interractive=!1;this._travelModeSelector.setValue(d);this._setTravelMode(d).always(c.resolve)}else this.set("showTravelModesOption",!1),c.resolve();return c.promise},_createPrintTask:function(){this._printService=(this.printTaskUrl=this._usingAGOL()?
this.printTaskUrl:this.defaults.printTaskUrl)?new Ea(this.printTaskUrl,{async:!1}):null;var a=new Ga;a.exportOptions={width:670,height:750,dpi:96};a.format="PNG32";a.layout="MAP_ONLY";a.preserveScale=!1;a.showAttribution=!1;var b=new Fa;b.map=this.map;b.outSpatialReference=this.map.spatialReference;b.template=a;this._printParams=b},_createGeometryTask:function(){this._geometryService=null;this._usingAGOL()?this._geometryService=new da(this.geometryTaskUrl):this.geometryTaskUrl=(this._geometryService=
this.defaults.geometryTaskUrl?new da(this.defaults.geometryTaskUrl):Ha.defaults.geometryService)?this._geometryService.url:null},_showTravelModesOption:function(){var a=this.get("serviceDescription");u.set(this._travelModeContainerNode,"display",this.showTravelModesOption&&a&&a.supportedTravelModes&&a.supportedTravelModes.length&&!this.doNotFetchTravelModesFromOwningSystem?"block":"none")},_showMilesKilometersOption:function(){u.set(this._agolDistanceUnitsNode,"display",this.showMilesKilometersOption?
"block":"none")},_showClearButton:function(){u.set(this._clearDirectionsButtonNode,"display",this.showClearButton?"inline-block":"none")},_showActivateButton:function(){u.set(this._activateButtonNode,"display",this.showActivateButton?"inline-block":"none");this.showActivateButton||this.deactivate()},_createRouteParams:function(){var a={returnDirections:!0,returnRoutes:!1,outputLines:"esriNAOutputLineTrueShape",preserveFirstStop:!0,preserveLastStop:!0,directionsOutputType:"complete",stops:new Aa,ignoreInvalidLocations:!0,
doNotLocateOnRestrictedElements:!0,outSpatialReference:this.get("map").spatialReference};this.get("routeParams")||(this.routeParams={});var b=new Ca;this.routeParams=f.mixin(b,{outputGeometryPrecision:0,outputGeometryPrecisionUnits:"esriMeters",restrictUTurns:"esriNFSBAtDeadEndsOnly"},this.get("routeParams"),a)},_markWPsForRemovalAfterUserChangedStopSequence:function(a,b){for(var c=a-1,d=[];0<=c&&this._isStopAWaypoint(this.stops[c]);)d.push(this.stops[c]),c--;for(c=a+1;c<this.stops.length&&this._isStopAWaypoint(this.stops[c]);)d.push(this.stops[c]),
c++;if(b>a)for(c=b+1;c<this.stops.length&&this._isStopAWaypoint(this.stops[c]);)d.push(this.stops[c]),c++;else if(void 0!==b)for(c=b-1;0<=c&&this._isStopAWaypoint(this.stops[c]);)d.push(this.stops[c]),c--;else if(this.returnToStart&&0===a)for(c=this.stops.length-1;0<=c&&this._isStopAWaypoint(this.stops[c]);)d.push(this.stops[c]),c--;return d},_removeSomeWaypoints:function(a){for(var b=new r,c=[],d=0;d<a.length;d++){var e=x.indexOf(this.stops,a[d]);-1<e&&c.push(this._removeStop(e,!0,!0))}J(c).always(b.resolve);
return b.promise},_modifyStopSequence:function(a,b){var c=this._dnd.getAllNodes(),d=new r,e,g=[];if(c.length)if(this._removeLocateButtonVisibilityEvents(),arguments.length&&void 0!==a)if(0<=a&&0<=b&&a<this.stops.length&&b<this.stops.length&&a!==b){var c=this._markWPsForRemovalAfterUserChangedStopSequence(a,b),h=this.stops.splice(a,1);this.stops.splice(b,0,h[0]);for(e=0;e<this.stops.length;e++)g.push(this._updateStop(this.stops[e],e));g.push(this._removeSomeWaypoints(c));J(g).always(f.hitch(this,function(){this._solveAndZoom().always(d.resolve)}))}else d.reject("Invalid From and To values.");
else{for(e=0;e<this.stops.length;)this._isStopAWaypoint(this.stops[e])?g.push(this._removeStop(e,!0,!0)):e++;J(g).always(f.hitch(this,function(){g=[];this.stops.reverse();for(e=0;e<this.stops.length;e++)g.push(this._updateStop(this.stops[e],e));J(g).always(f.hitch(this,function(){this._solveAndZoom().always(d.resolve)}))}))}else d.resolve();return d.promise},_setMenuNodeValues:function(a){"traffic"!==a&&this._clearDisplayBeforeSolve();a=this.get("optimalRoute");this._findOptimalOrderNode&&F.set(this._findOptimalOrderNode,
"checked",a);this._returnToStartNode&&(a=this.returnToStart&&!this.maxStopsReached&&this.stops[0]&&(!this.stops[0].feature||this._isStopLocated(this.stops[0])),F.set(this._returnToStartNode,"checked",a),this.set("returnToStart",a),this.maxStopsReached&&this.returnToStart&&this._showMessage(m.widgets.directions.error.maximumStops));if(!this.returnToStart&&!this._incrementalSolveStopRange&&this.directions){this._incrementalSolveStopRange={start:this.stops.length-1,end:this.stops.length};this._clearRouteGraphics();
this._incrementalSolveStopRange=null;for(a=this.stops.length;0<a--&&this._isStopAWaypoint(this.stops[a]);)this._removeSomeWaypoints([this.stops[a]])}this._useTrafficNode&&(F.set(this._useTrafficNode,"checked",this.traffic),this.traffic?this._addTrafficLayer():this._removeTrafficLayer());switch(this.get("directionsLengthUnits")){case w.KILOMETERS:F.set(this._useKilometersNode,"checked",!0);F.set(this._useMilesNode,"checked",!1);break;case w.MILES:F.set(this._useKilometersNode,"checked",!1),F.set(this._useMilesNode,
"checked",!0)}u.set(this._printButton,"display",this.showPrintPage?"inline-block":"none");u.set(this._saveMenuButton,"display",this.showSaveButton&&this.owningSystemUrl?"inline-block":"none");this._showMilesKilometersOption();this._showClearButton()},_optionsMenu:function(){this._useTrafficItemNode&&u.set(this._useTrafficItemNode,"display",this.get("showTrafficOption")?"block":"none");this._returnToStartItemNode&&u.set(this._returnToStartItemNode,"display",this.get("showReturnToStartOption")?"block":
"none");this._findOptimalOrderItemNode&&u.set(this._findOptimalOrderItemNode,"display",this.get("showOptimalRouteOption")&&3<this._getStopCount()?"block":"none");this.stops.length>=this.get("minStops")?q.add(this._widgetContainer,this._css.stopsOptionsOptionsEnabledClass):(q.remove(this._widgetContainer,this._css.stopsOptionsOptionsEnabledClass),this._optionsMenuNode&&"block"===u.get(this._optionsMenuNode,"display")&&this._toggleOptionsMenu())},_stopsRemovable:function(){2<this._dnd.getAllNodes().length-
this._getWaypointCount()?q.add(this._widgetContainer,this._css.stopsRemovableClass):q.remove(this._widgetContainer,this._css.stopsRemovableClass)},_checkMaxStops:function(){this.set("maxStopsReached",this._getStopCount()+this._getWaypointCount()+(this.returnToStart?1:0)>=this.maxStops);this._showAddDestination()},_updateThemeWatch:function(a,b,c){q.remove(this.domNode,b);q.add(this.domNode,c)},_toggleOptionsMenu:function(){"block"===u.get(this._optionsMenuNode,"display")?(u.set(this._optionsMenuNode,
"display","none"),q.remove(this._optionsButtonNode,"esriStopsOptionsOpen"),this._optionsButtonNode.innerHTML=m.widgets.directions.showOptions):(u.set(this._optionsMenuNode,"display","block"),q.add(this._optionsButtonNode,"esriStopsOptionsOpen"),this._optionsButtonNode.innerHTML=m.widgets.directions.hideOptions)},_toggleSaveMenu:function(a){"block"===u.get(this._saveMenuNode,"display")||!1===a?(u.set(this._saveMenuNode,"display","none"),q.remove(this._saveMenuButton,this._css.stopsPressedButtonClass)):
(this.clearMessages(),u.set(this._saveMenuNode,"display","block"),q.add(this._saveMenuButton,this._css.stopsPressedButtonClass),this._enableSharing().then(f.hitch(this,function(){this._outputLayer.setValue(this.routeLayer.title?this.routeLayer.title:this.directions&&this.directions.routeName);if(this.routeLayer.ownerFolder)for(var a=this._folderSelector.store.objectStore.data,c=0;c<a.length;c++)if(a[c].folderId===this.routeLayer.ownerFolder){this._folderSelector.getValue()!==a[c].id&&(this._folderSelector._interractive=
!1,this._folderSelector.setValue(a[c].id));break}this._enableButton(this._saveButton,this.routeLayer.isItemOwner||!this._userCanCreatePortalItem);this._outputLayer.set("disabled",!1)})))},_showToolbar:function(){q[this.stops.length<this.maxStops&&this.canModifyStops||this.canModifyWaypoints?"add":"remove"].call(v,this._widgetContainer,this._css.addStopsClass)},_showAddDestination:function(){this._showToolbar();this._addDestinationNode.style.display=this.stops.length<this.maxStops&&this.canModifyStops?
"inline":"none"},_showMapClickActiveButton:function(){this._showToolbar();this._activateButtonNode.style.display=this.canModifyStops||this.canModifyWaypoints?"inline-block":"none"},_getAbsoluteUrl:function(a){a=E.toUrl(a);return/^https?\:/i.test(a)?a:/^\/\//i.test(a)?R+a:/^\//i.test(a)?R+"//"+window.location.host+a:a},_getManeuverImage:function(a){return a?"esriDMTStop"===a||"esriDMTDepart"===a?"":this._getAbsoluteUrl("./images/Directions/maneuvers/"+a+".png"):""},_loadPrintDirections:function(a){var b=
this.get("printTemplate"),c=new r;this.directionsLengthUnits!==this.routeParams.directionsLengthUnits?this.getDirections().then(c.resolve,c.reject):c.resolve();c.then(f.hitch(this,function(){if(!b&&this.directions){var c=this._getAbsoluteUrl("./css/Directions.css"),e=this._getAbsoluteUrl("./css/DirectionsPrint.css"),f=this._getAbsoluteUrl("./images/Directions/print-logo.png"),h;h=na.isBodyLtr()?"ltr":"rtl";b="";b+="\x3c!DOCTYPE HTML\x3e";b+='\x3chtml lang\x3d"en" class\x3d"'+this.get("theme")+'" dir\x3d"'+
h+'"\x3e';b+="\x3chead\x3e";b+='\x3cmeta charset\x3d"utf-8"\x3e';b+='\x3cmeta http-equiv\x3d"X-UA-Compatible" content\x3d"IE\x3dEdge,chrome\x3d1"\x3e';b+="\x3ctitle\x3e"+this.get("directions").routeName+"\x3c/title\x3e";b+='\x3clink rel\x3d"stylesheet" media\x3d"screen" type\x3d"text/css" href\x3d"'+c+'" /\x3e';b+='\x3clink rel\x3d"stylesheet" media\x3d"print" type\x3d"text/css" href\x3d"'+e+'" /\x3e';b+="\x3c/head\x3e";b+='\x3cbody class\x3d"'+this._css.esriPrintPageClass+'"\x3e';b+='\x3cdiv class\x3d"'+
this._css.esriPrintBarClass+'"\x3e';b+='\x3cdiv class\x3d"'+this._css.esriCloseButtonClass+'" title\x3d"'+m.common.close+'" onclick\x3d"window.close();"\x3e'+m.common.close+"\x3c/div\x3e";b+='\x3cdiv id\x3d"printButton" class\x3d"'+this._css.esriPrintButtonClass+'" title\x3d"'+m.widgets.directions.print+'" onclick\x3d"window.print();"\x3e'+m.widgets.directions.print+"\x3c/div\x3e";b+="\x3c/div\x3e";b+='\x3cdiv class\x3d"'+this._css.esriPrintMainClass+'"\x3e';b+='\x3cdiv class\x3d"'+this._css.esriPrintHeaderClass+
'"\x3e';b+='\x3cimg class\x3d"'+this._css.esriPrintLogoClass+'" src\x3d"'+f+'" /\x3e';b+='\x3cdiv class\x3d"'+this._css.esriPrintNameClass+'"\x3e'+this.get("directions").routeName+"\x3c/div\x3e";b+=this._renderDirectionsSummary(this.directions);a&&(b+='\x3cdiv id\x3d"divMap" class\x3d"esriPrintMap esriPrintWait"\x3e\x3c/div\x3e',b+='\x3chr class\x3d"esriNoPrint"/\x3e');b+='\x3cdiv id\x3d"print_helper"\x3e\x3c/div\x3e';b+='\x3ctextarea onkeyup\x3d"document.getElementById(\'print_helper\').innerHTML\x3dthis.value;" id\x3d"print_area" class\x3d"'+
this._css.esriPrintNotesClass+'" placeholder\x3d"'+m.widgets.directions.printNotes+'"\x3e\x3c/textarea\x3e';b+='\x3cdiv class\x3d"'+this._css.clearClass+'"\x3e\x3c/div\x3e';b+="\x3c/div\x3e";b+='\x3cdiv class\x3d"'+this._css.esriPrintDirectionsClass+'"\x3e';b+=this._renderDirectionsTable(this.directions);b+="\x3c/div\x3e";b+='\x3cdiv class\x3d"'+this._css.esriPrintFooterClass+'"\x3e';b+="\x3cp\x3e"+m.widgets.directions.printDisclaimer+"\x3c/p\x3e";b+="\x3c/div\x3e";b+="\x3c/div\x3e";b+="\x3c/body\x3e";
b+="\x3c/html\x3e"}this._printWindow.document.open("text/html","replace");this._printWindow.document.write(b);this._printWindow.document.close()}))},_printDirections:function(){if(this.directions){var a=screen.width/2,b=screen.height/1.5,a="toolbar\x3dno, location\x3dno, directories\x3dno, status\x3dyes, menubar\x3dno, scrollbars\x3dyes, resizable\x3dyes, width\x3d"+a+", height\x3d"+b+", top\x3d"+(screen.height/2-b/2)+", left\x3d"+(screen.width/2-a/2);this.get("printPage")?(window.directions=this.get("directions"),
window.open(this.get("printPage"),"directions_widget_print",a,!0)):(this._printWindow=window.open("","directions_widget_print",a,!0),this._loadPrintDirections(!!this._printService),this._printService&&E(["dojo/_base/window"],f.hitch(this,function(a){this.zoomToFullRoute().then(f.hitch(this,function(){this._printService.execute(this._printParams,f.hitch(this,function(b){a.withDoc(this._printWindow.document,function(){var a=ea.byId("divMap");a&&(q.remove(a,"esriPrintWait"),q.add(a,"esriPageBreak"),
v.create("img",{src:b.url,"class":"esriPrintMapImg"},a))})}),f.hitch(this,function(b){a.withDoc(this._printWindow.document,function(){var a=ea.byId("divMap");a&&q.remove(a,"esriPrintWait")});console.error("Error while calling print service:\n "+b)}))}))})))}},_enableButton:function(a,b){var c=b||void 0===b;q[c?"remove":"add"].apply(this,[a,"esriDisabledDirectionsButton"]);a._enabled=c},_enableSharing:function(){var a=new r;!this._naRouteSharing&&this.owningSystemUrl?E(["../tasks/NARouteSharing"],
f.hitch(this,function(b){this._naRouteSharing=new b(this.owningSystemUrl,this.map.spatialReference);this._folderSelector||(this._folderSelector=new Z({className:"esriFoldersDDL",style:"width: 100%;",sortByLabel:!1,disabled:!0,_interractive:!0,onChange:f.hitch(this,function(){this._folderSelector._interractive?this._enableButton(this._saveButton,!this.routeLayer.itemId):this._folderSelector._interractive=!0})},this._folderSelectorContainer),this._folderSelector.startup(),this._outputLayer=new ja({style:"width: 100%",
required:!0,trim:!0,regExp:'[^:|\x26|\x3c|\x3e|%|#|?|\\|"|/|+]+',maxLength:98,disabled:!0,onKeyPress:f.hitch(this,function(){this._enableButton(this._saveButton,!this.routeLayer.itemId||!this._userCanCreatePortalItem)})},this._outputLayerContainer),this._outputLayer.startup());this._naRouteSharing.getFolders().then(f.hitch(this,function(b){for(var d=[],e=0;e<b.length;e++)d.push({id:b[e].url,folderId:b[e].id,label:b[e].title});this._folderSelector.setStore(new aa({objectStore:new $({data:d})}));this._naRouteSharing.canCreateItem().then(f.hitch(this,
function(a){this._folderSelector.set("disabled",!a);this._userCanCreatePortalItem=a}));this._enableButton(this._saveButton);a.resolve()}),f.hitch(this,function(b){this._naRouteSharing=null;this._toggleSaveMenu(!1);a.reject(b)}))})):this.owningSystemUrl?a.resolve():(a.reject(Error("Owning system is not defined, or the Directions widget is not done initializing.")),this._naRouteSharing=null);return a.promise},_storeRouteUI:function(){var a=new r;!this._outputLayer||!this._outputLayer.isValid()?(this._outputLayer&&
this._outputLayer.focus(),a.reject(Error("Need result layer name specified."))):this._storeRoute(this._outputLayer.getValue(),this._folderSelector.getValue(),this._folderSelector.store.objectStore.get(this._folderSelector.getValue()).folderId).then(a.resolve,a.reject);return a.promise},_storeRoute:function(a,b,c){var d=new r,e=this.directions;if(this._savingRoute||!this._naRouteSharing)return this._saveButton.blur(),d.reject(Error("Not ready to store route.")),d.promise;this.clearMessages();d.then(null,
f.hitch(this,function(a){this._showMessage(m.widgets.directions.error.cantSaveRoute)}));d.promise.always(f.hitch(this,function(){this._enableButton(this._saveButton);u.set(this._saveAsButton,"display",this.routeLayer.itemId&&this._userCanCreatePortalItem?"inline-block":"none");this._showLoadingSpinner();this._savingRoute=!1}));if(!e||!e.features||!e.features.length||!this.stops||!this.stops.length)d.reject(Error("No route to share. Build a route first."));else if(this.owningSystemUrl)if(!this.routeParams||
!this.routeParams.travelMode)d.reject(Error("Shared route must be built using a Travel Mode."));else if(!a||!b)d.reject(Error("Missing required parameter: layerName, folder must be specified."));else{var g,h;g=f.hitch(this,function(a){return this._naRouteSharing.getAttributeUnits(a,this.serviceDescription)});var n=this.routeParams.travelMode.timeAttributeName,k=this.routeParams.travelMode.distanceAttributeName,l=g(n),p=g(k),q=this.routeParams.directionsLengthUnits||this.serviceDescription.directionsLengthUnits,
H=this._naRouteSharing.toMeters,t=this._naRouteSharing.toMinutes,v=function(a,b,c){var d,e;for(e in a)a.hasOwnProperty(e)&&(0===e.indexOf(b)&&-1===x.indexOf(c,e.substr(b.length)))&&(d=d||{},d[e.substr(b.length)]=a[e]);return d},G=[],B=[],z=[],C;if(!n||!l||!k||!p)d.reject(Error("Cannot deduce the impedance used."));else{var w=[];C=this.routeParams.accumulateAttributes||this.serviceDescription.accumulateAttributeNames||[];h=this.serviceDescription.networkDataset.networkAttributes;for(g=0;g<h.length;g++)"esriNAUTCost"===
h[g].usageType&&(-1===x.indexOf(C,h[g].name)&&h[g].name!==n&&h[g].name!==k)&&w.push(h[g].name);C=this.get("stops");var D={xmin:Infinity,ymin:Infinity,xmax:-Infinity,ymax:-Infinity};for(g=0;g<C.length;g++)if(C[g].feature&&C[g].feature.toJson){h=C[g].feature.toJson();var s=h.attributes,y=h.geometry,E=this._naRouteSharing.getUTCOffset(s.ArriveTime,s.ArriveTimeUTC),F=this._naRouteSharing.getUTCOffset(s.DepartTime,s.DepartTimeUTC);f.mixin(D,{xmin:D.xmin>y.x?y.x:D.xmin,ymin:D.ymin>y.y?y.y:D.ymin,xmax:D.xmax<
y.x?y.x:D.xmax,ymax:D.ymax<y.y?y.y:D.ymax});h.attributes={CurbApproach:s.CurbApproach,ArrivalCurbApproach:s.ArriveCurbApproach,DepartureCurbApproach:s.DepartCurbApproach,Name:s.Name===this._waypointName?m.widgets.directions.waypoint:s.Name===this._userDefinedStopName?C[g].name:s.Name,Sequence:s.Sequence,Status:s.Status,LocationType:s.isWaypoint?1:0,TimeWindowStart:s.TimeWindowStart,TimeWindowEnd:s.TimeWindowEnd,ServiceMinutes:t(s["Attr_"+n],l),ServiceMeters:H(s["Attr_"+k],p),ServiceCosts:M.stringify(v(s,
"Attr_",w)),CumulativeMinutes:t(s["Cumul_"+n],l),CumulativeMeters:H(s["Cumul_"+k],p),CumulativeCosts:M.stringify(v(s,"Cumul_",w)),LateMinutes:t(s["Violation_"+n],l),WaitMinutes:t(s["Wait_"+n],l),ArrivalTime:this._naRouteSharing.toUTCTime(s.ArriveTime,E),DepartureTime:this._naRouteSharing.toUTCTime(s.DepartTime,F),ArrivalUTCOffset:E,DepartureUTCOffset:F};G.push(h)}n=0;k=function(a){var b;try{a.strings=M.parse(a.strings)}catch(c){I.strings=void 0}if(a.strings&&a.strings.length){for(var d=0;d<a.strings.length;d++)if("esriDSTGeneral"===
a.strings[d].stringType){b=a.strings[d].string;a.strings.splice(d,1);break}a.strings=M.stringify(a.strings)}return b};for(g=0;g<e.featuresWithWaypoints.length;g++){h=e.featuresWithWaypoints[g];p=h.toJson();y=p.attributes;s=p.geometry&&p.geometry.paths&&p.geometry.paths[0]||[];C=this._naRouteSharing.getUTCOffset(y.ETA,y.arriveTimeUTC);p.attributes={Sequence:g+1,StopSequence:h._associatedStopWithReturnToStart&&h._associatedStopWithReturnToStart.attributes.Sequence,ArrivalTime:this._naRouteSharing.toUTCTime(y.ETA,
C),UTCOffset:C,ManeuverType:y.maneuverType,Meters:H(y.length,q),Minutes:t(y.time,l),DirectionText:h._associatedStopWithReturnToStart&&h._associatedStopWithReturnToStart.attributes.isWaypoint?y.text.replace(this._waypointName,m.widgets.directions.waypoint):y.text,ManeuverMessages:M.stringify(e.stringsWithWaypoints[g])};delete p.symbol;delete p.infoTemplate;C=!0;for(h=0;h<s.length-1;h++)if(s[h][0]!==s[h+1][0]||s[h][1]!==s[h+1][1]){C=!1;break}C&&delete p.geometry;B.push(p);var I=e.eventsWithWaypoints[p.attributes.Sequence]||
[];for(h=0;h<I.length;h++)s=I[h].toJson(),y=s.attributes,C=this._naRouteSharing.getUTCOffset(y.ETA,y.arriveTimeUTC),s.attributes={DirectionSequence:p.attributes.Sequence,Sequence:++n,ArrivalTime:this._naRouteSharing.toUTCTime(y.ETA,C),UTCOffset:C,EventText:k(y),EventMessages:y.strings},z.push(s)}var n=this.routeParams.barriers&&this.routeParams.barriers.features||[],J=[];for(g=0;g<n.length;g++)k=n[g].toJson(),p=k.attributes,k.attributes={BarrierType:p.BarrierType||0,FullEdge:p.FullEdge||!1,AddedCost:p["Attr_"+
this._getImpedanceAttribute().name]||0,Costs:M.stringify(v(p,"Attr_",w)),CurbApproach:p.CurbApproach||0,Name:p.Name},J.push(k);var n=this.routeParams.polylineBarriers&&this.routeParams.polylineBarriers.features||[],K=[];for(g=0;g<n.length;g++)k=n[g].toJson(),p=k.attributes,k.attributes={BarrierType:p.BarrierType||0,ScaleFactor:p["Attr_"+this._getImpedanceAttribute().name]||1,Costs:M.stringify(v(p,"Attr_",w)),Name:p.Name},K.push(k);var n=this.routeParams.polygonBarriers&&this.routeParams.polygonBarriers.features||
[],L=[];for(g=0;g<n.length;g++)k=n[g].toJson(),p=k.attributes,k.attributes={BarrierType:p.BarrierType||0,ScaleFactor:p["Attr_"+this._getImpedanceAttribute().name]||1,Costs:M.stringify(v(p,"Attr_",w)),Name:p.Name},L.push(k);var N={geometry:e.mergedGeometry,attributes:{RouteName:e.routeName,TotalMinutes:t(e.totalTime,l),TotalMeters:H(e.totalLength,q),TotalLateMinutes:function(){for(var a=0,b=0;b<G.length;b++)a+=G[b].attributes.LateMinutes||0;return a}(),TotalWaitMinutes:function(){for(var a=0,b=0;b<
G.length;b++)a+=G[b].attributes.WaitMinutes||0;return a}(),TotalCosts:G[G.length-1].attributes.CumulativeCosts,StartTime:G[0].attributes.ArrivalTime,EndTime:G[G.length-1].attributes.DepartureTime,StartUTCOffset:G[0].attributes.ArrivalUTCOffset,EndUTCOffset:G[G.length-1].attributes.DepartureUTCOffset,Messages:M.stringify(this._solverMessages),AnalysisSettings:M.stringify({travelMode:f.hitch(this,function(){var a=f.clone(this.routeParams.travelMode);"\x26lt;"===a.name.substr(0,4)&&"\x26gt;"===a.name.substr(a.name.length-
4,4)&&(a.name=a.name.substr(4,a.name.length-8));return a})(),directionsLanguage:this.routeParams.directionsLanguage||this.serviceDescription.directionsLanguage,startTimeIsUTC:this.routeParams.startTimeIsUTC,timeWindowsAreUTC:this.routeParams.timeWindowsAreUTC,findBestSequence:this.routeParams.findBestSequence,preserveFirstStop:this.routeParams.preserveFirstStop,preserveLastStop:this.routeParams.preserveLastStop,accumulateAttributeNames:this.routeParams.accumulateAttributes||this.serviceDescription.accumulateAttributeNames})}};
this._enableButton(this._saveButton,!1);this._savingRoute=!0;this._showLoadingSpinner(!0);f.hitch(this,function(){var a=new r;this._printService?this.zoomToFullRoute().then(f.hitch(this,function(){var b=this._printParams.template,c=b.exportOptions;b.exportOptions={width:200,height:133,dpi:96};this._printService.execute(this._printParams,function(d){b.exportOptions=c;a.resolve(d.url)},function(d){b.exportOptions=c;console.error("Error while calling print service:\n "+d);a.resolve()})})):a.resolve();
return a.promise})().then(f.hitch(this,function(g){var h={folder:b,name:a,stops:G,directions:B,directionEvents:z,barriers:J,polylineBarriers:K,polygonBarriers:L,extent:f.mixin(f.clone(e.extent),{xmin:D.xmin>e.extent.xmin?e.extent.xmin:D.xmin,ymin:D.ymin>e.extent.ymin?e.extent.ymin:D.ymin,xmax:D.xmax<e.extent.xmax?e.extent.xmax:D.xmax,ymax:D.ymax<e.extent.ymax?e.extent.ymax:D.ymax}),routeInfo:N,thumbnail:g};this._userCanCreatePortalItem?this._naRouteSharing.store(h,this.routeLayer.itemId).then(f.hitch(this,
function(a){if(a.success){var b=this._naRouteSharing.portal,b="//"+(b.isPortal?b.portalHostname:b.urlKey+"."+b.customBaseUrl);this._toggleSaveMenu();this._showMessage(m.widgets.directions.routeIsSaved+"\x3cbr/\x3e\x3ca class\x3d'esriLinkButton' target\x3d'_blank' href\x3d'"+b+"/home/item.html?id\x3d"+a.id+"'\x3e"+m.widgets.directions.share+"\x3c/a\x3e",!0);if(this.routeLayer.itemId)this.onRouteItemUpdated(a.id);else this.onRouteItemCreated(a.id);f.mixin(this.routeLayer,{itemId:a.id,title:h.name,isItemOwner:!0,
ownerFolder:c});d.resolve(a)}else d.reject(a)}),d.reject):this._naRouteSharing.createFeatureCollection(h).then(f.hitch(this,function(a){d.resolve(a);this._toggleSaveMenu();this.onFeatureCollectionCreated(a)}),d.reject)}))}}else d.reject(Error("Cannot store route: owning system to store routes is not defined. Please specify Portal or ArcGIS Online Url in constructor."));return d.promise},_loadRoute:function(a){var b=new r;b.promise.always(f.hitch(this,function(){this._showLoadingSpinner(!1);u.set(this._saveAsButton,
"display",this.routeLayer.itemId&&this._userCanCreatePortalItem?"inline-block":"none");this._enableButton(this._saveButton,this.routeLayer.isItemOwner)}));this._reset().then(f.hitch(this,function(){this._showLoadingSpinner(!0);this._enableSharing().then(f.hitch(this,function(){var c=f.clone(this.serviceDescription),d=f.hitch(this,function(b){f.mixin(this.routeLayer,{itemId:a,title:b.title,isItemOwner:b.isItemOwner,ownerFolder:b.ownerFolder})}),e,g,h,n;c.directionsLengthUnits=this.directionsLengthUnits;
this._naRouteSharing.load(a,c).then(f.hitch(this,function(a){if(a.routeParameters){f.mixin(this.routeParams,a.routeParameters);this.routeParams.accumulateAttributes=a.routeParameters.accumulateAttributeNames;this.set("optimalRoute",this.routeParams.findBestSequence);this.startTime=this.routeParams.startTime?this.routeParams.startTime:"now";this._setStartTime(void 0,void 0,this.startTime);var l=a.routeParameters.travelMode,p=l?this._getCostAttribute(l.impedanceAttributeName):void 0,p=p?this._isTimeUnits(p.units)?
"Time":"Distance":"";n=c.supportedTravelModes&&c.supportedTravelModes.length?this._travelModeSelector.store.objectStore.data.slice():[];if(p){var q="AUTOMOBILE"===l.type?"Driving":"TRUCK"===l.type?"Trucking":"WALK"===l.type?"Walking":"Other";l.name="\x26lt;"+l.name+"\x26gt;";this.serviceDescription.supportedTravelModes=(c.supportedTravelModes||[]).concat(l);n.push({id:l.name,label:'\x3cdiv class\x3d"esriTravelModesDirectionsIcon esriTravelModesType'+q+p+'"\x3e\x26nbsp;\x3c/div\x3e\x3cdiv class\x3d"esriTravelModesTypeName"\x3e'+
l.name+"\x3c/div\x3e"});this._travelModeSelector.setStore(new aa({objectStore:new $({data:n})}));this._travelModeSelector._interractive=!1;this._travelModeSelector.setValue(l.name)}else if(console.warn("Cost attribute with such name was not found in the remote service, defaulting to the service travel mode."),l=c.defaultTravelMode,n=c.supportedTravelModes,l&&n)for(e=0;e<n.length;e++){if(n[e].id===l){this.routeParams.travelMode=n[e].impedanceAttributeName?n[e]:n[e].itemId;break}}else this.routeParams.travelMode=
null;this._checkStartTimeUIAvailability()}if(a.solveResult&&a.solveResult.routeResults){var r,u=Infinity,v,x=-Infinity,l=a.solveResult.routeResults[0].stops,w=a.solveResult.routeResults[0].directions.features,p={};for(e=0;e<l.length;e++){var z=l[e].attributes;if(z.isWaypoint)for(g=0;g<w.length;g++)q=w[g].attributes,q._stopSequence===z.Sequence&&(q.text=q.text.replace(z.Name,this._waypointName));h=z.Name+"_"+this._stopSequence++;p[h]=z.isWaypoint?this._waypointName:z.Name;z.Name=h;if(z.Sequence<u&&
(null!==z.ArriveCurbApproach||null!==z.DepartCurbApproach))r=z.Name,u=z.Sequence;if(z.Sequence>x&&(null!==z.ArriveCurbApproach||null!==z.DepartCurbApproach))v=z.Name,x=z.Sequence}h=r+" - "+v;a.solveResult.routeResults[0].routeName=h;a.solveResult.routeResults[0].directions.routeName=h;for(e=0;e<w.length;e++)if(q=w[e].attributes,void 0!==q._stopSequence)for(g=0;g<l.length;g++)if(q._stopSequence===l[g].attributes.Sequence){h=l[g].attributes.Name;q.text=(q.text||"").replace(p[h],h);delete q._stopSequence;
break}r=l[l.length-1];l[0].geometry.x===r.geometry.x&&l[0].geometry.y===r.geometry.y&&(this._returnToStartStop=this._addStopWrapperToGraphic(new t(r.geometry,null,r.attributes),p[r.attributes.Name]),this.set("returnToStart",!0));this._solveResultProcessing(a.solveResult,p).then(f.hitch(this,function(){d(a);this.zoomToFullRoute();b.resolve(a)}),b.reject)}else{if(a.routeParameters){r=a.routeParameters.stops.features;this.stops=[];for(e=0;e<r.length;e++)this.stops.push(this._addStopWrapperToGraphic(r[e],
r[e].attributes.Name)),this._updateStop(this.stops[e],e);this._setStops();a.loadMessages.push({message:m.widgets.directions.routeLayerStopsOnly,messageType:"Warning"})}else a.loadMessages.push({message:m.widgets.directions.routeLayerEmpty,messageType:"Warning"});d(a);b.resolve(a)}for(e=0;e<a.loadMessages.length;e++)this._showMessage(a.loadMessages[e].message)}),f.hitch(this,function(a){b.reject(a);this._showMessage("GWM_0003"===a.messageCode?m.widgets.directions.error.accessDenied+this._naRouteSharing.portal.getPortalUser().username:
m.widgets.directions.error.loadError)}))}),b.reject)}),b.reject);return b.promise}});ma("extend-esri")&&f.setObject("dijit.Directions",U,qa);return U});